generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model AnalyticsEvent {
  id         String   @id
  event      String
  category   String
  userId     String?
  orgId      String?
  clientId   String?
  jobId      String?
  claimId    String?
  properties Json?    @default("{}")
  sessionId  String?
  userAgent  String?
  ipAddress  String?
  createdAt  DateTime @default(now()) @db.Timestamptz(6)

  @@index([category])
  @@index([createdAt(sort: Desc)])
  @@index([event])
  @@index([orgId])
  @@index([userId])
}

model BATFReport {
  id              String    @id
  leadId          String
  orgId           String
  claimId         String?
  roofType        String
  beforePhotos    Json
  afterPhotos     Json?
  aiBeforeUrl     String?
  aiAfterUrl      String?
  damageOverlay   String?
  severityMap     String?
  findings        Json?
  presentationPdf String?
  publicId        String?   @unique
  publicExpiresAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime

  @@index([claimId])
  @@index([createdAt(sort: Desc)])
  @@index([leadId])
  @@index([orgId])
  @@index([publicId])
}

model BillingSettings {
  id              String   @id
  orgId           String   @unique
  autoRefill      Boolean  @default(false)
  refillThreshold Int      @default(10)
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  Org             Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
}

model BrainFeedback {
  id                String   @id
  claimId           String
  userId            String
  orgId             String
  recommendation    String
  action            String
  reason            String?
  alternativeChosen String?
  confidence        Int
  metadata          Json?
  createdAt         DateTime @default(now())

  @@index([claimId])
  @@index([createdAt(sort: Desc)])
  @@index([orgId, action])
  @@index([recommendation])
}

model BuildProgress {
  id                      String              @id
  createdAt               DateTime            @default(now())
  updatedAt               DateTime
  orgId                   String
  claimId                 String              @unique
  projectStartDate        DateTime?
  projectEndDate          DateTime?
  tearOffStarted          Boolean             @default(false)
  tearOffStartedAt        DateTime?
  tearOffCompleted        Boolean             @default(false)
  tearOffCompletedAt      DateTime?
  deckingStarted          Boolean             @default(false)
  deckingStartedAt        DateTime?
  deckingCompleted        Boolean             @default(false)
  deckingCompletedAt      DateTime?
  underlaymentStarted     Boolean             @default(false)
  underlaymentStartedAt   DateTime?
  underlaymentCompleted   Boolean             @default(false)
  underlaymentCompletedAt DateTime?
  shingleStarted          Boolean             @default(false)
  shingleStartedAt        DateTime?
  shingleCompleted        Boolean             @default(false)
  shingleCompletedAt      DateTime?
  flashingStarted         Boolean             @default(false)
  flashingStartedAt       DateTime?
  flashingCompleted       Boolean             @default(false)
  flashingCompletedAt     DateTime?
  ridgeStarted            Boolean             @default(false)
  ridgeStartedAt          DateTime?
  ridgeCompleted          Boolean             @default(false)
  ridgeCompletedAt        DateTime?
  cleanupStarted          Boolean             @default(false)
  cleanupStartedAt        DateTime?
  cleanupCompleted        Boolean             @default(false)
  cleanupCompletedAt      DateTime?
  photoCount              Int                 @default(0)
  overallStatus           String              @default("not_started")
  completionPercent       Int                 @default(0)
  metadata                Json?
  claims                  claims              @relation(fields: [claimId], references: [id], onDelete: Cascade)
  Org                     Org                 @relation(fields: [orgId], references: [id], onDelete: Cascade)
  BuildQualityCheck       BuildQualityCheck[]
  TearOffDiscovery        TearOffDiscovery[]

  @@index([orgId, overallStatus])
}

model BuildQualityCheck {
  id              String        @id
  createdAt       DateTime      @default(now())
  progressId      String
  checkType       String
  phase           String
  status          String
  confidence      Decimal       @db.Decimal(5, 2)
  issueDetected   String?
  recommendation  String?
  photoUrl        String?
  photoAnalysis   String?
  resolved        Boolean       @default(false)
  resolvedAt      DateTime?
  resolvedBy      String?
  resolutionNotes String?
  metadata        Json?
  BuildProgress   BuildProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@index([progressId, phase])
  @@index([status, resolved])
}

model CarrierProfile {
  id             String   @id
  orgId          String
  leadId         String?
  carrierName    String
  detectedFrom   String
  confidence     Float?
  guidelinesJson Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime

  @@index([carrierName])
  @@index([createdAt(sort: Desc)])
  @@index([leadId])
  @@index([orgId])
}

model ClaimBrainState {
  id                String   @id
  claimId           String   @unique
  orgId             String
  currentState      String   @default("NEW")
  previousState     String?
  confidence        Int      @default(0)
  lastEventType     String?
  lastEventAt       DateTime @default(now())
  mergedTimeline    Json?
  stateTransitions  Json?
  autoCorrections   Json?
  brainLogs         Json?
  needsAttention    Boolean  @default(false)
  attentionReason   String?
  nextPredictedMove String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime

  @@index([claimId])
  @@index([currentState])
  @@index([lastEventAt(sort: Desc)])
  @@index([needsAttention])
  @@index([orgId])
  @@index([updatedAt(sort: Desc)])
}

model ClaimClientLink {
  id                String    @id
  claimId           String
  clientEmail       String
  clientName        String?
  clientUserId      String?
  status            String    @default("PENDING")
  sharedDocumentIds String[]  @default([])
  invitedBy         String
  invitedAt         DateTime  @default(now())
  acceptedAt        DateTime?
  claims            claims    @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@unique([claimId, clientEmail])
  @@index([claimId])
  @@index([clientEmail])
  @@index([clientUserId])
  @@index([status])
}

model ClaimDecisionPlan {
  id                   String   @id
  claimId              String
  orgId                String
  strategy             String
  confidence           Int
  riskLevel            String
  summary              String
  reasoning            String?
  recommendedSteps     Json
  carrierTalkingPoints Json?
  autoTasksCreated     Boolean  @default(false)
  taskIds              Json?
  expectedOutcome      String?
  estimatedTimeframe   String?
  keyRisks             Json?
  successProbability   Int?
  alternativeStrategy  String?
  carrierProfile       Json?
  policyAnalysis       Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime

  @@index([claimId])
  @@index([confidence])
  @@index([createdAt(sort: Desc)])
  @@index([orgId])
  @@index([riskLevel])
  @@index([strategy])
}

model ClaimDisputePackage {
  id               String    @id
  claimId          String
  orgId            String
  audience         String
  packageType      String
  subjectLine      String
  bodyMarkdown     String
  bodyHtml         String?
  timelineSnapshot Json
  attachmentRefs   Json?
  legalReferences  Json?
  damageEvidence   Json?
  carrierErrors    Json?
  tone             String    @default("professional")
  urgency          String    @default("standard")
  deliveryMethod   String?
  sentAt           DateTime?
  sentBy           String?
  responseReceived Boolean   @default(false)
  responseAt       DateTime?
  responseNotes    String?
  outcomeStatus    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime

  @@index([audience])
  @@index([claimId])
  @@index([createdAt(sort: Desc)])
  @@index([orgId])
  @@index([outcomeStatus])
  @@index([packageType])
  @@index([sentAt])
}

model ClaimEventReconstruction {
  id            String   @id
  claimId       String   @unique
  orgId         String
  realTimeline  Json?
  idealTimeline Json?
  missingEvents Json?
  discrepancies Json?
  aiSummary     String?
  scoreQuality  Int?
  updatedFrom   String?
  lastRebuilt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime

  @@index([claimId])
  @@index([orgId])
  @@index([scoreQuality])
  @@index([updatedAt(sort: Desc)])
}

model ClaimMaterial {
  id            String        @id
  claimId       String
  productId     String
  vendorId      String?
  quantity      Int           @default(1)
  unitPrice     Decimal?
  spec          String?
  warranty      String?
  color         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  claims        claims        @relation(fields: [claimId], references: [id], onDelete: Cascade)
  VendorProduct VendorProduct @relation(fields: [productId], references: [id])
}

model ClaimMessage {
  id        String   @id
  claimId   String
  userId    String
  body      String
  createdAt DateTime @default(now())
  claims    claims   @relation(fields: [claimId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id])
}

model ClaimPrediction {
  id               String   @id
  claimId          String   @unique
  leadId           String?
  orgId            String
  stage            String?
  probabilityFull  Int?
  probabilityPart  Int?
  probabilityDeny  Int?
  confidenceScore  Int
  recommendedSteps Json?
  riskFlags        Json?
  nextMove         String?
  aiSummary        String?
  carrierBehavior  Json?
  successPath      Json?
  inputSources     Json?
  updatedFrom      String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime

  @@index([claimId])
  @@index([confidenceScore])
  @@index([leadId])
  @@index([orgId])
  @@index([probabilityDeny])
  @@index([stage])
  @@index([updatedAt(sort: Desc)])
}

model ClaimWriter {
  id           String   @id
  orgId        String
  leadId       String
  claimId      String?
  scopeJson    Json?
  narrative    String?
  estimateJson Json?
  carrierNotes String?
  summary      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime

  @@index([claimId])
  @@index([createdAt(sort: Desc)])
  @@index([leadId])
  @@index([orgId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Client {
  id                  String                @id
  userId              String?               @unique
  orgId               String?
  slug                String                @unique
  name                String?
  email               String?
  phone               String?
  firstName           String?
  lastName            String?
  companyName         String?
  category            String                @default("Homeowner")
  avatarUrl           String?
  propertyPhotoUrl    String?
  address             String?
  city                String?
  state               String?
  postal              String?
  preferredContact    String?               @default("email")
  notifyEmail         Boolean               @default(true)
  notifySms           Boolean               @default(false)
  status              String                @default("active")
  lastActiveAt        DateTime?             @db.Timestamptz(6)
  createdAt           DateTime              @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime              @default(now()) @db.Timestamptz(6)
  bio                 String?
  isPublic            Boolean?              @default(false)
  coverPhotoUrl       String?
  customStatus        String?
  statusEmoji         String?
  Org                 Org?                  @relation(fields: [orgId], references: [id])
  ClientJob           ClientJob[]
  ClientJobDocument   ClientJobDocument[]
  ClientProConnection ClientProConnection[]
  ClientPropertyPhoto ClientPropertyPhoto[]
  ClientSavedPro      ClientSavedPro[]
  ClientWorkRequest   ClientWorkRequest[]
  trade_reviews       trade_reviews[]

  @@index([category])
  @@index([email])
  @@index([orgId])
  @@index([status])
}

model ClientPropertyPhoto {
  id        String   @id @default(uuid())
  clientId  String
  folder    String   @default("property") // "property", "damage", "before", "after", "documents"
  url       String
  caption   String?
  mimeType  String?
  sizeBytes Int?
  sortOrder Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  Client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([clientId, folder])
}

model ClientConnection {
  id          String    @id
  orgId       String
  clientId    String
  status      String    @default("pending")
  invitedBy   String
  invitedAt   DateTime  @default(now())
  connectedAt DateTime?

  @@unique([orgId, clientId], map: "app_ClientConnection_orgId_clientId_key")
  @@index([clientId], map: "app_ClientConnection_clientId_idx")
  @@index([orgId], map: "app_ClientConnection_orgId_idx")
  @@index([status], map: "app_ClientConnection_status_idx")
}

model ClientJob {
  id                  String               @id
  clientId            String
  proCompanyId        String?              @db.Uuid
  proMemberId         String?              @db.Uuid
  type                String               @default("JOB")
  title               String
  description         String?
  tradeType           String?
  urgency             String?              @default("normal")
  status              String               @default("new")
  progress            Int                  @default(0)
  stage               String               @default("intake")
  propertyAddress     String?
  propertyCity        String?
  propertyState       String?
  propertyZip         String?
  propertyType        String?
  estimatedBudget     Decimal?             @db.Decimal(12, 2)
  actualCost          Decimal?             @db.Decimal(12, 2)
  paidAmount          Decimal?             @default(0) @db.Decimal(12, 2)
  claimNumber         String?
  insuranceCompany    String?
  adjusterName        String?
  adjusterPhone       String?
  adjusterEmail       String?
  claimApprovedAmount Decimal?             @db.Decimal(12, 2)
  scheduledDate       DateTime?            @db.Timestamptz(6)
  completedDate       DateTime?            @db.Timestamptz(6)
  metadata            Json?                @default("{}")
  createdAt           DateTime             @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime             @default(now()) @db.Timestamptz(6)
  Client              Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tradesCompany       tradesCompany?       @relation(fields: [proCompanyId], references: [id])
  tradesCompanyMember tradesCompanyMember? @relation(fields: [proMemberId], references: [id])
  SignatureEnvelope   SignatureEnvelope[]
  StatusTransition    StatusTransition[]

  @@index([clientId])
  @@index([createdAt(sort: Desc)])
  @@index([proCompanyId])
  @@index([stage])
  @@index([status])
  @@index([type])
}

model ClientJobDocument {
  id                String            @id
  jobId             String
  clientId          String
  type              String
  title             String
  url               String
  mimeType          String?
  sizeBytes         Int?
  uploadedBy        String?
  createdAt         DateTime          @default(now()) @db.Timestamptz(6)
  Client            Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  ClientWorkRequest ClientWorkRequest @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([jobId])
  @@index([type])
}

model ClientJobResponse {
  id                  String              @id
  jobRequestId        String
  contractorId        String              @db.Uuid
  companyName         String
  message             String
  estimatedPrice      String?
  estimatedPriceMin   Decimal?            @db.Decimal(12, 2)
  estimatedPriceMax   Decimal?            @db.Decimal(12, 2)
  estimatedTimeline   String?
  availableDate       DateTime?           @db.Date
  attachments         String[]            @default([])
  status              String              @default("pending")
  viewedAt            DateTime?           @db.Timestamptz(6)
  createdAt           DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime            @default(now()) @db.Timestamptz(6)
  tradesCompanyMember tradesCompanyMember @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  ClientWorkRequest   ClientWorkRequest   @relation(fields: [jobRequestId], references: [id], onDelete: Cascade)

  @@unique([jobRequestId, contractorId])
  @@index([contractorId])
  @@index([jobRequestId])
  @@index([status])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model ClientProConnection {
  id            String        @id
  clientId      String
  contractorId  String        @db.Uuid
  status        String        @default("pending")
  invitedBy     String?
  notes         String?
  invitedAt     DateTime      @default(now()) @db.Timestamptz(6)
  connectedAt   DateTime?     @db.Timestamptz(6)
  Client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tradesCompany tradesCompany @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@unique([clientId, contractorId])
  @@index([clientId])
  @@index([contractorId])
  @@index([status])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model ClientSavedPro {
  id            String        @id
  clientId      String
  companyId     String        @db.Uuid
  category      String?
  notes         String?
  savedAt       DateTime      @default(now()) @db.Timestamptz(6)
  Client        Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tradesCompany tradesCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([clientId, companyId])
  @@index([category])
  @@index([clientId])
  @@index([companyId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model ClientWorkRequest {
  id                String              @id
  clientId          String
  targetProId       String?             @db.Uuid
  title             String
  description       String
  category          String
  urgency           String              @default("normal")
  preferredDate     DateTime?           @db.Timestamptz(6)
  propertyAddress   String?
  propertyPhotos    String[]            @default([])
  status            String              @default("pending")
  createdAt         DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime            @default(now()) @db.Timestamptz(6)
  budget            String?
  budgetMax         Decimal?            @db.Decimal(12, 2)
  budgetMin         Decimal?            @db.Decimal(12, 2)
  city              String?
  coverPhoto        String?
  expiresAt         DateTime?           @db.Timestamptz(6)
  lookingFor        String[]            @default([])
  preferredTypes    String[]            @default([])
  requirements      String[]            @default([])
  responseCount     Int                 @default(0)
  serviceArea       String?
  state             String?
  summary           String?
  timeline          String?
  viewCount         Int                 @default(0)
  visibility        String              @default("public")
  zip               String?
  ClientJobDocument ClientJobDocument[]
  ClientJobResponse ClientJobResponse[]
  Client            Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tradesCompany     tradesCompany?      @relation(fields: [targetProId], references: [id])

  @@index([category])
  @@index([city, state])
  @@index([clientId])
  @@index([status])
  @@index([targetProId])
  @@index([visibility])
}

model CommandLog {
  id         String   @id
  userId     String
  orgId      String
  inputType  String
  intent     String
  payload    Json
  confidence Float?
  rawInput   String?
  timestamp  DateTime @default(now())

  @@index([intent])
  @@index([orgId, inputType])
  @@index([timestamp(sort: Desc)])
  @@index([userId, timestamp(sort: Desc)])
}

model CompletionPacket {
  id                    String    @id
  createdAt             DateTime  @default(now())
  updatedAt             DateTime
  orgId                 String
  claimId               String    @unique
  completionStatement   String?
  aiPhotoTimeline       Json?
  finalInvoice          Json?
  warrantyInfo          Json?
  completionPdfUrl      String?
  invoicePdfUrl         String?
  warrantyPdfUrl        String?
  photoBookPdfUrl       String?
  generated             Boolean   @default(false)
  generatedAt           DateTime?
  sentToHomeowner       Boolean   @default(false)
  sentToHomeownerAt     DateTime?
  homeownerSigned       Boolean   @default(false)
  homeownerSignedAt     DateTime?
  homeownerSignatureUrl String?
  warrantyManufacturer  String?
  warrantyRegistered    Boolean   @default(false)
  warrantyRegisteredAt  DateTime?
  warrantyNumber        String?
  metadata              Json?
  claims                claims    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  Org                   Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, generated])
}

model CrewSchedule {
  id                  String    @id
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  orgId               String
  claimId             String
  crewLeadId          String
  crewMemberIds       String[]
  scheduledDate       DateTime
  startTime           String
  estimatedDuration   Int
  complexity          String
  status              String    @default("scheduled")
  weatherRisk         String?
  weatherCheckedAt    DateTime?
  crewNotified        Boolean   @default(false)
  crewNotifiedAt      DateTime?
  homeownerNotified   Boolean   @default(false)
  homeownerNotifiedAt DateTime?
  actualStartTime     DateTime?
  actualEndTime       DateTime?
  completedBy         String?
  scopeOfWork         String?
  specialInstructions String?
  safetyNotes         String?
  accessInstructions  String?
  metadata            Json?
  claims              claims    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  users               users     @relation(fields: [crewLeadId], references: [id])
  Org                 Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([crewLeadId, scheduledDate])
  @@index([orgId, claimId])
  @@index([status, scheduledDate])
}

model DashboardKpi {
  id        String   @id
  orgId     String?
  label     String
  value     Float?   @default(0)
  trend     Float?   @default(0)
  icon      String?  @default("Activity")
  updatedAt DateTime
  createdAt DateTime @default(now())
}

model DenialResponse {
  id              String   @id
  leadId          String
  orgId           String
  claimId         String
  denialPdfUrl    String
  extractedText   String
  denialReasons   Json
  appealArguments Json
  legalCitations  Json?
  rebuttalPdf     String?
  emailDraft      String?
  tone            String   @default("professional")
  status          String   @default("draft")
  createdAt       DateTime @default(now())
  updatedAt       DateTime

  @@index([claimId])
  @@index([createdAt(sort: Desc)])
  @@index([leadId])
  @@index([orgId])
  @@index([status])
}

model EstimateExport {
  id        String   @id
  orgId     String
  leadId    String
  claimId   String?
  xml       String?
  symbility Json?
  summary   String?
  createdAt DateTime @default(now())

  @@index([claimId])
  @@index([createdAt(sort: Desc)])
  @@index([leadId])
  @@index([orgId])
}

model InsightsCache {
  id        String   @id
  orgId     String?
  scope     String   @default("dashboard")
  content   String
  createdAt DateTime @default(now())

  @@index([orgId, scope, createdAt])
}

model JobCloseout {
  id                      String    @id
  createdAt               DateTime  @default(now())
  updatedAt               DateTime
  orgId                   String
  claimId                 String    @unique
  allPhotosPresent        Boolean   @default(false)
  allFormsUploaded        Boolean   @default(false)
  signedCompletionForm    Boolean   @default(false)
  finalInvoiceAttached    Boolean   @default(false)
  supplementStatus        String?
  warrantyRegistered      Boolean   @default(false)
  subcontractorsPaid      Boolean   @default(false)
  materialsReconciled     Boolean   @default(false)
  dumpsterAccounted       Boolean   @default(false)
  buildDaysLogged         Boolean   @default(false)
  depreciationRequested   Boolean   @default(false)
  depreciationRequestedAt DateTime?
  depreciationReceived    Boolean   @default(false)
  depreciationReceivedAt  DateTime?
  finalPaymentReceived    Boolean   @default(false)
  finalPaymentReceivedAt  DateTime?
  finalPaymentAmount      Decimal?  @db.Decimal(10, 2)
  finalPaymentMethod      String?
  closeoutStatus          String    @default("pending")
  closeoutCompletedAt     DateTime?
  blockingIssues          String[]
  metadata                Json?
  claims                  claims    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  Org                     Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, closeoutStatus])
}

model LeadPipelineEvent {
  id          String    @id
  leadId      String
  orgId       String
  stageId     String?
  stageName   String
  eventType   String
  triggered   Boolean   @default(false)
  triggeredAt DateTime?
  metadata    Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime

  @@index([createdAt(sort: Desc)])
  @@index([eventType])
  @@index([leadId])
  @@index([orgId])
  @@index([stageId])
  @@index([triggered])
}

model MaterialOrder {
  id                  String              @id
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  orgId               String
  claimId             String
  orderNumber         String              @unique
  vendor              String
  status              String              @default("draft")
  orderType           String
  deliveryDate        DateTime?
  deliveryWindow      String?
  deliveryAddress     String
  dropZoneNotes       String?
  specialInstructions String?
  subtotal            Decimal             @default(0) @db.Decimal(10, 2)
  tax                 Decimal             @default(0) @db.Decimal(10, 2)
  delivery            Decimal             @default(0) @db.Decimal(10, 2)
  total               Decimal             @default(0) @db.Decimal(10, 2)
  poNumber            String?
  confirmationNumber  String?
  trackingNumber      String?
  deliveredAt         DateTime?
  receivedBy          String?
  metadata            Json?
  claims              claims              @relation(fields: [claimId], references: [id], onDelete: Cascade)
  Org                 Org                 @relation(fields: [orgId], references: [id], onDelete: Cascade)
  MaterialOrderItem   MaterialOrderItem[]

  @@index([deliveryDate])
  @@index([orgId, claimId])
  @@index([vendor, status])
}

model MaterialOrderItem {
  id             String        @id
  createdAt      DateTime      @default(now())
  orderId        String
  category       String
  productName    String
  manufacturer   String?
  color          String?
  quantity       Decimal       @db.Decimal(10, 2)
  unit           String
  unitPrice      Decimal       @db.Decimal(10, 2)
  lineTotal      Decimal       @db.Decimal(10, 2)
  specifications Json?
  metadata       Json?
  MaterialOrder  MaterialOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId, category])
}

model Message {
  id            String        @id
  threadId      String
  senderUserId  String
  senderType    String
  body          String
  read          Boolean       @default(false)
  fromPortal    Boolean       @default(false)
  createdAt     DateTime      @default(now())
  MessageThread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([senderUserId], map: "app_Message_senderUserId_idx")
  @@index([threadId], map: "app_Message_threadId_idx")
}

model MessageThread {
  id             String    @id
  orgId          String
  claimId        String?
  tradePartnerId String?
  clientId       String?
  participants   String[]  @default([])
  subject        String?
  isPortalThread Boolean   @default(false)
  archivedAt     DateTime?
  archivedBy     String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @default(now())
  Message        Message[]

  @@index([claimId], map: "app_MessageThread_claimId_idx")
  @@index([clientId], map: "app_MessageThread_clientId_idx")
  @@index([isPortalThread], map: "app_MessageThread_isPortalThread_idx")
  @@index([orgId], map: "app_MessageThread_orgId_idx")
}

model Org {
  id                        String                      @id
  clerkOrgId                String                      @unique
  name                      String
  planId                    String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  stripeCustomerId          String?
  stripeSubscriptionId      String?
  subscriptionStatus        String?
  trialStartAt              DateTime?
  trialEndsAt               DateTime?
  trialStatus               String?
  planKey                   String?
  sentTrialT24              Boolean                     @default(false)
  sentTrialT1               Boolean                     @default(false)
  referralCode              String?                     @unique
  brandLogoUrl              String?
  pdfFooterText             String?
  pdfHeaderText             String?
  videoEnabled              Boolean                     @default(false)
  videoPlanTier             String?
  aiCacheEnabled            Boolean                     @default(true)
  aiCacheTTL                Int?                        @default(604800)
  aiDedupeEnabled           Boolean                     @default(true)
  aiModeDefault             String?                     @default("auto")
  coldStorageEnabled        Boolean?                    @default(false)
  coldStorageEnabledAt      DateTime?                   @db.Timestamptz(6)
  demoMode                  Boolean                     @default(false)
  demoSeededAt              DateTime?
  is_archived               Boolean                     @default(false)
  BillingSettings           BillingSettings?
  BuildProgress             BuildProgress[]
  Client                    Client[]
  CompletionPacket          CompletionPacket[]
  CrewSchedule              CrewSchedule[]
  JobCloseout               JobCloseout[]
  MaterialOrder             MaterialOrder[]
  Plan                      Plan?                       @relation(fields: [planId], references: [id])
  ProjectNotification       ProjectNotification[]
  ReviewReferral            ReviewReferral[]
  Subscription              Subscription?
  VendorPricing             VendorPricing[]
  activities                activities[]
  ai_reports                ai_reports[]
  api_tokens                api_tokens[]
  appointments              appointments[]
  canvassing_routes         canvassing_routes[]
  claims                    claims[]
  code_requirements         code_requirements[]
  contacts                  contacts[]
  contractor_profiles       contractor_profiles?
  customer_contractor_links customer_contractor_links[]
  damage_assessments        damage_assessments[]
  documents                 documents[]
  door_knocks               door_knocks[]
  estimates                 estimates[]
  feature_flags             feature_flags[]
  file_assets               file_assets[]
  inspections               inspections[]
  job_schedules             job_schedules[]
  jobs                      jobs[]
  leads                     leads[]
  maintenance_records       maintenance_records[]
  maintenance_schedules     maintenance_schedules[]
  maintenance_tasks         maintenance_tasks[]
  maintenance_vendors       maintenance_vendors[]
  material_forensic_reports material_forensic_reports[]
  network_posts             network_posts[]
  ocr_records               ocr_records[]
  projects                  projects[]
  properties                properties[]
  property_annual_reports   property_annual_reports[]
  property_digital_twins    property_digital_twins[]
  property_health_scores    property_health_scores[]
  property_impacts          property_impacts[]
  property_inspections      property_inspections[]
  property_materials        property_materials[]
  property_profiles         property_profiles[]
  storm_events              storm_events[]
  storm_records             storm_records[]
  supplements               supplements[]
  tasks                     tasks[]
  team_performance          team_performance[]
  user_organizations        user_organizations[]
  users                     users[]
  sms_messages              sms_messages[]
  customer_payments         customer_payments[]
  permits                   permits[]
  mortgage_checks           mortgage_checks[]
  commission_plans          commission_plans[]
  job_financials            job_financials[]
  commission_records        commission_records[]
  quickbooks_connections    quickbooks_connections?
  measurement_orders        measurement_orders[]
  migration_jobs            migration_jobs[]

  @@index([stripeCustomerId])
  @@index([subscriptionStatus])
  @@index([trialEndsAt])
}

model OrgTemplate {
  id         String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  orgId      String
  templateId String
  customName String?
  isActive   Boolean?  @default(true)
  createdAt  DateTime? @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime? @default(now()) @db.Timestamptz(6)
  Template   Template  @relation(fields: [templateId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([orgId, templateId])
}

model Partner {
  id        String   @id
  orgId     String
  name      String
  trade     String
  email     String?
  phone     String?
  website   String?
  address   String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@index([orgId, trade])
}

model PipelineMetrics {
  id             String   @id
  orgId          String
  date           DateTime @default(now())
  totalLeads     Int      @default(0)
  leadsConverted Int      @default(0)
  avgTimeToClose Float?
  conversionRate Float?
  stageBreakdown Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime

  @@unique([orgId, date])
  @@index([date(sort: Desc)])
  @@index([orgId])
}

model Plan {
  id                   String   @id
  name                 String   @unique
  slug                 String   @unique
  stripeProductId      String   @unique
  stripePriceId        String   @unique
  monthlyPriceId       String   @unique
  monthlyTokens        Int      @default(0)
  aiIncluded           Int      @default(0)
  dolCheckIncluded     Int      @default(0)
  dolFullIncluded      Int      @default(0)
  aiOverageCents       Int      @default(0)
  dolCheckOverageCents Int      @default(0)
  dolFullOverageCents  Int      @default(0)
  limits               Json?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime
  Org                  Org[]
}

model PricingProfile {
  id           String   @id
  orgId        String   @unique
  taxRate      Float    @default(0.089)
  opPercent    Float    @default(0.20)
  wasteFactor  Float    @default(0.15)
  laborFactor  Float    @default(1.00)
  regionFactor Float    @default(1.00)
  createdAt    DateTime @default(now())

  @@index([orgId])
}

model ProjectNotification {
  id               String    @id
  createdAt        DateTime  @default(now())
  orgId            String
  claimId          String
  notificationType String
  title            String
  message          String
  sentAt           DateTime?
  sentVia          String[]
  delivered        Boolean   @default(false)
  deliveredAt      DateTime?
  read             Boolean   @default(false)
  readAt           DateTime?
  metadata         Json?
  claims           claims    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  Org              Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([notificationType, sentAt])
  @@index([orgId, claimId])
}

model ReportTemplate {
  id        String   @id
  orgId     String
  name      String
  type      String
  sections  String[]
  options   Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())

  @@index([orgId, type])
}

model RetailEstimate {
  id                 String               @id
  RetailEstimateItem RetailEstimateItem[]
}

model RetailEstimateItem {
  id             String         @id
  estimateId     String
  productId      String
  price          Decimal?
  spec           String?
  warranty       String?
  color          String?
  quantity       Int            @default(1)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  RetailEstimate RetailEstimate @relation(fields: [estimateId], references: [id], onDelete: Cascade)
  VendorProduct  VendorProduct  @relation(fields: [productId], references: [id])
}

model ReviewReferral {
  id                  String    @id
  createdAt           DateTime  @default(now())
  updatedAt           DateTime
  orgId               String
  claimId             String
  reviewRequested     Boolean   @default(false)
  reviewRequestedAt   DateTime?
  reviewSubmitted     Boolean   @default(false)
  reviewSubmittedAt   DateTime?
  reviewPlatform      String?
  reviewRating        Int?
  reviewText          String?
  reviewUrl           String?
  referralRequested   Boolean   @default(false)
  referralRequestedAt DateTime?
  referralProvided    Boolean   @default(false)
  referralProvidedAt  DateTime?
  referralName        String?
  referralPhone       String?
  referralEmail       String?
  referralAddress     String?
  annualInspection    Boolean   @default(false)
  seasonalCheckIn     Boolean   @default(false)
  metadata            Json?
  claims              claims    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  Org                 Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, claimId])
  @@index([reviewSubmitted, referralProvided])
}

model SignatureEnvelope {
  id                String     @id
  provider          String     @default("internal")
  externalId        String?
  status            String     @default("draft")
  documentName      String
  documentUrl       String?
  signedDocumentUrl String?
  jobId             String?
  claimId           String?
  workRequestId     String?
  signerEmail       String
  signerName        String
  signerRole        String?    @default("client")
  sentAt            DateTime?  @db.Timestamptz(6)
  viewedAt          DateTime?  @db.Timestamptz(6)
  signedAt          DateTime?  @db.Timestamptz(6)
  expiresAt         DateTime?  @db.Timestamptz(6)
  metadata          Json?      @default("{}")
  createdAt         DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime   @default(now()) @db.Timestamptz(6)
  ClientJob         ClientJob? @relation(fields: [jobId], references: [id])

  @@index([jobId])
  @@index([signerEmail])
  @@index([status])
}

model StatusTransition {
  id         String    @id
  entityType String
  entityId   String
  fromStatus String?
  toStatus   String
  userId     String?
  userName   String?
  userRole   String?
  reason     String?
  notes      String?
  metadata   Json?     @default("{}")
  createdAt  DateTime  @default(now()) @db.Timestamptz(6)
  ClientJob  ClientJob @relation(fields: [entityId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([entityType, entityId])
}

model StormImpact {
  id              String    @id
  leadId          String
  orgId           String
  claimId         String?
  stormDate       DateTime?
  stormName       String?
  hailSize        Float?
  windSpeed       Float?
  stormDistance   Float?
  stormDuration   Int?
  severityScore   Float
  noaaData        Json?
  nwsData         Json?
  iaDolData       Json?
  heatmapUrl      String?
  radarImageUrl   String?
  impactAnalysis  Json?
  publicId        String?   @unique
  publicExpiresAt DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime

  @@index([claimId])
  @@index([createdAt(sort: Desc)])
  @@index([leadId])
  @@index([orgId])
  @@index([publicId])
  @@index([severityScore])
  @@index([stormDate])
}

model Subscription {
  id                       String    @id
  orgId                    String    @unique
  stripeCustomerId         String    @unique
  stripeSubId              String?   @unique
  stripeSubscriptionItemId String?
  seatCount                Int       @default(1)
  pricePerSeat             Int       @default(8000) // cents â€” $80.00
  status                   String
  currentPeriodEnd         DateTime?
  createdAt                DateTime  @default(now())
  updatedAt                DateTime
  Org                      Org       @relation(fields: [orgId], references: [id])
}

model SupplementReport {
  id              String   @id
  leadId          String
  orgId           String
  claimId         String?
  carrierName     String?
  detectedRules   Json?
  carrierScope    Json?
  contractorScope Json?
  missingItems    Json?
  codeUpgrades    Json?
  quantityFixes   Json?
  arguments       Json?
  recommended     Json?
  tone            String?
  pdfUrl          String?
  emailDraft      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime

  @@index([carrierName])
  @@index([claimId])
  @@index([createdAt(sort: Desc)])
  @@index([leadId])
  @@index([orgId])
}

model SystemMetric {
  id        String   @id
  key       String
  value     String
  createdAt DateTime @default(now())
}

model TearOffDiscovery {
  id               String        @id
  createdAt        DateTime      @default(now())
  progressId       String
  discoveryType    String
  severity         String
  detectedBy       String
  confidence       Decimal       @db.Decimal(5, 2)
  description      String
  recommendation   String
  photoUrls        String[]
  supplementNeeded Boolean       @default(false)
  supplementAmount Decimal?      @db.Decimal(10, 2)
  supplementStatus String?
  codeViolation    Boolean       @default(false)
  codeReference    String?
  resolved         Boolean       @default(false)
  resolvedAt       DateTime?
  resolutionNotes  String?
  metadata         Json?
  BuildProgress    BuildProgress @relation(fields: [progressId], references: [id], onDelete: Cascade)

  @@index([progressId, discoveryType])
  @@index([supplementNeeded, supplementStatus])
}

model Template {
  id            String        @id @default(dbgenerated("(gen_random_uuid())::text"))
  slug          String?       @unique
  name          String
  description   String?
  category      String?       @default("General")
  thumbnailUrl  String?
  version       String?       @default("1.0")
  tags          String[]      @default([])
  isPublished   Boolean?      @default(false)
  isActive      Boolean?      @default(true)
  isMarketplace Boolean?      @default(false)
  sections      Json?         @default("[]")
  createdAt     DateTime?     @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime?     @default(now()) @db.Timestamptz(6)
  OrgTemplate   OrgTemplate[]
}

model TradesConnection {
  id                                                        String        @id
  followerId                                                String
  followingId                                               String
  createdAt                                                 DateTime      @default(now())
  TradesProfile_TradesConnection_followerIdToTradesProfile  TradesProfile @relation("TradesConnection_followerIdToTradesProfile", fields: [followerId], references: [id], onDelete: Cascade)
  TradesProfile_TradesConnection_followingIdToTradesProfile TradesProfile @relation("TradesConnection_followingIdToTradesProfile", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model TradesMessage {
  id                                                       String        @id
  fromProfileId                                            String
  toProfileId                                              String
  subject                                                  String?
  message                                                  String
  read                                                     Boolean       @default(false)
  archived                                                 Boolean       @default(false)
  createdAt                                                DateTime      @default(now())
  TradesProfile_TradesMessage_fromProfileIdToTradesProfile TradesProfile @relation("TradesMessage_fromProfileIdToTradesProfile", fields: [fromProfileId], references: [id], onDelete: Cascade)
  TradesProfile_TradesMessage_toProfileIdToTradesProfile   TradesProfile @relation("TradesMessage_toProfileIdToTradesProfile", fields: [toProfileId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([fromProfileId])
  @@index([read, archived])
  @@index([toProfileId])
}

model TradesPost {
  id            String        @id
  profileId     String
  authorId      String
  type          String
  title         String?
  content       String
  location      String?
  city          String?
  state         String?
  tags          String[]
  images        String[]
  startDate     DateTime?
  endDate       DateTime?
  payRate       String?
  requirements  String?
  contactEmail  String?
  contactPhone  String?
  visibility    String        @default("public")
  active        Boolean       @default(true)
  featured      Boolean       @default(false)
  viewCount     Int           @default(0)
  responseCount Int           @default(0)
  likeCount     Int           @default(0)
  createdAt     DateTime      @default(now())
  updatedAt     DateTime
  TradesProfile TradesProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([city, state])
  @@index([createdAt(sort: Desc)])
  @@index([featured, active])
  @@index([profileId])
  @@index([type, active])
}

model TradesProfile {
  id                                                           String             @id
  userId                                                       String             @unique
  orgId                                                        String
  companyName                                                  String
  contactName                                                  String
  email                                                        String
  phone                                                        String?
  address                                                      String?
  city                                                         String?
  state                                                        String?
  zip                                                          String?
  latitude                                                     Float?
  longitude                                                    Float?
  specialties                                                  String[]
  certifications                                               String[]
  bio                                                          String?
  logoUrl                                                      String?
  website                                                      String?
  yearsInBusiness                                              Int?
  crewSize                                                     Int?
  rating                                                       Float?             @default(0)
  reviewCount                                                  Int                @default(0)
  projectCount                                                 Int                @default(0)
  verified                                                     Boolean            @default(false)
  active                                                       Boolean            @default(true)
  createdAt                                                    DateTime           @default(now())
  updatedAt                                                    DateTime
  avatarUrl                                                    String?
  TradesConnection_TradesConnection_followerIdToTradesProfile  TradesConnection[] @relation("TradesConnection_followerIdToTradesProfile")
  TradesConnection_TradesConnection_followingIdToTradesProfile TradesConnection[] @relation("TradesConnection_followingIdToTradesProfile")
  TradesMessage_TradesMessage_fromProfileIdToTradesProfile     TradesMessage[]    @relation("TradesMessage_fromProfileIdToTradesProfile")
  TradesMessage_TradesMessage_toProfileIdToTradesProfile       TradesMessage[]    @relation("TradesMessage_toProfileIdToTradesProfile")
  TradesPost                                                   TradesPost[]

  @@index([city, state])
  @@index([orgId])
  @@index([userId])
  @@index([verified, active])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model Vendor {
  id                  String                @id @default(dbgenerated("(gen_random_uuid())::text"))
  slug                String                @unique
  name                String
  description         String?
  logo                String?
  coverImage          String?
  website             String?
  category            String?
  primaryPhone        String?
  primaryEmail        String?
  isActive            Boolean?              @default(true)
  verifiedAt          DateTime?             @db.Timestamp(6)
  createdAt           DateTime?             @default(now()) @db.Timestamp(6)
  updatedAt           DateTime?             @default(now()) @db.Timestamp(6)
  emergencyPhone      String?
  isFeatured          Boolean?              @default(false)
  isVerified          Boolean?              @default(false)
  tradeTypes          String[]              @default([])
  vendorTypes         String[]              @default([])
  serviceRegions      String[]              @default([])
  rating              Decimal?              @db.Decimal(3, 2)
  reviewCount         Int?                  @default(0)
  deliveryRadiusMi    Int?
  financingAvail      Boolean?              @default(false)
  rebatesAvail        Boolean?              @default(false)
  certifications      String[]              @default([])
  foundedYear         Int?
  VendorContact       VendorContact[]
  VendorLocation      VendorLocation[]
  VendorResource      VendorResource[]
  job_vendors         job_vendors[]
  supplier_connectors supplier_connectors[]
  vendor_assets       vendor_assets[]
  vendor_products_v2  vendor_products_v2[]
  vendor_programs     vendor_programs[]

  @@index([category])
  @@index([isActive])
  @@index([isFeatured])
  @@index([slug])
  @@index([tradeTypes])
  @@index([vendorTypes])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model VendorContact {
  id             String          @id @default(dbgenerated("(gen_random_uuid())::text"))
  vendorId       String
  locationId     String?
  name           String
  title          String?
  email          String?
  phone          String?
  mobilePhone    String?
  territory      String[]
  isActive       Boolean?        @default(true)
  createdAt      DateTime?       @default(now()) @db.Timestamp(6)
  updatedAt      DateTime?       @default(now()) @db.Timestamp(6)
  isPrimary      Boolean?        @default(false)
  VendorLocation VendorLocation? @relation(fields: [locationId], references: [id], onUpdate: NoAction)
  Vendor         Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([isActive])
  @@index([locationId])
  @@index([vendorId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model VendorLocation {
  id                 String          @id @default(dbgenerated("(gen_random_uuid())::text"))
  vendorId           String
  name               String
  address            String?
  city               String
  state              String          @default("AZ")
  zip                String?
  phone              String?
  email              String?
  hours              Json?
  lat                String?
  lng                String?
  isActive           Boolean?        @default(true)
  createdAt          DateTime?       @default(now()) @db.Timestamp(6)
  updatedAt          DateTime?       @default(now()) @db.Timestamp(6)
  deliveryRadiusMi   Int?
  deliveryCutoffTime String?
  localRepName       String?
  localRepPhone      String?
  emergencyPhone     String?
  VendorContact      VendorContact[]
  Vendor             Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([city])
  @@index([isActive])
  @@index([state])
  @@index([vendorId])
}

model VendorPricing {
  id              String    @id
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  orgId           String
  vendor          String
  productCategory String
  productName     String
  manufacturer    String?
  unitPrice       Decimal   @db.Decimal(10, 2)
  unit            String
  leadTime        Int?
  inStock         Boolean   @default(true)
  effectiveFrom   DateTime  @default(now())
  effectiveTo     DateTime?
  metadata        Json?
  Org             Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, vendor, productName])
  @@index([vendor, productCategory])
}

model VendorProduct {
  id                 String               @id
  vendorId           String
  name               String
  spec               String?
  warranty           String?
  colorJson          String?
  data_sheet_url     String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  ClaimMaterial      ClaimMaterial[]
  RetailEstimateItem RetailEstimateItem[]
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model VendorResource {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  vendorId    String
  title       String
  description String?
  type        String
  url         String
  fileSize    String?
  format      String?
  category    String?
  tags        String[]
  isActive    Boolean?  @default(true)
  createdAt   DateTime? @default(now()) @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @db.Timestamp(6)
  downloads   Int?      @default(0)
  Vendor      Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([category])
  @@index([isActive])
  @@index([type])
  @@index([vendorId])
}

model VideoReport {
  id        String          @id
  orgId     String
  claimId   String
  type      VideoReportType
  url       String
  config    Json?
  createdAt DateTime        @default(now())
  updatedAt DateTime        @default(now())

  @@index([orgId, claimId, type])
}

model WebhookEvent {
  id            String   @id
  stripeEventId String   @unique
  type          String
  payload       Json
  createdAt     DateTime @default(now())
}

model WorkflowAction {
  id         String    @id
  orgId      String
  leadId     String
  stageId    String?
  actionType String
  status     String    @default("pending")
  config     Json
  result     Json?
  executedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime

  @@index([actionType])
  @@index([createdAt(sort: Desc)])
  @@index([leadId])
  @@index([orgId])
  @@index([stageId])
  @@index([status])
}

model WorkflowStage {
  id               String   @id
  orgId            String
  name             String
  description      String?
  order            Int
  color            String?
  autoActions      Json?
  triggerCondition Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime

  @@unique([orgId, name])
  @@index([order])
  @@index([orgId])
}

model activities {
  id           String       @id
  orgId        String
  type         String
  title        String
  description  String?
  userId       String
  userName     String
  contactId    String?
  leadId       String?
  projectId    String?
  claimId      String?
  inspectionId String?
  jobId        String?
  dueDate      DateTime?
  completedAt  DateTime?
  metadata     Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  claims       claims?      @relation(fields: [claimId], references: [id])
  contacts     contacts?    @relation(fields: [contactId], references: [id])
  inspections  inspections? @relation(fields: [inspectionId], references: [id])
  jobs         jobs?        @relation(fields: [jobId], references: [id])
  leads        leads?       @relation(fields: [leadId], references: [id])
  Org          Org          @relation(fields: [orgId], references: [id])
  projects     projects?    @relation(fields: [projectId], references: [id])

  @@index([orgId, type, createdAt])
  @@index([orgId, userId, createdAt])
}

model agent_missions {
  id                String        @id
  mission_id        String
  job_id            String
  org_id            String
  status            MissionStatus @default(QUEUED)
  preconditions_met Boolean       @default(false)
  requires_approval Boolean       @default(false)
  approved_by       String?
  approved_at       DateTime?
  started_at        DateTime?
  completed_at      DateTime?
  failed_at         DateTime?
  error_message     String?
  retry_count       Int           @default(0)
  metadata          Json?
  next_mission_id   String?
  created_at        DateTime      @default(now())
  updated_at        DateTime
  agent_tasks       agent_tasks[]

  @@index([job_id, status])
  @@index([mission_id])
  @@index([org_id, status])
  @@index([status, created_at])
}

model agent_schedules {
  id           String    @id
  mission_id   String
  org_id       String
  cron_pattern String
  enabled      Boolean   @default(true)
  last_run_at  DateTime?
  next_run_at  DateTime?
  created_at   DateTime  @default(now())
  updated_at   DateTime

  @@index([next_run_at])
  @@index([org_id, enabled])
}

model agent_tasks {
  id             String          @id
  mission_id     String
  job_id         String
  action_type    AgentActionType
  status         AgentTaskStatus @default(QUEUED)
  input          Json?
  output         Json?
  started_at     DateTime?
  completed_at   DateTime?
  failed_at      DateTime?
  error_message  String?
  retry_count    Int             @default(0)
  created_at     DateTime        @default(now())
  updated_at     DateTime
  agent_missions agent_missions  @relation(fields: [mission_id], references: [id], onDelete: Cascade)

  @@index([job_id])
  @@index([mission_id])
  @@index([status, created_at])
}

model ai_performance_logs {
  id          String   @id
  created_at  DateTime @default(now())
  route       String
  org_id      String
  lead_id     String?
  claim_id    String?
  duration_ms Int
  model       String
  tokens_in   Int      @default(0)
  tokens_out  Int      @default(0)
  cache_hit   Boolean  @default(false)
  cost_usd    Decimal? @db.Decimal(10, 6)
  error       String?

  @@index([cache_hit])
  @@index([created_at(sort: Desc)])
  @@index([org_id, created_at(sort: Desc)])
  @@index([org_id])
  @@index([route])
}

model ai_reports {
  id           String       @id
  orgId        String
  type         String
  title        String
  prompt       String?
  content      String
  tokensUsed   Int
  model        String?
  claimId      String?
  inspectionId String?
  userId       String
  userName     String
  status       String       @default("generated")
  attachments  Json?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  claims       claims?      @relation(fields: [claimId], references: [id])
  inspections  inspections? @relation(fields: [inspectionId], references: [id])
  Org          Org          @relation(fields: [orgId], references: [id])

  @@index([orgId, type, createdAt])
  @@index([orgId, userId])
}

model ai_usage {
  id          String   @id
  user_id     String
  org_id      String
  bucket      String
  tokens_used Int
  reason      String
  created_at  DateTime @default(now())

  @@index([bucket])
  @@index([created_at])
  @@index([org_id])
  @@index([user_id])
}

model api_keys {
  id           String    @id
  org_id       String
  name         String
  key_hash     String    @unique
  prefix       String
  permissions  Json
  last_used_at DateTime?
  expires_at   DateTime?
  revoked_at   DateTime?
  created_by   String
  created_at   DateTime  @default(now())
  updated_at   DateTime

  @@index([key_hash])
  @@index([org_id])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model api_tokens {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  org_id       String?
  token_hash   String    @unique
  scopes       String[]  @default([])
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  last_used_at DateTime? @db.Timestamptz(6)
  Org          Org?      @relation(fields: [org_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model appeal_logs {
  id                   String       @id
  job_id               String
  org_id               String
  type                 String
  status               AppealStatus @default(DRAFT)
  carrier_name         String?
  submitted_by         String?
  submitted_at         DateTime?
  response_received_at DateTime?
  original_amount      Float?
  requested_amount     Float?
  approved_amount      Float?
  denial_reason        String?
  packet_url           String?
  metadata             Json?
  created_at           DateTime     @default(now())
  updated_at           DateTime

  @@index([job_id, status])
  @@index([org_id, status])
  @@index([submitted_at])
}

model appointments {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  title       String
  description String?
  startTime   DateTime
  endTime     DateTime
  location    String?
  leadId      String?
  claimId     String?
  contactId   String?
  orgId       String
  assignedTo  String?
  status      String    @default("scheduled")
  notes       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())
  claims      claims?   @relation(fields: [claimId], references: [id])
  contacts    contacts? @relation(fields: [contactId], references: [id])
  leads       leads?    @relation(fields: [leadId], references: [id])
  Org         Org       @relation(fields: [orgId], references: [id])

  @@index([claimId])
  @@index([leadId])
  @@index([orgId, startTime])
}

model audit_events {
  id         String   @id
  org_id     String
  job_id     String?
  user_id    String?
  actor      String
  event_type String
  message    String
  metadata   Json?
  created_at DateTime @default(now())

  @@index([actor])
  @@index([event_type])
  @@index([job_id, created_at(sort: Desc)])
  @@index([org_id, created_at(sort: Desc)])
}

model audit_logs {
  id         String   @id
  org_id     String
  job_id     String?
  user_id    String
  user_name  String
  action     String
  payload    Json?
  mission_id String?
  actor      String?
  event_type String?
  metadata   Json?
  created_at DateTime @default(now())

  @@index([action])
  @@index([actor])
  @@index([created_at])
  @@index([job_id])
  @@index([mission_id])
  @@index([org_id])
  @@index([user_id])
}

model automation_actions {
  id                  String              @id
  trigger_id          String
  action_type         String
  status              String              @default("PENDING")
  result              Json?
  error_message       String?
  started_at          DateTime?
  completed_at        DateTime?
  created_at          DateTime            @default(now())
  updated_at          DateTime
  automation_triggers automation_triggers @relation(fields: [trigger_id], references: [id], onDelete: Cascade)

  @@index([action_type])
  @@index([status])
  @@index([trigger_id])
}

model automation_alerts {
  id           String   @id
  orgId        String
  claimId      String
  alert_type   String
  severity     String   @default("MEDIUM")
  title        String
  message      String
  metadata     Json?
  is_read      Boolean  @default(false)
  is_dismissed Boolean  @default(false)
  created_at   DateTime @default(now())
  updated_at   DateTime

  @@index([claimId])
  @@index([is_read])
  @@index([orgId])
  @@index([severity])
}

model automation_recommendations {
  id                  String   @id
  orgId               String
  claimId             String
  recommendation_type String
  title               String
  description         String
  reasoning           String?
  confidence          Float    @default(0.85)
  priority            String   @default("MEDIUM")
  action_button       String?
  action_endpoint     String?
  is_accepted         Boolean  @default(false)
  is_dismissed        Boolean  @default(false)
  created_at          DateTime @default(now())
  updated_at          DateTime

  @@index([claimId])
  @@index([is_accepted])
  @@index([orgId])
}

model automation_rules {
  id           String   @id
  org_id       String
  name         String
  description  String?
  is_active    Boolean  @default(true)
  trigger_type String
  conditions   Json?
  action       Json?
  created_at   DateTime @default(now())
  updated_at   DateTime

  @@index([is_active])
  @@index([org_id])
  @@index([trigger_type])
}

model automation_tasks {
  id               String    @id
  orgId            String
  claimId          String
  title            String
  description      String?
  priority         String    @default("MEDIUM")
  status           String    @default("OPEN")
  auto_generated   Boolean   @default(true)
  ai_suggested     Boolean   @default(false)
  category         String?
  linked_report_id String?
  metadata         Json?
  assigned_to      String?
  due_date         DateTime?
  completed_at     DateTime?
  created_at       DateTime  @default(now())
  updated_at       DateTime

  @@index([claimId])
  @@index([orgId])
  @@index([priority])
  @@index([status])
}

model automation_triggers {
  id                 String               @id
  orgId              String
  claimId            String
  trigger_type       String
  payload            Json?
  severity           String               @default("MEDIUM")
  status             String               @default("PENDING")
  processed_at       DateTime?
  created_at         DateTime             @default(now())
  updated_at         DateTime
  automation_actions automation_actions[]

  @@index([claimId])
  @@index([orgId])
  @@index([status])
  @@index([trigger_type])
}

model canvassing_routes {
  id                 String        @id
  orgId              String
  stormEventId       String
  routeName          String
  routeNumber        Int
  description        String?
  zipCode            String
  city               String
  neighborhood       String?
  propertyIds        Json
  totalProperties    Int
  estimatedDuration  Int
  optimizedOrder     Json
  startLat           Decimal       @db.Decimal(10, 7)
  startLng           Decimal       @db.Decimal(10, 7)
  mapUrl             String?
  assignedTo         String?
  assignedAt         DateTime?
  status             String        @default("PENDING")
  startedAt          DateTime?
  completedAt        DateTime?
  doorsKnocked       Int           @default(0)
  contactsMade       Int           @default(0)
  appointmentsBooked Int           @default(0)
  claimsSigned       Int           @default(0)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime
  Org                Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  storm_events       storm_events  @relation(fields: [stormEventId], references: [id], onDelete: Cascade)
  door_knocks        door_knocks[]

  @@index([assignedTo])
  @@index([orgId, stormEventId])
  @@index([status])
}

model carrier_approvals {
  id            String   @id
  job_id        String
  line_item_set Json
  scope_totals  Json
  version_tag   String?
  created_at    DateTime @default(now())
  updated_at    DateTime
  crm_jobs      crm_jobs @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([job_id])
}

model carrier_deliveries {
  id                      String    @id
  claim_id                String
  org_id                  String
  carrier_id              String?
  delivery_type           String
  channel                 String
  recipient_email         String?
  recipient_name          String?
  cc_emails               Json      @default("[]")
  bcc_emails              Json      @default("[]")
  subject                 String?
  body                    String?
  attachments             Json      @default("[]")
  total_attachment_size   Int?
  depreciation_package_id String?
  supplement_request_id   String?
  status                  String    @default("PENDING")
  sent_at                 DateTime?
  delivered_at            DateTime?
  opened_at               DateTime?
  downloaded_at           DateTime?
  first_response_at       DateTime?
  adjuster_response       String?
  response_emails         Json      @default("[]")
  error_message           String?
  retry_count             Int       @default(0)
  last_retry_at           DateTime?
  follow_up_sent_at       DateTime?
  escalated_at            DateTime?
  escalation_reason       String?
  confirmation_number     String?
  portal_screenshot       String?
  sent_by                 String
  metadata                Json      @default("{}")
  created_at              DateTime  @default(now())
  updated_at              DateTime
  carriers                carriers? @relation(fields: [carrier_id], references: [id])

  @@index([carrier_id])
  @@index([claim_id])
  @@index([delivery_type])
  @@index([org_id])
  @@index([sent_at])
  @@index([status])
}

model carrier_inbox {
  id           String             @id
  job_id       String
  org_id       String
  carrier_name String?
  subject      String?
  body         String?
  sender_email String?
  received_at  DateTime
  status       CarrierInboxStatus @default(UNREAD)
  processed_at DateTime?
  parsed_data  Json?
  attachments  Json?
  ai_summary   String?
  created_at   DateTime           @default(now())
  updated_at   DateTime

  @@index([job_id, status])
  @@index([org_id, status])
  @@index([received_at(sort: Desc)])
}

model carrier_profiles {
  id               String   @id
  org_id           String?
  name             String
  email_phrasing   Json
  terminology      Json
  signature_format Json?
  created_at       DateTime @default(now())
  updated_at       DateTime

  @@index([name])
  @@index([org_id])
}

model carrier_rules {
  id                   String   @id
  carrier_id           String
  rule_type            String
  subject_format       String?
  required_fields      Json     @default("[]")
  required_attachments Json     @default("[]")
  body_template        String?
  max_files            Int?
  allowed_file_types   Json     @default("[]")
  priority             Int      @default(0)
  is_active            Boolean  @default(true)
  created_at           DateTime @default(now())
  updated_at           DateTime
  carriers             carriers @relation(fields: [carrier_id], references: [id], onDelete: Cascade)

  @@index([carrier_id])
  @@index([rule_type])
}

model carriers {
  id                     String               @id
  name                   String               @unique
  slug                   String               @unique
  default_inbox          String
  supplement_inbox       String?
  depreciation_inbox     String?
  inspection_inbox       String?
  escalation_inbox       String?
  upload_portal_url      String?
  portal_supports_api    Boolean              @default(false)
  api_endpoint           String?
  email_domains          Json                 @default("[]")
  policy_patterns        Json                 @default("[]")
  preferred_channel      String               @default("email")
  max_attachment_size_mb Int                  @default(25)
  is_active              Boolean              @default(true)
  created_at             DateTime             @default(now())
  updated_at             DateTime
  carrier_deliveries     carrier_deliveries[]
  carrier_rules          carrier_rules[]
}

model claim_activities {
  id         String            @id
  claim_id   String
  user_id    String
  type       ClaimActivityType
  message    String?
  metadata   Json?
  created_at DateTime          @default(now())
  claims     claims            @relation(fields: [claim_id], references: [id], onDelete: Cascade)
  users      users             @relation(fields: [user_id], references: [id])

  @@index([claim_id, created_at(sort: Desc)], map: "idx_activity_claim_created")
}

model claim_analysis {
  id         String    @id @db.VarChar(191)
  claim_id   String    @unique @db.VarChar(191)
  slopes     Json?
  roof_map   Json?
  materials  Json?
  damages    Json?
  code_flags Json?
  risk_flags Json?
  scope      Json?
  summary    String?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  claims     claims    @relation(fields: [claim_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model claim_bad_faith_analysis {
  id         String    @id @db.VarChar(191)
  claim_id   String?   @unique @db.VarChar(191)
  analysis   Json?
  severity   Int?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  claims     claims?   @relation(fields: [claim_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model claim_builders {
  id              String   @id
  claimId         String   @unique
  summary         String?
  weatherMatch    String?
  recommendations Json?
  lineItems       Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  claims          claims   @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
}

model claim_event_reconstruction {
  id         String    @id @db.VarChar(191)
  claim_id   String?   @unique @db.VarChar(191)
  timeline   Json?
  sources    Json?
  confidence Float?
  created_at DateTime? @default(now()) @db.Timestamptz(6)
  claims     claims?   @relation(fields: [claim_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([claim_id], map: "idx_claim_event_reconstruction_claim_id")
}

model claim_payments {
  id           String      @id
  claim_id     String
  type         PaymentType
  amount_cents Int
  paid_at      DateTime
  check_number String?
  notes        String?
  created_at   DateTime    @default(now())
  claims       claims      @relation(fields: [claim_id], references: [id], onDelete: Cascade)

  @@index([claim_id, paid_at(sort: Desc)], map: "idx_payments_claim_paid")
}

model claim_supplements {
  id           String           @id
  claim_id     String
  status       SupplementStatus
  total_cents  Int
  data         Json             @default("{}")
  submitted_at DateTime?
  reviewed_at  DateTime?
  review_notes String?
  created_at   DateTime         @default(now())
  updated_at   DateTime
  claims       claims           @relation(fields: [claim_id], references: [id], onDelete: Cascade)

  @@index([claim_id, status])
}

model claim_tasks {
  id                                      String    @id
  org_id                                  String
  claim_id                                String?
  created_by_id                           String?
  assigned_to_id                          String?
  assignee_role                           String?
  source                                  String
  title                                   String
  description                             String?
  status                                  String    @default("todo")
  priority                                String    @default("normal")
  due_date                                DateTime?
  completed_at                            DateTime?
  related_ids                             Json?
  created_at                              DateTime  @default(now())
  updated_at                              DateTime
  users_claim_tasks_assigned_to_idTousers users?    @relation("claim_tasks_assigned_to_idTousers", fields: [assigned_to_id], references: [id])
  claims                                  claims?   @relation(fields: [claim_id], references: [id], onDelete: Cascade)
  users_claim_tasks_created_by_idTousers  users?    @relation("claim_tasks_created_by_idTousers", fields: [created_by_id], references: [id])

  @@index([assigned_to_id])
  @@index([claim_id])
  @@index([due_date])
  @@index([org_id])
  @@index([priority])
  @@index([source])
  @@index([status])
}

model claim_timeline_events {
  id                String   @id
  org_id            String?
  claim_id          String
  type              String
  description       String?
  actor_id          String?
  actor_type        String?
  related_ids       Json?
  metadata          Json?
  occurred_at       DateTime @default(now())
  visible_to_client Boolean  @default(false)
  users             users?   @relation(fields: [actor_id], references: [id])
  claims            claims   @relation(fields: [claim_id], references: [id], onDelete: Cascade)

  @@index([actor_id])
  @@index([claim_id])
  @@index([claim_id, visible_to_client])
  @@index([occurred_at])
  @@index([type])
}

model claims {
  id                         String                      @id
  orgId                      String
  propertyId                 String
  projectId                  String?
  claimNumber                String                      @unique
  title                      String
  description                String?
  damageType                 String
  dateOfLoss                 DateTime
  carrier                    String?
  adjusterName               String?
  adjusterPhone              String?
  adjusterEmail              String?
  status                     String                      @default("new")
  priority                   String                      @default("medium")
  estimatedValue             Int?
  approvedValue              Int?
  deductible                 Int?
  assignedTo                 String?
  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime
  exposure_cents             Int?
  insured_name               String?
  lifecycle_stage            ClaimLifecycleStage?
  policy_number              String?
  adjuster_packet_sent_at    DateTime?
  homeownerEmail             String?
  homeowner_summary_sent_at  DateTime?
  last_contacted_at          DateTime?
  catStormEventId            String?
  homeowner_email            String?
  clientId                   String?
  archivedAt                 DateTime?                   @db.Timestamptz(6)
  isDemo                     Boolean                     @default(false)
  BuildProgress              BuildProgress?
  ClaimClientLink            ClaimClientLink[]
  ClaimMaterial              ClaimMaterial[]
  ClaimMessage               ClaimMessage[]
  CompletionPacket           CompletionPacket?
  CrewSchedule               CrewSchedule[]
  JobCloseout                JobCloseout?
  MaterialOrder              MaterialOrder[]
  ProjectNotification        ProjectNotification[]
  ReviewReferral             ReviewReferral[]
  activities                 activities[]
  ai_reports                 ai_reports[]
  appointments               appointments[]
  claim_activities           claim_activities[]
  claim_analysis             claim_analysis?
  claim_bad_faith_analysis   claim_bad_faith_analysis?
  claim_builders             claim_builders?
  claim_event_reconstruction claim_event_reconstruction?
  claim_payments             claim_payments[]
  claim_supplements          claim_supplements[]
  claim_tasks                claim_tasks[]
  claim_timeline_events      claim_timeline_events[]
  users                      users?                      @relation(fields: [assignedTo], references: [id])
  storm_events               storm_events?               @relation(fields: [catStormEventId], references: [id])
  Org                        Org                         @relation(fields: [orgId], references: [id])
  projects                   projects?                   @relation(fields: [projectId], references: [id])
  properties                 properties                  @relation(fields: [propertyId], references: [id])
  client_access              client_access[]
  damage_assessments         damage_assessments[]
  depreciation_invoices      depreciation_invoices[]
  depreciation_items         depreciation_items[]
  estimates                  estimates[]
  financial_snapshots        financial_snapshots[]
  inspections                inspections[]
  jobs                       jobs[]
  leads                      leads?
  material_forensic_reports  material_forensic_reports[]
  payment_history            payment_history[]
  property_impacts           property_impacts?
  reports                    reports[]
  scopes                     scopes[]
  supplement_items           supplement_items[]
  supplements                supplements[]
  weather_reports            weather_reports[]
  permits                    permits[]
  mortgage_checks            mortgage_checks[]

  externalId     String?
  externalSource String?

  @@index([orgId, assignedTo])
  @@index([orgId, status])
  @@index([clientId], map: "idx_claims_clientid")
  @@index([orgId, lifecycle_stage], map: "idx_claims_org_stage")
  @@index([orgId, externalId, externalSource])
  @@index([orgId, createdAt], map: "idx_claims_org_created")
  @@index([orgId, damageType], map: "idx_claims_org_damage_type")
}

model client_access {
  id        String   @id
  claimId   String
  email     String
  createdAt DateTime @default(now())
  claims    claims   @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@unique([claimId, email])
  @@index([claimId])
}

model client_activity {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientNetworkId String          @db.Uuid
  type            String
  message         String?
  actorType       String          @default("system")
  actorId         String?
  metadata        Json?           @default("{}")
  createdAt       DateTime?       @default(now()) @db.Timestamptz(6)
  client_networks client_networks @relation(fields: [clientNetworkId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([createdAt(sort: Desc)], map: "idx_client_activity_created")
  @@index([clientNetworkId], map: "idx_client_activity_network")
}

model client_contacts {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientNetworkId String          @db.Uuid
  name            String
  email           String?
  phone           String?
  role            String?         @default("Homeowner")
  isPrimary       Boolean?        @default(false)
  createdAt       DateTime?       @default(now()) @db.Timestamptz(6)
  client_networks client_networks @relation(fields: [clientNetworkId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([clientNetworkId], map: "idx_client_contacts_network")
}

model client_networks {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId               String
  slug                String                @unique
  name                String
  email               String?
  phone               String?
  address             String?
  city                String?
  state               String?
  zip                 String?
  propertyType        String?
  notes               String?
  status              String?               @default("active")
  category            String?               @default("Homeowner")
  createdAt           DateTime?             @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime?             @default(now()) @db.Timestamptz(6)
  client_activity     client_activity[]
  client_contacts     client_contacts[]
  client_saved_trades client_saved_trades[]

  @@index([category], map: "idx_client_networks_category")
  @@index([orgId], map: "idx_client_networks_org")
  @@index([status], map: "idx_client_networks_status")
}

model client_projects {
  id                 String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkUserId        String
  clientProfileId    String?        @db.Uuid
  title              String         @db.VarChar(255)
  projectType        String         @db.VarChar(50)
  description        String
  urgency            String         @default("normal") @db.VarChar(20)
  budgetRange        String?        @db.VarChar(50)
  address            String?
  city               String?        @db.VarChar(100)
  state              String?        @db.VarChar(2)
  zip                String?        @db.VarChar(10)
  preferredStartDate DateTime?      @db.Date
  status             String         @default("draft") @db.VarChar(20)
  acceptedBidId      String?        @db.Uuid
  createdAt          DateTime       @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime       @default(now()) @db.Timestamptz(6)
  publishedAt        DateTime?      @db.Timestamptz(6)
  completedAt        DateTime?      @db.Timestamptz(6)
  project_bids       project_bids[]

  @@index([city, state])
  @@index([clerkUserId])
  @@index([createdAt(sort: Desc)])
  @@index([projectType])
  @@index([status])
}

model client_saved_trades {
  id              String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientNetworkId String          @db.Uuid
  companyId       String          @db.Uuid
  notes           String?
  rating          Int?
  createdAt       DateTime?       @default(now()) @db.Timestamptz(6)
  client_networks client_networks @relation(fields: [clientNetworkId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([clientNetworkId, companyId])
  @@index([companyId], map: "idx_client_saved_trades_company")
  @@index([clientNetworkId], map: "idx_client_saved_trades_network")
}

model clients {
  id                 String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email              String   @unique
  firstName          String?  @db.VarChar(100)
  lastName           String?  @db.VarChar(100)
  phone              String?  @db.VarChar(20)
  clientType         String?  @db.VarChar(50)
  projectNeeds       String[] @default([])
  projectDescription String?
  idealContractor    String?
  photoUrls          String[] @default([])
  address            String?
  city               String?  @db.VarChar(100)
  state              String?  @db.VarChar(2)
  zip                String?  @db.VarChar(10)
  status             String   @default("active") @db.VarChar(20)
  avatarUrl          String?
  createdAt          DateTime @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime @default(now()) @db.Timestamptz(6)

  @@index([clientType])
  @@index([email])
  @@index([status])
}

model code_requirements {
  id        String @id
  region    String
  code      String
  summary   String
  lineItems Json?
  orgId     String
  Org       Org    @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, region, code])
  @@index([region, code])
}

model completion_documents {
  id          String   @id
  claim_id    String
  org_id      String
  type        String
  url         String
  file_name   String?
  file_size   Int?
  uploaded_by String?
  uploaded_at DateTime @default(now())

  @@index([claim_id])
  @@index([org_id])
  @@index([type])
}

model completion_photos {
  id               String    @id
  claim_id         String
  org_id           String
  url              String
  file_name        String?
  file_size        Int?
  category         String?
  phase            String?
  ai_tags          Json?     @default("[]")
  ai_analysis      Json?
  analyzed         Boolean   @default(false)
  uploaded_by      String?
  created_at       DateTime  @default(now())
  updated_at       DateTime
  ai_metadata      Json      @default("{}")
  build_stage      String?
  supplement_flags Json      @default("[]")
  timeline_order   Int?
  timestamp_guess  DateTime?

  @@index([analyzed])
  @@index([category])
  @@index([claim_id, build_stage])
  @@index([claim_id])
  @@index([claim_id, timeline_order])
  @@index([org_id])
}

model completion_status {
  id                         String    @id
  claim_id                   String    @unique
  org_id                     String
  is_complete                Boolean   @default(false)
  completion_form_uploaded   Boolean   @default(false)
  completion_photos_uploaded Boolean   @default(false)
  walkthrough_passed         Boolean   @default(false)
  notes                      String?
  completed_at               DateTime?
  completed_by               String?
  created_at                 DateTime  @default(now())
  updated_at                 DateTime

  @@index([claim_id])
  @@index([is_complete])
  @@index([org_id])
}

model completion_timeline {
  id                         String                @id
  claim_id                   String
  org_id                     String
  timeline                   Json                  @default("[]")
  supplements                Json                  @default("[]")
  narrative_text             String?
  narrative_version          String                @default("carrier")
  ai_model_version           String?
  ai_confidence_score        Decimal?              @db.Decimal(5, 4)
  total_photos_analyzed      Int?
  total_supplements_detected Int                   @default(0)
  high_severity_count        Int                   @default(0)
  medium_severity_count      Int                   @default(0)
  low_severity_count         Int                   @default(0)
  status                     String                @default("draft")
  finalized_at               DateTime?
  sent_at                    DateTime?
  created_at                 DateTime              @default(now())
  updated_at                 DateTime
  supplement_requests        supplement_requests[]

  @@index([claim_id])
  @@index([org_id])
  @@index([status])
}

model contacts {
  id             String         @id
  orgId          String
  firstName      String
  lastName       String
  email          String?
  phone          String?
  company        String?
  title          String?
  street         String?
  city           String?
  state          String?
  zipCode        String?
  source         String?
  notes          String?
  tags           String[]       @default([])
  createdAt      DateTime       @default(now())
  updatedAt      DateTime
  slug           String?        @unique
  isDemo         Boolean        @default(false)
  externalId     String?
  externalSource String?
  activities     activities[]
  appointments   appointments[]
  Org            Org            @relation(fields: [orgId], references: [id])
  leads          leads[]
  projects       projects[]
  properties     properties[]
  sms_messages   sms_messages[]

  @@index([orgId, email])
  @@index([orgId, phone])
  @@index([orgId, externalId, externalSource])
}

model contractor_forms {
  id                  String              @id
  contractorId        String
  title               String
  description         String?
  fields              Json
  successMessage      String?
  isPublic            Boolean             @default(true)
  requirePhotos       Boolean             @default(false)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  contractor_profiles contractor_profiles @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  public_leads        public_leads[]

  @@index([contractorId, isPublic])
}

model contractor_invoices {
  id         String   @id
  job_id     String
  invoice_no String
  items      Json
  totals     Json
  kind       String
  created_at DateTime @default(now())
  updated_at DateTime
  crm_jobs   crm_jobs @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([invoice_no])
  @@index([job_id])
  @@index([kind])
}

model contractor_profiles {
  id                       String                     @id
  orgId                    String                     @unique
  userId                   String?
  slug                     String                     @unique
  businessName             String
  logoUrl                  String?
  coverPhotoUrl            String?
  tagline                  String?
  about                    String?
  phone                    String?
  email                    String?
  website                  String?
  services                 Json
  serviceAreas             Json
  hoursOfOperation         Json?
  emergencyAvailable       Boolean                    @default(false)
  licenseNumber            String?
  insuranceProof           String?
  certifications           Json?
  gallery                  Json?
  verified                 Boolean                    @default(false)
  featured                 Boolean                    @default(false)
  searchKeywords           String[]                   @default([])
  totalLeads               Int                        @default(0)
  totalJobs                Int                        @default(0)
  isPublic                 Boolean                    @default(true)
  acceptingLeads           Boolean                    @default(true)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime
  businessVerified         Boolean                    @default(false)
  emailVerified            Boolean                    @default(false)
  emergencyReady           Boolean                    @default(false)
  featuredUntil            DateTime?
  insuranceVerified        Boolean                    @default(false)
  lastSeenAt               DateTime                   @default(now())
  licenseVerified          Boolean                    @default(false)
  primaryTrade             String?
  trustScore               Int                        @default(0)
  averageRating            Float                      @default(0)
  totalReviews             Int                        @default(0)
  contractor_forms         contractor_forms[]
  Org                      Org                        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  contractor_verifications contractor_verifications[]
  public_leads             public_leads[]
  reviews                  reviews[]

  @@index([averageRating])
  @@index([orgId])
  @@index([slug])
  @@index([verified, featured])
}

model contractor_verifications {
  id                  String              @id
  contractorId        String
  step                String
  status              String              @default("pending")
  documentUrl         String?
  notes               String?
  metadata            Json?
  reviewedBy          String?
  reviewedAt          DateTime?
  denialReason        String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  contractor_profiles contractor_profiles @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@index([contractorId, step])
  @@index([status])
}

model contractors {
  id                String   @id
  user_id           String
  trade             String
  region            String
  company_name      String?
  website           String?
  contact_email     String?
  profile_photo_url String?
  description       String?
  premium           Boolean  @default(false)
  created_at        DateTime @default(now())
  updated_at        DateTime

  @@index([premium])
  @@index([region])
  @@index([trade])
}

model crm_documents {
  id         String   @id
  job_id     String
  type       String
  source_url String
  parsed     Json?
  confidence Float?
  status     String
  created_at DateTime @default(now())
  updated_at DateTime
  crm_jobs   crm_jobs @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([job_id])
  @@index([status])
  @@index([type])
}

model crm_jobs {
  id                  String                @id
  org_id              String
  report_id           String?
  status              String
  insured_name        String?
  property_address    String?
  carrier             String?
  claim_number        String?
  date_of_loss        DateTime?
  trade_scope         String[]              @default([])
  summary             Json?
  created_at          DateTime              @default(now())
  updated_at          DateTime
  carrier_approvals   carrier_approvals[]
  contractor_invoices contractor_invoices[]
  crm_documents       crm_documents[]
  fundings            fundings[]
  reconciliations     reconciliations[]
  supplements         supplements[]
  customer_payments   customer_payments[]
  permits             permits[]
  mortgage_checks     mortgage_checks[]
  job_financials      job_financials?
  commission_records  commission_records[]

  @@index([claim_number])
  @@index([org_id])
  @@index([report_id])
  @@index([status])
}

model customer_accounts {
  id                        String                      @id
  userId                    String                      @unique
  role                      String                      @default("HOMEOWNER")
  name                      String?
  email                     String?
  phone                     String?
  avatarUrl                 String?
  bio                       String?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  customer_contractor_links customer_contractor_links[]
  customer_properties       customer_properties[]
}

model customer_contractor_links {
  id                  String               @id
  customerId          String
  contractorId        String
  propertyId          String?
  trade               String
  isPrimary           Boolean              @default(false)
  nickname            String?
  notes               String?
  addedAt             DateTime             @default(now())
  lastJobDate         DateTime?
  totalJobs           Int                  @default(0)
  Org                 Org                  @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  customer_accounts   customer_accounts    @relation(fields: [customerId], references: [id], onDelete: Cascade)
  customer_properties customer_properties? @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([contractorId])
  @@index([customerId])
}

model customer_properties {
  id                        String                      @id
  customerId                String
  label                     String
  address                   String
  city                      String
  state                     String
  zip                       String
  propertyType              String?
  units                     Int?                        @default(1)
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime
  customer_contractor_links customer_contractor_links[]
  customer_accounts         customer_accounts           @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
}

model damage_assessments {
  id                     String               @id
  claim_id               String?
  lead_id                String?
  org_id                 String
  created_by_id          String
  summary                String?
  primaryPeril           String?
  overall_recommendation String?
  confidence             Float?
  loss_type              String?
  date_of_loss           DateTime?            @db.Date
  address                String?
  carrier                String?
  metadata               Json?
  created_at             DateTime             @default(now())
  updated_at             DateTime
  claims                 claims?              @relation(fields: [claim_id], references: [id], onDelete: Cascade)
  Org                    Org                  @relation(fields: [org_id], references: [id], onDelete: Cascade)
  damage_findings        damage_findings[]
  damage_photo_links     damage_photo_links[]
  reports                reports[]

  @@index([claim_id])
  @@index([created_by_id])
  @@index([lead_id])
  @@index([org_id])
  @@index([primaryPeril])
}

model damage_findings {
  id                   String             @id
  damage_assessment_id String
  photo_id             String?
  location_facet       String?
  elevation            String?
  location_notes       String?
  damage_type          String
  material             String?
  severity             String?
  peril_attribution    String?
  description          String?
  recommended_action   String?
  suggested_line_items Json?
  include_in_report    Boolean            @default(true)
  created_at           DateTime           @default(now())
  updated_at           DateTime
  damage_assessments   damage_assessments @relation(fields: [damage_assessment_id], references: [id], onDelete: Cascade)

  @@index([damage_assessment_id])
  @@index([damage_type])
  @@index([severity])
}

model damage_photo_links {
  id                   String             @id
  damage_assessment_id String
  photo_url            String
  caption              String?
  tag                  String?
  ai_analysis          Json?
  created_at           DateTime           @default(now())
  damage_assessments   damage_assessments @relation(fields: [damage_assessment_id], references: [id], onDelete: Cascade)

  @@index([damage_assessment_id])
}

model depreciation_invoices {
  id                 String    @id
  claim_id           String
  subtotal_cents     Int
  depreciation_cents Int
  tax_cents          Int
  total_due_cents    Int
  line_items         Json      @default("[]")
  generated_at       DateTime  @default(now())
  sent_at            DateTime?
  claims             claims    @relation(fields: [claim_id], references: [id], onDelete: Cascade)

  @@index([claim_id])
}

model depreciation_items {
  id           String   @id
  claimId      String
  label        String
  age          Int
  expectedLife Int
  rcv          Float
  acv          Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  claims       claims   @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
}

model depreciation_packages {
  id                      String    @id
  claim_id                String
  org_id                  String
  invoice                 Json
  contractor_statement    Json
  homeowner_acceptance    Json
  supplement              Json?
  timeline                Json?
  photo_appendix          Json?     @default("[]")
  code_citations          Json?     @default("[]")
  weather_verification    Json?
  total_depreciation_owed Decimal   @db.Decimal(10, 2)
  payments_received       Decimal   @db.Decimal(10, 2)
  final_invoice_total     Decimal   @db.Decimal(10, 2)
  supplement_amount       Decimal?  @db.Decimal(10, 2)
  pdf_url                 String?
  pdf_generated_at        DateTime?
  status                  String    @default("PENDING")
  sent_at                 DateTime?
  sent_to                 Json?     @default("[]")
  paid_at                 DateTime?
  notes                   String?
  generated_by            String
  created_at              DateTime  @default(now())
  updated_at              DateTime

  @@index([claim_id])
  @@index([org_id])
  @@index([status])
}

model depreciation_rules {
  id              String   @id
  material_type   String   @unique
  life_expectancy Int
  flat_rate       Float?
  variable_rate   Float?
  is_depreciable  Boolean  @default(true)
  notes           String?
  created_at      DateTime @default(now())
  updated_at      DateTime

  @@index([material_type])
}

model depreciation_trackers {
  id                     String    @id
  claim_id               String    @unique
  org_id                 String
  total_depreciation     Decimal   @db.Decimal(10, 2)
  requested_amount       Decimal?  @db.Decimal(10, 2)
  approved_amount        Decimal?  @db.Decimal(10, 2)
  issued_amount          Decimal?  @db.Decimal(10, 2)
  received_amount        Decimal?  @db.Decimal(10, 2)
  status                 String    @default("PENDING")
  requested_at           DateTime?
  approved_at            DateTime?
  issued_at              DateTime?
  received_at            DateTime?
  closed_at              DateTime?
  delayed_at             DateTime?
  delay_reason           String?
  expected_at            DateTime?
  denied_at              DateTime?
  denial_reason          String?
  ai_summary             Json?
  ai_confidence          Decimal?  @db.Decimal(5, 4)
  timeline               Json      @default("[]")
  emails_sent            Int       @default(0)
  emails_received        Int       @default(0)
  last_email_sent_at     DateTime?
  last_email_received_at DateTime?
  follow_up_scheduled    Boolean   @default(false)
  follow_up_at           DateTime?
  follow_up_count        Int       @default(0)
  payment_ids            Json      @default("[]")
  notes                  String?
  created_at             DateTime  @default(now())
  updated_at             DateTime

  @@index([claim_id])
  @@index([org_id])
  @@index([received_at])
  @@index([requested_at])
  @@index([status])
}

model documents {
  id          String       @id
  orgId       String
  projectId   String
  createdBy   String?
  type        DocumentType
  title       String
  description String?
  url         String
  mimeType    String?
  sizeBytes   Int?
  category    String?
  tags        String[]     @default([])
  isPublic    Boolean      @default(false)
  isFavorite  Boolean      @default(false)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime
  Org         Org          @relation(fields: [orgId], references: [id])
  projects    projects     @relation(fields: [projectId], references: [id])

  @@index([orgId, projectId])
  @@index([orgId, type])
}

model door_knocks {
  id                    String            @id
  orgId                 String
  routeId               String
  propertyImpactId      String
  knockedBy             String
  knockedAt             DateTime          @default(now())
  outcome               String
  notes                 String?
  contactName           String?
  contactPhone          String?
  contactEmail          String?
  followUpNeeded        Boolean           @default(false)
  followUpDate          DateTime?
  followUpNotes         String?
  appointmentScheduled  Boolean           @default(false)
  appointmentDate       DateTime?
  appointmentTimeWindow String?
  createdAt             DateTime          @default(now())
  Org                   Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_impacts      property_impacts  @relation(fields: [propertyImpactId], references: [id])
  canvassing_routes     canvassing_routes @relation(fields: [routeId], references: [id], onDelete: Cascade)

  @@index([knockedBy])
  @@index([outcome])
  @@index([routeId])
}

model email_subscribers {
  id                String                  @id
  email             String                  @unique
  firstName         String?
  lastName          String?
  subscribedAt      DateTime                @default(now()) @db.Timestamptz(6)
  unsubscribedAt    DateTime?               @db.Timestamptz(6)
  status            EmailSubscriptionStatus @default(ACTIVE)
  source            String?
  sourceUrl         String?
  referrer          String?
  userId            String?
  clientId          String?
  contractorId      String?                 @db.Uuid
  categories        String[]
  frequency         EmailFrequency          @default(WEEKLY)
  verified          Boolean                 @default(false)
  verificationToken String?                 @unique
  verifiedAt        DateTime?               @db.Timestamptz(6)
  lastEmailSent     DateTime?               @db.Timestamptz(6)
  emailsSent        Int                     @default(0)
  emailsOpened      Int                     @default(0)
  emailsClicked     Int                     @default(0)
  bounceCount       Int                     @default(0)
  ipAddress         String?
  userAgent         String?
  consentGiven      Boolean                 @default(true)
  consentDetails    String?
  createdAt         DateTime                @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime                @default(now()) @db.Timestamptz(6)

  @@index([source])
  @@index([status])
  @@index([subscribedAt])
  @@index([userId])
}

model estimate_line_items {
  id            String    @id
  estimate_id   String
  section_name  String?
  trade         String?
  area_ref      String?
  code          String?
  name          String
  scope_note    String?
  unit          String?
  quantity      Float
  unit_price    Float?
  line_total    Float?
  source        String?
  change_type   String?
  category      String?
  grouping      Json?
  justification String?
  created_at    DateTime  @default(now())
  updated_at    DateTime
  estimates     estimates @relation(fields: [estimate_id], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([estimate_id])
  @@index([trade])
}

model estimates {
  id                  String                @id
  orgId               String
  projectId           String
  authorId            String
  title               String
  description         String?
  tool                String?
  subtotal            Float?
  tax                 Float?
  total               Float?
  status              EstimateStatus        @default(DRAFT)
  pdfUrl              String?
  attachments         Json?
  scopeItems          Json?
  notes               String?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  carrier             String?
  claim_id            String?
  dol                 DateTime?
  grand_total         Float?
  labor_tax_rate      Float?
  loss_type           String?
  material_tax_rate   Float?
  mode                String?
  o_and_p_enabled     Boolean               @default(false)
  overhead_amount     Float?
  overhead_percent    Float?
  profit_amount       Float?
  profit_percent      Float?
  source              Json?
  tax_amount          Float?
  estimate_line_items estimate_line_items[]
  users               users                 @relation(fields: [authorId], references: [id])
  claims              claims?               @relation(fields: [claim_id], references: [id])
  Org                 Org                   @relation(fields: [orgId], references: [id])
  projects            projects              @relation(fields: [projectId], references: [id])
  reports             reports[]

  @@index([claim_id])
  @@index([orgId, projectId])
  @@index([orgId, status])
}

model export_jobs {
  id         String   @id
  report_id  String
  user_id    String
  org_id     String
  format     String
  status     String
  file_url   String?
  error      String?
  sections   Json?
  metadata   Json?
  created_at DateTime @default(now())
  updated_at DateTime

  @@index([created_at])
  @@index([org_id])
  @@index([report_id])
  @@index([status])
  @@index([user_id])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model feature_flags {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  org_id         String?
  key            String
  enabled        Boolean   @default(false)
  created_at     DateTime  @default(now()) @db.Timestamptz(6)
  last_access_at DateTime? @db.Timestamptz(6)
  Org            Org?      @relation(fields: [org_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([key, org_id], map: "feature_flags_key_org_idx")
}

model file_assets {
  id              String   @id
  orgId           String
  ownerId         String
  leadId          String?  @db.VarChar(191)
  claimId         String?  @db.VarChar(191)
  filename        String
  mimeType        String
  sizeBytes       Int
  storageKey      String
  bucket          String
  publicUrl       String
  checksum        String?
  category        String   @default("other")
  note            String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime
  file_type       String?  @db.VarChar(32)
  source          String?  @default("user") @db.VarChar(32)
  analysis_status String?  @db.VarChar(32)
  photo_angle     String?  @db.VarChar(32)
  camera_height   Int?
  ai_tags         String[]
  ai_damage       String[]
  visibleToClient Boolean  @default(false)
  Org             Org      @relation(fields: [orgId], references: [id])

  @@index([orgId, category, createdAt])
  @@index([orgId, claimId])
  @@index([orgId, leadId])
}

model finalization_statuses {
  id                     String    @id
  claim_id               String    @unique
  org_id                 String
  is_ready               Boolean   @default(false)
  is_closed              Boolean   @default(false)
  build_complete         Boolean   @default(false)
  docs_uploaded          Boolean   @default(false)
  depreciation_received  Boolean   @default(false)
  invoice_issued         Boolean   @default(false)
  supplements_complete   Boolean   @default(false)
  timeline_verified      Boolean   @default(false)
  homeowner_signed       Boolean   @default(false)
  final_packet_generated Boolean   @default(false)
  final_packet_url       String?
  homeowner_packet_url   String?
  adjuster_notified      Boolean   @default(false)
  homeowner_notified     Boolean   @default(false)
  warranty_activated     Boolean   @default(false)
  review_requested       Boolean   @default(false)
  referral_requested     Boolean   @default(false)
  maintenance_enrolled   Boolean   @default(false)
  is_archived            Boolean   @default(false)
  archived_at            DateTime?
  archive_url            String?
  ready_at               DateTime?
  closed_at              DateTime?
  notes                  String?
  created_at             DateTime  @default(now())
  updated_at             DateTime

  @@index([claim_id])
  @@index([closed_at])
  @@index([is_closed])
  @@index([is_ready])
  @@index([org_id])
}

model financial_snapshots {
  id                  String   @id
  claimId             String
  totals              Json
  depreciation        Json
  lineItems           Json
  supplements         Json
  projection          Json
  underpayment_amount Float    @default(0)
  confidence          Float    @default(0)
  created_at          DateTime @default(now())
  updated_at          DateTime
  claims              claims   @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([created_at])
}

model fundings {
  id            String   @id
  job_id        String
  payor         String
  method        String
  amount        Decimal  @db.Decimal(10, 2)
  memo          String?
  check_no      String?
  posted_date   DateTime
  attachments   Json?
  lender_status String?
  created_at    DateTime @default(now())
  updated_at    DateTime
  crm_jobs      crm_jobs @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([job_id])
  @@index([lender_status])
  @@index([payor])
  @@index([posted_date])
}

model inspections {
  id            String       @id
  orgId         String
  propertyId    String
  projectId     String?
  claimId       String?
  title         String
  type          String
  scheduledAt   DateTime
  completedAt   DateTime?
  inspectorId   String
  inspectorName String
  status        String       @default("scheduled")
  notes         String?
  photoCount    Int          @default(0)
  weatherData   Json?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime
  activities    activities[]
  ai_reports    ai_reports[]
  claims        claims?      @relation(fields: [claimId], references: [id])
  users         users        @relation(fields: [inspectorId], references: [id])
  Org           Org          @relation(fields: [orgId], references: [id])
  projects      projects?    @relation(fields: [projectId], references: [id])
  properties    properties   @relation(fields: [propertyId], references: [id])

  @@index([orgId, inspectorId])
  @@index([orgId, scheduledAt])
}

model insured_access {
  id               String    @id
  job_id           String    @unique
  org_id           String
  insured_email    String
  access_token     String    @unique
  expires_at       DateTime?
  last_accessed_at DateTime?
  enabled          Boolean   @default(true)
  metadata         Json?
  created_at       DateTime  @default(now())
  updated_at       DateTime

  @@index([access_token])
  @@index([insured_email])
  @@index([org_id])
}

model job_schedules {
  id        String   @id
  claimId   String
  date      DateTime
  crew      String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  orgId     String
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([claimId, date])
  @@index([orgId, claimId, date])
}

model job_vendors {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  vendorId       String
  claimId        String?
  jobId          String?
  orgId          String
  role           String?
  notes          String?
  attachedBy     String?
  status         String    @default("active")
  brochuresSent  Boolean?  @default(false)
  clientNotified Boolean?  @default(false)
  createdAt      DateTime? @default(now()) @db.Timestamp(6)
  updatedAt      DateTime? @default(now()) @db.Timestamp(6)
  Vendor         Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([jobId])
  @@index([orgId])
  @@index([vendorId])
}

model jobs {
  id             String       @id
  orgId          String
  propertyId     String
  claimId        String?
  title          String
  description    String?
  jobType        String
  scheduledStart DateTime?
  scheduledEnd   DateTime?
  actualStart    DateTime?
  actualEnd      DateTime?
  status         String       @default("pending")
  priority       String       @default("medium")
  foreman        String?
  crewSize       Int?
  estimatedCost  Int?
  actualCost     Int?
  materials      Json?
  equipment      Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  externalId     String?
  externalSource String?
  activities     activities[]
  claims         claims?      @relation(fields: [claimId], references: [id])
  Org            Org          @relation(fields: [orgId], references: [id])
  properties     properties   @relation(fields: [propertyId], references: [id])

  @@index([orgId, foreman])
  @@index([orgId, status])
  @@index([orgId, externalId, externalSource])
}

model leads {
  id                            String            @id
  orgId                         String
  contactId                     String
  title                         String
  description                   String?
  source                        String
  value                         Int?
  probability                   Int?
  stage                         String            @default("new")
  temperature                   String            @default("warm")
  assignedTo                    String?
  createdBy                     String?
  followUpDate                  DateTime?
  closedAt                      DateTime?
  claimId                       String?           @unique
  createdAt                     DateTime          @default(now())
  updatedAt                     DateTime
  jobCategory                   String?           @default("lead") @db.VarChar(50)
  clientId                      String?           @db.VarChar(255)
  archivedAt                    DateTime?         @db.Timestamptz(6)
  isDemo                        Boolean           @default(false)
  jobType                       String?           @db.VarChar(50)
  workType                      String?           @db.VarChar(100)
  urgency                       String?           @db.VarChar(20)
  budget                        Int?
  warmthScore                   Int?
  activities                    activities[]
  appointments                  appointments[]
  users_leads_assignedToTousers users?            @relation("leads_assignedToTousers", fields: [assignedTo], references: [id])
  claims                        claims?           @relation(fields: [claimId], references: [id])
  contacts                      contacts          @relation(fields: [contactId], references: [id])
  users_leads_createdByTousers  users?            @relation("leads_createdByTousers", fields: [createdBy], references: [id])
  Org                           Org               @relation(fields: [orgId], references: [id])
  projects                      projects?
  reports                       reports[]
  weather_reports               weather_reports[]
  externalId                    String?
  externalSource                String?

  @@index([orgId, assignedTo])
  @@index([orgId, stage])
  @@index([orgId, externalId, externalSource])
  @@index([orgId, jobCategory], map: "idx_leads_org_job_category")
  @@index([orgId, createdAt], map: "idx_leads_org_created")
}

model legal_acceptances {
  id         String   @id
  userId     String
  documentId String
  version    String
  acceptedAt DateTime @default(now()) @db.Timestamptz(6)
  ipAddress  String?
  userAgent  String?

  @@unique([userId, documentId, version])
  @@index([userId, documentId])
  @@index([userId])
}

model lender_endorsements {
  id                  String    @id
  job_id              String
  org_id              String
  lender_name         String
  requested_at        DateTime
  approved_at         DateTime?
  denied_at           DateTime?
  status              String    @default("PENDING")
  requested_amount    Float
  approved_amount     Float?
  endorsement_doc_url String?
  notes               String?
  metadata            Json?
  created_at          DateTime  @default(now())
  updated_at          DateTime

  @@index([job_id, status])
  @@index([org_id, status])
  @@index([requested_at])
}

model lender_profiles {
  id           String   @id
  org_id       String
  name         String
  contact      Json?
  mailing_addr Json?
  instructions String?
  created_at   DateTime @default(now())
  updated_at   DateTime

  @@index([name])
  @@index([org_id])
}

model maintenance_records {
  id                  String               @id
  taskId              String
  materialId          String?
  propertyProfileId   String
  orgId               String
  workPerformed       String
  serviceType         String
  vendorId            String?
  vendorName          String
  technicianName      String?
  serviceDate         DateTime
  hoursWorked         Float?
  partsUsed           Json?
  totalPartsCost      Int?
  laborCost           Int?
  totalCost           Int
  invoice             String?
  receipt             String?
  beforePhotos        Json?
  afterPhotos         Json?
  notes               String?
  warrantyMonths      Int?
  warrantyExpires     DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime
  property_materials  property_materials?  @relation(fields: [materialId], references: [id])
  Org                 Org                  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_profiles   property_profiles    @relation(fields: [propertyProfileId], references: [id], onDelete: Cascade)
  maintenance_tasks   maintenance_tasks    @relation(fields: [taskId], references: [id])
  maintenance_vendors maintenance_vendors? @relation(fields: [vendorId], references: [id])

  @@index([orgId, serviceType])
  @@index([propertyProfileId, serviceDate])
  @@index([vendorId])
}

model maintenance_schedules {
  id                    String               @id
  propertyProfileId     String
  orgId                 String
  title                 String
  description           String?
  taskType              String
  category              String
  frequency             String
  frequencyMonths       Int?
  nextDueDate           DateTime
  lastCompletedDate     DateTime?
  completionCount       Int                  @default(0)
  assignedVendorId      String?
  assignedUserId        String?
  assignedVendorName    String?
  autoGenerateWorkOrder Boolean              @default(true)
  workOrderTemplate     Json?
  reminderDaysBefore    Int                  @default(7)
  homeownerReminder     Boolean              @default(true)
  vendorReminder        Boolean              @default(true)
  status                String               @default("active")
  priority              String               @default("medium")
  estimatedCost         Int?
  createdAt             DateTime             @default(now())
  updatedAt             DateTime
  maintenance_vendors   maintenance_vendors? @relation(fields: [assignedVendorId], references: [id])
  Org                   Org                  @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_profiles     property_profiles    @relation(fields: [propertyProfileId], references: [id], onDelete: Cascade)
  maintenance_tasks     maintenance_tasks[]

  @@index([assignedVendorId])
  @@index([nextDueDate])
  @@index([orgId, status])
  @@index([propertyProfileId, nextDueDate])
}

model maintenance_tasks {
  id                     String                  @id
  scheduleId             String?
  digitalTwinId          String?
  propertyProfileId      String
  orgId                  String
  title                  String
  description            String?
  taskType               String
  category               String
  assignedVendorId       String?
  assignedUserId         String?
  assignedVendorName     String?
  scheduledDate          DateTime
  completedDate          DateTime?
  dueDate                DateTime?
  status                 String                  @default("pending")
  priority               String                  @default("medium")
  scopeOfWork            Json?
  materialList           Json?
  requireBeforePhotos    Boolean                 @default(true)
  requireAfterPhotos     Boolean                 @default(true)
  beforePhotos           Json?
  afterPhotos            Json?
  completionNotes        String?
  vendorSignature        String?
  vendorSignedAt         DateTime?
  homeownerSignature     String?
  homeownerSignedAt      DateTime?
  estimatedCost          Int?
  actualCost             Int?
  paymentStatus          String                  @default("unpaid")
  paymentReleaseDate     DateTime?
  reportGenerated        Boolean                 @default(false)
  reportUrl              String?
  reportGeneratedAt      DateTime?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  maintenance_records    maintenance_records[]
  maintenance_vendors    maintenance_vendors?    @relation(fields: [assignedVendorId], references: [id])
  property_digital_twins property_digital_twins? @relation(fields: [digitalTwinId], references: [id])
  Org                    Org                     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_profiles      property_profiles       @relation(fields: [propertyProfileId], references: [id], onDelete: Cascade)
  maintenance_schedules  maintenance_schedules?  @relation(fields: [scheduleId], references: [id])

  @@index([assignedVendorId, status])
  @@index([orgId, status])
  @@index([propertyProfileId, status])
  @@index([scheduledDate])
}

model maintenance_vendors {
  id                     String                  @id
  orgId                  String
  companyName            String
  contactName            String
  email                  String
  phone                  String
  street                 String?
  city                   String?
  state                  String?
  zipCode                String?
  serviceZipCodes        String[]                @default([])
  serviceRadius          Int?
  tradeTypes             String[]                @default([])
  licenseNumber          String?
  licenseExpires         DateTime?
  insuranceExpires       DateTime?
  bondedAmount           Int?
  rating                 Float?                  @default(0)
  completedJobs          Int                     @default(0)
  onTimePercentage       Float?                  @default(100)
  qualityScore           Float?                  @default(0)
  hourlyRate             Int?
  calloutFee             Int?
  acceptsAutoAssign      Boolean                 @default(false)
  availableDays          String[]                @default([])
  preferredSchedule      Json?
  status                 String                  @default("active")
  isPreferred            Boolean                 @default(false)
  w9Url                  String?
  certificateOfInsurance String?
  createdAt              DateTime                @default(now())
  updatedAt              DateTime
  maintenance_records    maintenance_records[]
  maintenance_schedules  maintenance_schedules[]
  maintenance_tasks      maintenance_tasks[]
  Org                    Org                     @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, rating])
  @@index([orgId, status])
  @@index([zipCode])
}

model material_cart_items {
  id             String         @id @default(dbgenerated("(gen_random_uuid())::text"))
  cartId         String
  productName    String
  sku            String?
  manufacturer   String?
  category       String?
  color          String?
  quantity       Decimal        @db.Decimal(10, 2)
  unit           String         @default("each")
  unitPrice      Decimal?       @db.Decimal(10, 2)
  lineTotal      Decimal?       @db.Decimal(10, 2)
  supplier       String?
  supplierUrl    String?
  imageUrl       String?
  specifications Json?
  notes          String?
  createdAt      DateTime?      @default(now()) @db.Timestamp(6)
  material_carts material_carts @relation(fields: [cartId], references: [id], onDelete: Cascade)

  @@index([cartId])
}

model material_carts {
  id                  String                @id @default(dbgenerated("(gen_random_uuid())::text"))
  orgId               String
  userId              String
  claimId             String?
  jobId               String?
  name                String?               @default("Untitled Cart")
  status              String                @default("open")
  supplier            String?
  metadata            Json?
  createdAt           DateTime?             @default(now()) @db.Timestamp(6)
  updatedAt           DateTime?             @default(now()) @db.Timestamp(6)
  material_cart_items material_cart_items[]

  @@index([claimId])
  @@index([orgId])
  @@index([status])
  @@index([userId])
}

model material_forensic_reports {
  id                    String   @id
  claim_id              String
  org_id                String
  created_by_id         String
  material_type         String
  property_age          Int?
  payload               Json
  overall_failure_score Int?
  primary_failure_mode  String?
  replacement_justified Boolean  @default(false)
  created_at            DateTime @default(now())
  updated_at            DateTime
  claims                claims   @relation(fields: [claim_id], references: [id], onDelete: Cascade)
  users                 users    @relation(fields: [created_by_id], references: [id])
  Org                   Org      @relation(fields: [org_id], references: [id])

  @@index([claim_id])
  @@index([org_id])
  @@index([primary_failure_mode])
}

model material_receipts {
  id              String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  orgId           String
  orderId         String?
  claimId         String?
  supplier        String
  receiptNumber   String?
  receiptUrl      String?
  purchaseDate    DateTime?
  subtotal        Decimal?  @db.Decimal(10, 2)
  tax             Decimal?  @db.Decimal(10, 2)
  total           Decimal?  @db.Decimal(10, 2)
  paymentMethod   String?
  parsedItems     Json?
  rawText         String?
  parseConfidence Decimal?  @db.Decimal(5, 4)
  eta             DateTime?
  trackingNumber  String?
  status          String    @default("pending")
  createdAt       DateTime? @default(now()) @db.Timestamp(6)
  updatedAt       DateTime? @default(now()) @db.Timestamp(6)

  @@index([claimId])
  @@index([orderId])
  @@index([orgId])
  @@index([supplier])
}

model network_comments {
  id        String   @id
  postId    String
  userId    String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     users    @relation(fields: [userId], references: [id])

  @@index([postId, createdAt])
}

model network_posts {
  id           String   @id
  orgId        String
  userId       String
  contractorId String?
  content      String
  photos       Json?
  postType     String   @default("update")
  likes        Int      @default(0)
  comments     Int      @default(0)
  shares       Int      @default(0)
  isPublic     Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime
  Org          Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)
  users        users    @relation(fields: [userId], references: [id])

  @@index([orgId, createdAt])
  @@index([postType, isPublic])
}

model ocr_records {
  id        String   @id
  claimId   String?
  text      String
  sourceUrl String?
  createdAt DateTime @default(now())
  orgId     String
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([orgId, claimId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model org_branding {
  id             String   @id
  orgId          String
  ownerId        String
  companyName    String?
  license        String?
  phone          String?
  email          String?
  website        String?
  colorPrimary   String?  @default("#117CFF")
  colorAccent    String?  @default("#FFC838")
  logoUrl        String?
  teamPhotoUrl   String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime
  tax_rate       Decimal? @default(0.00) @db.Decimal(5, 2)
  tax_enabled    Boolean? @default(false)
  business_state String?  @db.VarChar(2)

  @@unique([orgId])
  @@index([ownerId])
}

model payment_history {
  id           String   @id
  claimId      String
  amount       Float
  type         String
  date_paid    DateTime
  check_number String?
  note         String?
  created_at   DateTime @default(now())
  updated_at   DateTime
  claims       claims   @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([date_paid])
}

model payments {
  id               String    @id
  claim_id         String
  org_id           String
  type             String
  amount           Decimal   @db.Decimal(10, 2)
  check_number     String?
  reference_number String?
  payer_name       String?
  payer_type       String?
  payment_method   String?
  issued_at        DateTime?
  received_at      DateTime?
  deposited_at     DateTime?
  cleared_at       DateTime?
  status           String    @default("PENDING")
  check_image_url  String?
  deposit_slip_url String?
  confirmation_url String?
  notes            String?
  metadata         Json      @default("{}")
  detected_by      String?
  detected_at      DateTime?
  created_at       DateTime  @default(now())
  updated_at       DateTime

  @@index([claim_id])
  @@index([issued_at])
  @@index([org_id])
  @@index([received_at])
  @@index([status])
  @@index([type])
}

model permission_roles {
  id               String             @id
  name             String             @unique
  user_permissions user_permissions[]
}

model pilot_feedback {
  id           String    @id
  user_id      String
  org_id       String?
  type         String
  category     String?
  rating       Int?
  message      String
  page         String?
  screenshot   String?
  status       String    @default("new")
  response     String?
  responded_at DateTime?
  created_at   DateTime  @default(now())

  @@index([created_at(sort: Desc)])
  @@index([org_id])
  @@index([status])
  @@index([type])
  @@index([user_id])
}

model pro_engagement {
  id                  String              @id
  contractorId        String              @unique @db.Uuid
  profileViews        Int                 @default(0)
  searchAppears       Int                 @default(0)
  cardClicks          Int                 @default(0)
  saves               Int                 @default(0)
  messagesSent        Int                 @default(0)
  connectRequests     Int                 @default(0)
  engagementScore     Float               @default(0)
  lastCalculated      DateTime            @default(now()) @db.Timestamptz(6)
  createdAt           DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime            @default(now()) @db.Timestamptz(6)
  tradesCompanyMember tradesCompanyMember @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@index([engagementScore(sort: Desc)])
}

model project_bids {
  id                 String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  projectId          String          @db.Uuid
  proProfileId       String          @db.Uuid
  amount             Decimal         @db.Decimal(12, 2)
  timeline           String          @db.VarChar(100)
  message            String
  includesPermits    Boolean         @default(false)
  includesMaterials  Boolean         @default(false)
  validUntil         DateTime?       @db.Timestamptz(6)
  status             String          @default("pending") @db.VarChar(20)
  clientResponseAt   DateTime?       @db.Timestamptz(6)
  clientResponseNote String?
  createdAt          DateTime        @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime        @default(now()) @db.Timestamptz(6)
  client_projects    client_projects @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([createdAt(sort: Desc)])
  @@index([proProfileId])
  @@index([projectId])
  @@index([status])
}

model projects {
  id                               String        @id
  orgId                            String
  leadId                           String?       @unique
  propertyId                       String?
  contactId                        String?
  title                            String
  jobNumber                        String?       @unique
  status                           PipelineStage @default(LEAD)
  stage                            String        @default("Lead")
  startDate                        DateTime?
  targetEndDate                    DateTime?
  actualEndDate                    DateTime?
  createdBy                        String
  assignedTo                       String?
  valueEstimate                    Float?
  notes                            String?
  createdAt                        DateTime      @default(now())
  updatedAt                        DateTime
  archivedAt                       DateTime?     @db.Timestamptz(6)
  activities                       activities[]
  claims                           claims[]
  documents                        documents[]
  estimates                        estimates[]
  inspections                      inspections[]
  users_projects_assignedToTousers users?        @relation("projects_assignedToTousers", fields: [assignedTo], references: [id])
  contacts                         contacts?     @relation(fields: [contactId], references: [id])
  users_projects_createdByTousers  users         @relation("projects_createdByTousers", fields: [createdBy], references: [id])
  leads                            leads?        @relation(fields: [leadId], references: [id])
  Org                              Org           @relation(fields: [orgId], references: [id])
  properties                       properties?   @relation(fields: [propertyId], references: [id])
  tasks                            tasks[]

  @@index([orgId, assignedTo])
  @@index([orgId, status])
}

model properties {
  id             String        @id
  orgId          String
  contactId      String
  name           String
  propertyType   String
  street         String
  city           String
  state          String
  zipCode        String
  yearBuilt      Int?
  squareFootage  Int?
  roofType       String?
  roofAge        Int?
  carrier        String?
  policyNumber   String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime
  isDemo         Boolean       @default(false)
  externalId     String?
  externalSource String?
  claims         claims[]
  inspections    inspections[]
  jobs           jobs[]
  projects       projects[]
  contacts       contacts      @relation(fields: [contactId], references: [id])
  Org            Org           @relation(fields: [orgId], references: [id])

  @@index([orgId, zipCode])
  @@index([orgId, externalId, externalSource])
}

model property_annual_reports {
  id                    String            @id
  propertyProfileId     String
  orgId                 String
  reportYear            Int
  generatedAt           DateTime          @default(now())
  reportUrl             String?
  roofCondition         Json?
  hvacCondition         Json?
  plumbingCondition     Json?
  electricalCondition   Json?
  applianceCondition    Json?
  exteriorCondition     Json?
  interiorCondition     Json?
  maintenanceCompleted  Json?
  maintenanceMissed     Json?
  totalMaintenanceCost  Int               @default(0)
  upcomingReplacements  Json?
  totalForecastCost     Int               @default(0)
  energyScore           Int?
  energyRecommendations Json?
  potentialSavings      Int?
  hailVulnerability     Json?
  windVulnerability     Json?
  wildfireVulnerability Json?
  floodVulnerability    Json?
  seasonalThreats       Json?
  repairCostBreakdown   Json?
  executiveSummary      String?
  keyFindings           Json?
  priorityActions       Json?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime
  Org                   Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_profiles     property_profiles @relation(fields: [propertyProfileId], references: [id], onDelete: Cascade)

  @@unique([propertyProfileId, reportYear])
  @@index([orgId, reportYear])
}

model property_digital_twins {
  id                   String              @id
  propertyProfileId    String
  orgId                String
  componentType        String
  componentName        String
  expectedLifespan     Int
  currentAge           Int
  installDate          DateTime?
  conditionScore       Int                 @default(100)
  conditionGrade       String              @default("Excellent")
  replacementYear      Int?
  replacementUrgency   String?
  replacementCost      Int?
  maintenanceChecklist Json?
  riskLevel            String              @default("Low")
  riskFactors          Json?
  failureProbability   Float?
  metadata             Json?
  createdAt            DateTime            @default(now())
  updatedAt            DateTime
  maintenance_tasks    maintenance_tasks[]
  Org                  Org                 @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_profiles    property_profiles   @relation(fields: [propertyProfileId], references: [id], onDelete: Cascade)

  @@index([orgId, conditionScore])
  @@index([propertyProfileId, componentType])
  @@index([replacementYear])
  @@index([riskLevel])
}

model property_health_scores {
  id                     String            @id
  propertyProfileId      String
  orgId                  String
  overallScore           Int
  grade                  String
  ageScore               Int
  maintenanceScore       Int
  systemConditionScore   Int
  claimsHistoryScore     Int
  weatherExposureScore   Int
  structuralRiskScore    Int
  applianceHealthScore   Int
  roofIntegrityScore     Int
  hvacEfficiencyScore    Int
  plumbingConditionScore Int
  electricalSafetyScore  Int
  criticalIssues         Json?
  upcomingConcerns       Json?
  immediateActions       Json?
  plannedMaintenance     Json?
  lastPhotoUpload        DateTime?
  lastInspection         DateTime?
  lastMaintenance        DateTime?
  lastWeatherEvent       DateTime?
  previousScore          Int?
  scoreChange            Int?
  scoreChangedAt         DateTime?
  createdAt              DateTime          @default(now())
  updatedAt              DateTime
  Org                    Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_profiles      property_profiles @relation(fields: [propertyProfileId], references: [id], onDelete: Cascade)

  @@index([orgId, overallScore])
  @@index([propertyProfileId, updatedAt])
}

model property_impacts {
  id                      String        @id
  orgId                   String
  stormEventId            String
  address                 String
  city                    String
  state                   String
  zipCode                 String
  lat                     Decimal       @db.Decimal(10, 7)
  lng                     Decimal       @db.Decimal(10, 7)
  ownerName               String?
  ownerPhone              String?
  ownerEmail              String?
  roofAge                 Int?
  roofType                String?
  squareFootage           Int?
  stories                 Int?
  riskLevel               String
  damageProba             Int
  estimatedDamageSeverity Int
  hailSizeAtLocation      Decimal?      @db.Decimal(4, 2)
  windSpeedAtLocation     Int?
  aiDamageEstimate        String
  recommendedAction       String
  priorityScore           Int
  impactPacketGenerated   Boolean       @default(false)
  impactPacketUrl         String?
  inspectionSheetUrl      String?
  contactAttempted        Boolean       @default(false)
  contactSuccessful       Boolean       @default(false)
  appointmentScheduled    Boolean       @default(false)
  claimSigned             Boolean       @default(false)
  claimId                 String?       @unique
  canvassingRouteId       String?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime
  door_knocks             door_knocks[]
  claims                  claims?       @relation(fields: [claimId], references: [id])
  Org                     Org           @relation(fields: [orgId], references: [id], onDelete: Cascade)
  storm_events            storm_events  @relation(fields: [stormEventId], references: [id], onDelete: Cascade)

  @@index([riskLevel, priorityScore])
  @@index([stormEventId, riskLevel])
  @@index([zipCode])
}

model property_inspections {
  id                String            @id
  propertyProfileId String
  orgId             String
  userId            String
  inspectionType    String
  inspectionDate    DateTime          @default(now())
  componentType     String?
  componentName     String?
  issuesDetected    Json?
  leaksDetected     Int               @default(0)
  damageDetected    Int               @default(0)
  cracksDetected    Int               @default(0)
  rustDetected      Int               @default(0)
  hazardsDetected   Int               @default(0)
  photos            Json?
  photoCount        Int               @default(0)
  overallCondition  String?
  conditionScore    Int?
  aiSummary         String?
  aiRecommendations Json?
  repairCostLow     Int?
  repairCostAvg     Int?
  repairCostHigh    Int?
  urgency           String?
  inspectorNotes    String?
  reportGenerated   Boolean           @default(false)
  reportUrl         String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  Org               Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_profiles property_profiles @relation(fields: [propertyProfileId], references: [id], onDelete: Cascade)
  users             users             @relation(fields: [userId], references: [id])

  @@index([orgId, inspectionType])
  @@index([propertyProfileId, inspectionDate])
  @@index([userId])
}

model property_materials {
  id                  String                @id
  propertyProfileId   String
  orgId               String
  category            String
  subCategory         String?
  itemName            String
  manufacturer        String?
  model               String?
  serialNumber        String?
  installDate         DateTime?
  installCost         Int?
  installedBy         String?
  warrantyYears       Int?
  warrantyExpires     DateTime?
  expectedLifespan    Int?
  replacementDate     DateTime?
  currentCondition    String?
  lastServiceDate     DateTime?
  lastServiceType     String?
  nextServiceDue      DateTime?
  receiptUrl          String?
  manualUrl           String?
  warrantyDocUrl      String?
  photos              Json?
  replacementCostLow  Int?
  replacementCostAvg  Int?
  replacementCostHigh Int?
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  maintenance_records maintenance_records[]
  Org                 Org                   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  property_profiles   property_profiles     @relation(fields: [propertyProfileId], references: [id], onDelete: Cascade)

  @@index([nextServiceDue])
  @@index([orgId, category])
  @@index([propertyProfileId, category])
  @@index([warrantyExpires])
}

model property_profiles {
  id                      String                    @id
  propertyId              String                    @unique
  orgId                   String
  fullAddress             String
  streetAddress           String
  city                    String
  state                   String
  zipCode                 String
  county                  String?
  latitude                Float?
  longitude               Float?
  squareFootage           Int?
  lotSize                 Int?
  yearBuilt               Int?
  numBedrooms             Int?
  numBathrooms            Float?
  numStories              Int?
  garageSpaces            Int?
  roofType                String?
  roofAge                 Int?
  roofSquares             Float?
  roofPitch               String?
  roofColor               String?
  lastRoofReplacement     DateTime?
  roofWarrantyExpires     DateTime?
  hvacType                String?
  hvacAge                 Int?
  hvacManufacturer        String?
  hvacModel               String?
  hvacTonnage             Float?
  lastHvacService         DateTime?
  hvacWarrantyExpires     DateTime?
  waterHeaterType         String?
  waterHeaterAge          Int?
  waterHeaterGallons      Int?
  waterHeaterFuel         String?
  lastWaterHeaterService  DateTime?
  plumbingType            String?
  plumbingAge             Int?
  sewerType               String?
  waterSource             String?
  electricalPanelType     String?
  electricalPanelAge      Int?
  wiringType              String?
  hasGeneratorHookup      Boolean                   @default(false)
  hasSmartHome            Boolean                   @default(false)
  permitCount             Int                       @default(0)
  lastPermitDate          DateTime?
  permitHistory           Json?
  hailRiskScore           Int?
  windRiskScore           Int?
  wildfireRiskScore       Int?
  floodZone               String?
  earthquakeZone          String?
  tornadoRiskScore        Int?
  insuranceRiskScore      Int?
  premiumTier             String?
  insulationRating        String?
  windowType              String?
  hasLowEWindows          Boolean                   @default(false)
  hasSolarPanels          Boolean                   @default(false)
  solarInstallDate        DateTime?
  foundationType          String?
  foundationAge           Int?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  maintenance_records     maintenance_records[]
  maintenance_schedules   maintenance_schedules[]
  maintenance_tasks       maintenance_tasks[]
  property_annual_reports property_annual_reports[]
  property_digital_twins  property_digital_twins[]
  property_health_scores  property_health_scores[]
  property_inspections    property_inspections[]
  property_materials      property_materials[]
  Org                     Org                       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([insuranceRiskScore])
  @@index([orgId, yearBuilt])
  @@index([orgId, zipCode])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model proposal_drafts {
  id             String           @id
  org_id         String
  user_id        String
  lead_id        String
  job_id         String
  packet_type    String
  context_json   Json
  ai_summary     String?
  ai_scope       String?
  ai_terms       String?
  ai_notes       String?
  status         String           @default("draft")
  template       String?
  created_at     DateTime         @default(now()) @db.Timestamptz(6)
  updated_at     DateTime         @default(now()) @db.Timestamptz(6)
  proposal_files proposal_files[]

  @@index([job_id], map: "idx_proposal_drafts_job_id")
  @@index([lead_id], map: "idx_proposal_drafts_lead_id")
  @@index([org_id], map: "idx_proposal_drafts_org_id")
  @@index([packet_type], map: "idx_proposal_drafts_packet_type")
  @@index([status], map: "idx_proposal_drafts_status")
  @@index([user_id], map: "idx_proposal_drafts_user_id")
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model proposal_files {
  id              String          @id
  proposal_id     String
  kind            String
  url             String
  pages           Int?
  file_size       Int?
  created_at      DateTime        @default(now()) @db.Timestamptz(6)
  proposal_drafts proposal_drafts @relation(fields: [proposal_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([kind], map: "idx_proposal_files_kind")
  @@index([proposal_id], map: "idx_proposal_files_proposal_id")
}

model public_leads {
  id                  String              @id
  contractorId        String
  formId              String?
  name                String
  email               String?
  phone               String?
  address             String?
  city                String?
  state               String?
  zipCode             String?
  serviceType         String?
  emergencyType       String?
  hasInsurance        Boolean             @default(false)
  dateOfLoss          DateTime?
  preferredDate       DateTime?
  details             Json
  photos              Json?
  videos              Json?
  status              String              @default("NEW")
  priority            String              @default("normal")
  source              String              @default("trades-network")
  ipAddress           String?
  userAgent           String?
  referrer            String?
  convertedToClaim    Boolean             @default(false)
  claimId             String?
  aiSummary           String?
  aiCategory          String?
  aiUrgency           String?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  customerId          String?
  propertyId          String?
  aiConfidence        Float?
  aiFlags             Json?
  aiImages            Json?
  aiJobType           String?
  aiMaterials         Json?
  aiNextActions       Json?
  aiSummaryJson       Json?
  aiUrgencyScore      Int?
  contractor_profiles contractor_profiles @relation(fields: [contractorId], references: [id], onDelete: Cascade)
  contractor_forms    contractor_forms?   @relation(fields: [formId], references: [id])
  reviews             reviews?

  @@index([contractorId, status])
  @@index([createdAt])
  @@index([zipCode, serviceType])
}

model public_users {
  id         String   @id
  sessionId  String   @unique
  ipAddress  String?
  location   String?
  device     String?
  browser    String?
  searches   Json?
  viewed     Json?
  createdAt  DateTime @default(now())
  lastSeenAt DateTime @default(now())

  @@index([sessionId])
}

model quick_dols {
  propertyId       String   @id
  recommendedDate  String?
  confidence       Float?
  reason           String?
  eventCount       Int      @default(0)
  topHailInches    Float?
  topDistanceMiles Float?
  lastUpdated      DateTime @default(now())
  createdAt        DateTime @default(now())

  @@index([lastUpdated], map: "quick_dols_lastupdated_idx")
}

model reconciliations {
  id         String   @id
  job_id     String
  snapshot   Json
  created_at DateTime @default(now())
  crm_jobs   crm_jobs @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([created_at])
  @@index([job_id])
}

model referral_rewards {
  id              String   @id
  org_id          String
  type            String
  months_awarded  Int?
  tokens_awarded  Int?
  source_referral String?
  created_at      DateTime @default(now())

  @@index([org_id])
}

model referrals {
  id             String   @id
  org_id         String
  ref_code       String   @unique
  invited_email  String?
  invitee_org_id String?
  status         String   @default("invited")
  created_at     DateTime @default(now())
  updated_at     DateTime

  @@index([org_id, status])
}

model repair_cost_data {
  id                  String   @id
  category            String
  itemType            String
  repairType          String
  materialCostLow     Int
  materialCostAvg     Int
  materialCostHigh    Int
  laborCostLow        Int
  laborCostAvg        Int
  laborCostHigh       Int
  zipCode             String?
  region              String?
  locationMultiplier  Float    @default(1.0)
  difficultyLevel     String
  estimatedHours      Float
  requiredPermits     Boolean  @default(false)
  diyFriendly         Boolean  @default(false)
  diyDifficulty       String?
  diyEstimatedHours   Float?
  seasonalMultiplier  Float?   @default(1.0)
  emergencyMultiplier Float?   @default(1.5)
  dataSource          String?
  lastUpdated         DateTime @default(now())
  createdAt           DateTime @default(now())
  updatedAt           DateTime

  @@index([category, itemType])
  @@index([zipCode, itemType])
}

model report_ai_sections {
  id          String   @id
  report_id   String
  section_key String
  state       Json
  created_at  DateTime @default(now())
  updated_at  DateTime

  @@unique([report_id, section_key])
  @@index([report_id])
}

model report_drafts {
  id            String   @id
  report_id     String   @unique
  user_id       String
  org_id        String
  section_order Json?
  draft_state   Json?
  last_autosave DateTime
  created_at    DateTime @default(now())
  updated_at    DateTime

  @@index([last_autosave])
  @@index([report_id])
  @@index([user_id])
}

model report_templates {
  id              String   @id
  org_id          String
  name            String
  section_order   Json
  section_enabled Json
  defaults        Json?
  created_by      String
  is_default      Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime

  @@index([created_by])
  @@index([is_default])
  @@index([org_id])
}

model reports {
  id                 String              @id
  orgId              String?
  claimId            String?
  leadId             String?
  createdById        String
  createdAt          DateTime            @default(now())
  updatedAt          DateTime
  type               String
  title              String
  subtitle           String?
  lossType           String?
  dol                DateTime?
  address            String?
  damageAssessmentId String?
  weatherReportId    String?
  estimateId         String?
  supplementId       String?
  sections           Json?
  summary            Json?
  meta               Json?
  pdfUrl             String?
  claims             claims?             @relation(fields: [claimId], references: [id], onDelete: Cascade)
  users              users               @relation(fields: [createdById], references: [id])
  damage_assessments damage_assessments? @relation(fields: [damageAssessmentId], references: [id])
  estimates          estimates?          @relation(fields: [estimateId], references: [id])
  leads              leads?              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  supplements        supplements?        @relation(fields: [supplementId], references: [id])
  weather_reports    weather_reports?    @relation(fields: [weatherReportId], references: [id])

  @@index([claimId])
  @@index([createdAt])
  @@index([createdById])
  @@index([leadId])
  @@index([type])
}

model reviews {
  id                  String              @id
  contractorProfileId String
  userId              String
  publicLeadId        String?             @unique
  rating              Int
  content             String
  photos              String[]            @default([])
  status              ReviewStatus        @default(PENDING)
  response            String?
  respondedAt         DateTime?
  createdAt           DateTime            @default(now())
  updatedAt           DateTime
  contractor_profiles contractor_profiles @relation(fields: [contractorProfileId], references: [id], onDelete: Cascade)
  public_leads        public_leads?       @relation(fields: [publicLeadId], references: [id])

  @@index([contractorProfileId])
  @@index([createdAt])
  @@index([status])
  @@index([userId])
}

model scope_areas {
  id          String        @id
  scope_id    String
  name        String
  type        String?
  trade_hint  String?
  description String?
  sort_order  Int           @default(0)
  created_at  DateTime      @default(now())
  updated_at  DateTime
  scopes      scopes        @relation(fields: [scope_id], references: [id], onDelete: Cascade)
  scope_items scope_items[]

  @@index([scope_id])
}

model scope_items {
  id                      String      @id
  scope_area_id           String
  code                    String?
  description             String
  trade                   String?
  unit                    String?
  quantity                Float?
  category                String?
  source_text             String?
  source_meta             Json?
  is_demolition           Boolean     @default(false)
  is_install              Boolean     @default(false)
  is_repair               Boolean     @default(false)
  is_code_required        Boolean     @default(false)
  is_supplement_candidate Boolean     @default(false)
  included                Boolean     @default(true)
  sort_order              Int         @default(0)
  created_at              DateTime    @default(now())
  updated_at              DateTime
  scope_areas             scope_areas @relation(fields: [scope_area_id], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([scope_area_id])
  @@index([trade])
}

model scopes {
  id          String        @id
  org_id      String
  claim_id    String?
  lead_id     String?
  project_id  String?
  title       String
  source_type String
  loss_type   String?
  dol         DateTime?
  confidence  Float         @default(0.0)
  raw_sources Json?
  issues      Json?
  notes       String?
  status      String        @default("draft")
  created_at  DateTime      @default(now())
  updated_at  DateTime
  scope_areas scope_areas[]
  claims      claims?       @relation(fields: [claim_id], references: [id], onDelete: Cascade)

  @@index([claim_id])
  @@index([lead_id])
  @@index([org_id])
  @@index([status])
}

model storm_events {
  id                          String              @id
  orgId                       String
  eventType                   String
  severity                    Int
  noaaEventId                 String?
  nwsAlertId                  String?
  centerLat                   Decimal             @db.Decimal(10, 7)
  centerLng                   Decimal             @db.Decimal(10, 7)
  radiusMiles                 Decimal             @db.Decimal(5, 2)
  affectedZipCodes            Json
  affectedCities              Json
  hailSizeMin                 Decimal?            @db.Decimal(4, 2)
  hailSizeMax                 Decimal?            @db.Decimal(4, 2)
  hailSizeAvg                 Decimal?            @db.Decimal(4, 2)
  windSpeedMax                Int?
  tornadoRating               String?
  rainfallInches              Decimal?            @db.Decimal(5, 2)
  lightningStrikes            Int?
  detectedAt                  DateTime            @default(now())
  stormStartTime              DateTime
  stormEndTime                DateTime?
  duration                    Int?
  estimatedPropertiesImpacted Int                 @default(0)
  highRiskProperties          Int                 @default(0)
  mediumRiskProperties        Int                 @default(0)
  lowRiskProperties           Int                 @default(0)
  impactSummary               String
  damageProjection            String
  deploymentRecommendation    String
  aiConfidence                Int
  status                      String              @default("DETECTED")
  responseActivated           Boolean             @default(false)
  responseActivatedAt         DateTime?
  responseActivatedBy         String?
  radarImageUrl               String?
  weatherReportUrl            String?
  noaaReportUrl               String?
  metadata                    Json?
  createdAt                   DateTime            @default(now())
  updatedAt                   DateTime
  canvassing_routes           canvassing_routes[]
  claims                      claims[]
  property_impacts            property_impacts[]
  Org                         Org                 @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([eventType])
  @@index([orgId, detectedAt])
  @@index([status])
}

model storm_records {
  id        String   @id
  address   String
  type      String
  date      DateTime
  severity  String?
  rawData   Json?
  createdAt DateTime @default(now())
  orgId     String
  Org       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([address, date])
  @@index([orgId, address, date])
}

model supplement_items {
  id             String      @id
  supplement_id  String
  claim_id       String?
  name           String
  code           String
  description    String?
  category       String?
  qty            Float       @default(1)
  quantity_new   Float?
  unit           String      @default("EA")
  price_cents    Int?
  unit_price     Float?
  total          Float?
  justification  String?
  code_reference String?
  manufacturer   String?
  source         String?     @default("ai")
  confidence     Float?
  status         String      @default("pending")
  selected       Boolean     @default(true)
  created_at     DateTime    @default(now())
  updated_at     DateTime
  claims         claims?     @relation(fields: [claim_id], references: [id], onDelete: Cascade)
  supplements    supplements @relation(fields: [supplement_id], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([claim_id])
  @@index([status])
  @@index([supplement_id])
}

model supplement_line_items {
  id                    String              @id
  supplement_request_id String
  claim_id              String
  item_code             String?
  description           String
  category              String?
  quantity              Decimal             @db.Decimal(10, 2)
  unit                  String
  unit_cost             Decimal             @db.Decimal(10, 2)
  total_cost            Decimal             @db.Decimal(10, 2)
  reason                String
  code_citations        Json                @default("[]")
  photo_proof           Json                @default("[]")
  detected_by           String              @default("ai")
  confidence_score      Decimal?            @db.Decimal(5, 4)
  severity              String?
  status                String              @default("pending")
  approved_quantity     Decimal?            @db.Decimal(10, 2)
  approved_amount       Decimal?            @db.Decimal(10, 2)
  denial_reason         String?
  created_at            DateTime            @default(now())
  updated_at            DateTime
  supplement_requests   supplement_requests @relation(fields: [supplement_request_id], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([claim_id])
  @@index([status])
  @@index([supplement_request_id])
}

model supplement_photos {
  id             String      @id
  supplement_id  String
  url            String
  caption        String?
  damage_type    String?
  detected_items Json?
  created_at     DateTime    @default(now())
  supplements    supplements @relation(fields: [supplement_id], references: [id], onDelete: Cascade)

  @@index([supplement_id])
}

model supplement_requests {
  id                    String                  @id
  claim_id              String
  org_id                String
  timeline_id           String?
  financial_snapshot_id String?
  supplement            Json                    @default("{}")
  packet                Json                    @default("{}")
  supplement_number     String?
  supplement_date       DateTime?               @default(now()) @db.Date
  total_added_rcv       Decimal?                @db.Decimal(10, 2)
  total_items_count     Int                     @default(0)
  status                String                  @default("DRAFT")
  sent_at               DateTime?
  sent_to               String?
  reviewed_at           DateTime?
  approved_at           DateTime?
  denied_at             DateTime?
  approved_amount       Decimal?                @db.Decimal(10, 2)
  denial_reason         String?
  adjuster_notes        String?
  pdf_url               String?
  pdf_generated_at      DateTime?
  email_sent            Boolean                 @default(false)
  email_sent_at         DateTime?
  created_at            DateTime                @default(now())
  updated_at            DateTime
  deleted_at            DateTime?
  supplement_line_items supplement_line_items[]
  completion_timeline   completion_timeline?    @relation(fields: [timeline_id], references: [id])

  @@unique([org_id, supplement_number])
  @@index([claim_id])
  @@index([org_id])
  @@index([sent_at])
  @@index([status])
  @@index([timeline_id])
}

model supplements {
  id                String              @id
  job_id            String?
  status            String              @default("DRAFT")
  ai_detected_items Int                 @default(0)
  scope_items       Json?
  notes             String?
  submitted_at      DateTime?
  approved_at       DateTime?
  created_at        DateTime            @default(now())
  updated_at        DateTime
  adjuster_name     String?
  auto_detected     Json?
  carrier           String?
  carrier_pdf_url   String?
  claim_id          String?
  claim_number      String?
  created_by        String
  date_of_loss      DateTime?           @db.Date
  hover_data        Json?
  internal_notes    String?
  lead_id           String?
  loss_type         String?
  op_amount         Float?              @default(0)
  op_percent        Float?
  op_type           String?
  org_id            String
  policy_number     String?
  profit_percent    Float?
  scope_pdf_url     String?
  subtotal          Float?              @default(0)
  tax               Float?              @default(0)
  tax_rate          Float?
  total             Float?              @default(0)
  reports           reports[]
  supplement_items  supplement_items[]
  supplement_photos supplement_photos[]
  claims            claims?             @relation(fields: [claim_id], references: [id], onDelete: Cascade)
  crm_jobs          crm_jobs?           @relation(fields: [job_id], references: [id], onDelete: Cascade)
  Org               Org                 @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@index([claim_id])
  @@index([created_by])
  @@index([job_id])
  @@index([lead_id])
  @@index([org_id])
  @@index([status])
}

model supplier_connectors {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  vendorId    String?
  orgId       String
  supplier    String
  authType    String    @default("api_key")
  credentials Json?
  isActive    Boolean?  @default(true)
  lastSyncAt  DateTime?
  syncStatus  String?   @default("idle")
  config      Json?
  createdAt   DateTime? @default(now()) @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @db.Timestamp(6)
  Vendor      Vendor?   @relation(fields: [vendorId], references: [id])

  @@unique([orgId, supplier])
  @@index([orgId])
  @@index([supplier])
}

model system_health {
  id        String   @id
  component String
  status    String
  message   String?
  createdAt DateTime @default(now())

  @@index([component, createdAt])
}

model tasks {
  id           String       @id
  orgId        String
  projectId    String?
  assigneeId   String?
  title        String
  description  String?
  type         String?
  dueAt        DateTime?
  completedAt  DateTime?
  status       TaskStatus   @default(TODO)
  priority     TaskPriority @default(MEDIUM)
  contactId    String?
  leadId       String?
  claimId      String?
  inspectionId String?
  notes        String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime
  users        users?       @relation(fields: [assigneeId], references: [id])
  Org          Org          @relation(fields: [orgId], references: [id])
  projects     projects?    @relation(fields: [projectId], references: [id])

  @@index([orgId, assigneeId])
  @@index([orgId, dueAt])
  @@index([orgId, status])
}

model team_performance {
  id                        String   @id
  orgId                     String
  userId                    String
  stormEventId              String?
  periodStart               DateTime
  periodEnd                 DateTime
  doorsKnocked              Int      @default(0)
  contactsMade              Int      @default(0)
  appointmentsBooked        Int      @default(0)
  inspectionsCompleted      Int      @default(0)
  claimsSigned              Int      @default(0)
  claimsApproved            Int      @default(0)
  totalRevenueGenerated     Decimal  @default(0) @db.Decimal(10, 2)
  totalInvoiced             Decimal  @default(0) @db.Decimal(10, 2)
  totalDepreciationReleased Decimal  @default(0) @db.Decimal(10, 2)
  commissionOwed            Decimal  @default(0) @db.Decimal(10, 2)
  commissionPaid            Decimal  @default(0) @db.Decimal(10, 2)
  commissionPending         Decimal  @default(0) @db.Decimal(10, 2)
  contactRate               Decimal  @default(0) @db.Decimal(5, 2)
  appointmentRate           Decimal  @default(0) @db.Decimal(5, 2)
  closeRate                 Decimal  @default(0) @db.Decimal(5, 2)
  approvalRate              Decimal  @default(0) @db.Decimal(5, 2)
  rankDoorsKnocked          Int?
  rankClaimsSigned          Int?
  rankRevenue               Int?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime
  Org                       Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId, userId])
  @@index([periodStart, periodEnd])
  @@index([stormEventId])
}

model tool_usage {
  id      String   @id
  userId  String
  orgId   String
  toolKey String
  usedAt  DateTime @default(now())

  @@index([orgId, toolKey, usedAt])
  @@index([userId, toolKey, usedAt])
}

model trade_reviews {
  id                  String              @id
  contractorId        String              @db.Uuid
  clientId            String
  rating              Int
  title               String?
  comment             String
  jobType             String?
  projectCost         String?
  verified            Boolean             @default(false)
  status              String              @default("published")
  helpful             Int                 @default(0)
  proResponse         String?
  respondedAt         DateTime?           @db.Timestamptz(6)
  importSource        String?
  externalId          String?
  createdAt           DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime            @default(now()) @db.Timestamptz(6)
  Client              Client              @relation(fields: [clientId], references: [id], onDelete: Cascade)
  tradesCompanyMember tradesCompanyMember @relation(fields: [contractorId], references: [id], onDelete: Cascade)

  @@unique([contractorId, clientId])
  @@unique([importSource, externalId])
  @@index([clientId])
  @@index([contractorId])
  @@index([rating])
  @@index([status])
}

model tradesCompany {
  id                  String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId               String?
  name                String
  slug                String                @unique
  email               String?
  phone               String?
  website             String?
  description         String?
  logo                String?
  coverimage          String?
  address             String?
  city                String?
  state               String?
  zip                 String?
  lat                 String?
  lng                 String?
  specialties         String[]
  serviceArea         String[]
  yearsInBusiness     Int?
  licenseNumber       String?
  insuranceVerified   Boolean?              @default(false)
  rating              Decimal?              @db.Decimal(3, 2)
  reviewCount         Int?                  @default(0)
  isVerified          Boolean?              @default(false)
  isActive            Boolean?              @default(true)
  createdAt           DateTime?             @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime?             @default(now()) @db.Timestamptz(6)
  ClientJob           ClientJob[]
  ClientProConnection ClientProConnection[]
  ClientSavedPro      ClientSavedPro[]
  ClientWorkRequest   ClientWorkRequest[]
  members             tradesCompanyMember[]
  tradesPost          tradesPost[]
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model tradesCompanyMember {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId                String              @unique
  companyId             String?             @db.Uuid
  role                  String?             @default("member")
  title                 String?
  isOwner               Boolean?            @default(false)
  isActive              Boolean?            @default(true)
  createdAt             DateTime?           @default(now()) @db.Timestamptz(6)
  updatedAt             DateTime?           @default(now()) @db.Timestamptz(6)
  pendingCompanyToken   String?
  orgId                 String?
  firstName             String?
  lastName              String?
  email                 String?
  phone                 String?
  jobTitle              String?
  tradeType             String?
  bio                   String?
  avatar                String?
  workHistory           String?
  skills                String[]            @default([])
  certifications        String[]            @default([])
  specialties           String[]            @default([])
  lookingFor            String[]            @default([])
  yearsExperience       Int?
  profilePhoto          String?
  isAdmin               Boolean?            @default(false)
  canEditCompany        Boolean?            @default(false)
  status                String?             @default("active")
  onboardingStep        String?             @default("profile")
  companyName           String?
  companyEmail          String?
  companyWebsite        String?
  companyLicense        String?
  coverPhoto            String?
  serviceArea           String?
  city                  String?
  state                 String?
  zip                   String?
  officePhone           String?
  mobilePhone           String?
  hoursOfOperation      Json?               @default("{}")
  rocNumber             String?
  rocExpiration         DateTime?           @db.Date
  licenseNumber         String?
  licenseState          String?
  businessEntityType    String?
  isBonded              Boolean?            @default(false)
  isInsured             Boolean?            @default(false)
  insuranceProvider     String?
  insuranceExpiration   DateTime?           @db.Date
  insurancePolicyNumber String?
  bondAmount            String?
  bondExpiration        DateTime?           @db.Date
  additionalNotes       String?
  coverageTypes         String[]            @default([])
  socialLinks           Json?               @default("{}")
  paymentMethods        String[]            @default([])
  languages             String[]            @default(["English"])
  emergencyAvailable    Boolean?            @default(false)
  freeEstimates         Boolean?            @default(true)
  warrantyInfo          String?
  aboutCompany          String?
  tagline               String?
  foundedYear           Int?
  teamSize              String?
  portfolioImages       String[]            @default([])
  lastSeenAt            DateTime?           @default(now()) @db.Timestamptz(6)
  customStatus          String?
  statusEmoji           String?
  ClientJob             ClientJob[]
  ClientJobResponse     ClientJobResponse[]
  pro_engagement        pro_engagement?
  reviews               trade_reviews[]
  company               tradesCompany?      @relation(fields: [companyId], references: [id], onDelete: SetNull, onUpdate: NoAction)

  @@index([companyId], map: "idx_trades_member_company")
  @@index([companyName], map: "idx_trades_member_company_name")
  @@index([orgId], map: "idx_trades_member_orgid")
  @@index([status], map: "idx_trades_member_status")
  @@index([userId], map: "idx_trades_member_user")
}

model tradesConnection {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  requesterId String
  addresseeId String
  status      String    @default("pending")
  message     String?
  connectedAt DateTime? @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([requesterId, addresseeId])
  @@index([addresseeId])
  @@index([requesterId])
  @@index([status])
}

model tradesFeaturedWork {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String
  title       String
  description String?
  imageUrl    String
  projectDate DateTime? @db.Timestamptz(6)
  category    String?
  isFeatured  Boolean   @default(true)
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([isFeatured])
  @@index([userId])
}

model tradesGroup {
  id                String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String
  slug              String              @unique
  description       String?
  coverImage        String?
  iconImage         String?
  category          String?
  privacy           String              @default("public")
  rules             String?
  memberCount       Int                 @default(0)
  postCount         Int                 @default(0)
  isActive          Boolean             @default(true)
  createdById       String
  createdAt         DateTime            @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime            @default(now()) @db.Timestamptz(6)
  tradesGroupMember tradesGroupMember[]
  tradesGroupPost   tradesGroupPost[]

  @@index([category])
  @@index([createdById])
  @@index([privacy])
}

model tradesGroupMember {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId     String      @db.Uuid
  userId      String
  role        String      @default("member")
  status      String      @default("active")
  joinedAt    DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime    @default(now()) @db.Timestamptz(6)
  tradesGroup tradesGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@unique([groupId, userId])
  @@index([groupId])
  @@index([role])
  @@index([userId])
}

model tradesGroupPost {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  groupId     String      @db.Uuid
  authorId    String
  content     String
  images      String[]    @default([])
  isPinned    Boolean     @default(false)
  isActive    Boolean     @default(true)
  likeCount   Int         @default(0)
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime    @default(now()) @db.Timestamptz(6)
  tradesGroup tradesGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([groupId])
  @@index([isPinned])
}

model tradesPost {
  id            String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  companyId     String?        @db.Uuid
  authorId      String
  title         String
  content       String?
  images        String[]
  tags          String[]
  postType      String?        @default("update")
  isActive      Boolean?       @default(true)
  createdAt     DateTime?      @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime?      @default(now()) @db.Timestamptz(6)
  tradesCompany tradesCompany? @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([authorId], map: "idx_trades_post_author")
  @@index([companyId], map: "idx_trades_post_company")
}

model trades_feed_engagement {
  id           String   @id
  post_id      String
  user_id      String
  liked        Boolean  @default(false)
  comment_text String?
  created_at   DateTime @default(now())
  updated_at   DateTime

  @@unique([post_id, user_id])
  @@index([post_id])
  @@index([user_id])
}

model user_email_preferences {
  id             String    @id
  userId         String    @unique
  email          String
  marketingOptIn Boolean   @default(false)
  productUpdates Boolean   @default(true)
  securityAlerts Boolean   @default(true)
  weeklyDigest   Boolean   @default(false)
  partnerOffers  Boolean   @default(false)
  unsubscribedAt DateTime? @db.Timestamptz(6)
  optInTimestamp DateTime? @db.Timestamptz(6)
  optInSource    String?
  createdAt      DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt      DateTime  @default(now()) @db.Timestamptz(6)

  @@index([email])
}

model user_organizations {
  id             String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  userId         String
  organizationId String
  role           String
  createdAt      DateTime @default(now())
  Org            Org      @relation(fields: [organizationId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_user_organizations_org")

  @@unique([userId, organizationId], map: "user_organizations_userId_orgId_key")
  @@index([organizationId], map: "idx_user_organizations_org_id")
  @@index([userId], map: "idx_user_organizations_user_id")
  @@index([organizationId], map: "user_organizations_orgId_idx")
  @@index([userId])
}

model user_permissions {
  id               String           @id
  userId           String
  roleId           String
  permission_roles permission_roles @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@index([userId])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model user_registry {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clerkUserId        String    @unique
  userType           String
  createdAt          DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime  @default(now()) @db.Timestamptz(6)
  proProfileId       String?   @db.Uuid
  clientProfileId    String?   @db.Uuid
  orgId              String?
  displayName        String?
  email              String?
  avatarUrl          String?
  isActive           Boolean   @default(true)
  lastSeenAt         DateTime? @db.Timestamptz(6)
  onboardingComplete Boolean   @default(false)
  primaryEmail       String?

  @@index([clerkUserId])
  @@index([clerkUserId, userType, isActive])
  @@index([isActive])
  @@index([orgId])
  @@index([userType])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model users {
  id                                            String                      @id
  clerkUserId                                   String                      @unique
  email                                         String                      @unique
  name                                          String?
  role                                          Role                        @default(USER)
  orgId                                         String
  createdAt                                     DateTime                    @default(now())
  lastSeenAt                                    DateTime                    @default(now())
  headshot_url                                  String?
  ClaimMessage                                  ClaimMessage[]
  CrewSchedule                                  CrewSchedule[]
  claim_activities                              claim_activities[]
  claim_tasks_claim_tasks_assigned_to_idTousers claim_tasks[]               @relation("claim_tasks_assigned_to_idTousers")
  claim_tasks_claim_tasks_created_by_idTousers  claim_tasks[]               @relation("claim_tasks_created_by_idTousers")
  claim_timeline_events                         claim_timeline_events[]
  claims                                        claims[]
  estimates                                     estimates[]
  inspections                                   inspections[]
  leads_leads_assignedToTousers                 leads[]                     @relation("leads_assignedToTousers")
  leads_leads_createdByTousers                  leads[]                     @relation("leads_createdByTousers")
  material_forensic_reports                     material_forensic_reports[]
  network_comments                              network_comments[]
  network_posts                                 network_posts[]
  projects_projects_assignedToTousers           projects[]                  @relation("projects_assignedToTousers")
  projects_projects_createdByTousers            projects[]                  @relation("projects_createdByTousers")
  property_inspections                          property_inspections[]
  reports                                       reports[]
  tasks                                         tasks[]
  Org                                           Org                         @relation(fields: [orgId], references: [id])
  weather_reports                               weather_reports[]

  @@index([orgId, role])
}

model vendor_assets {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  vendorId    String
  type        String
  title       String
  description String?
  jobUseCase  String?
  pdfUrl      String
  fileSize    String?
  tradeType   String?
  isActive    Boolean?  @default(true)
  downloads   Int?      @default(0)
  createdAt   DateTime? @default(now()) @db.Timestamp(6)
  updatedAt   DateTime? @default(now()) @db.Timestamp(6)
  Vendor      Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([tradeType])
  @@index([type])
  @@index([vendorId])
}

model vendor_products_v2 {
  id              String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  vendorId        String
  tradeType       String
  sku             String?
  name            String
  category        String?
  subcategory     String?
  manufacturer    String?
  description     String?
  brochureUrl     String?
  specSheetUrl    String?
  warrantyUrl     String?
  msdsUrl         String?
  codeApprovalUrl String?
  dataSheetUrl    String?
  imageUrl        String?
  priceRangeLow   Decimal?  @db.Decimal(10, 2)
  priceRangeHigh  Decimal?  @db.Decimal(10, 2)
  unit            String?   @default("each")
  inStock         Boolean?  @default(true)
  leadTimeDays    Int?
  features        String[]  @default([])
  tags            String[]  @default([])
  isActive        Boolean?  @default(true)
  createdAt       DateTime? @default(now()) @db.Timestamp(6)
  updatedAt       DateTime? @default(now()) @db.Timestamp(6)
  Vendor          Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([isActive])
  @@index([manufacturer])
  @@index([tradeType])
  @@index([vendorId])
}

model vendor_programs {
  id             String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  vendorId       String
  programType    String
  name           String
  description    String?
  eligibility    String?
  amount         Decimal?  @db.Decimal(10, 2)
  percentOff     Decimal?  @db.Decimal(5, 2)
  validFrom      DateTime?
  validTo        DateTime?
  applicationUrl String?
  terms          String?
  isActive       Boolean?  @default(true)
  createdAt      DateTime? @default(now()) @db.Timestamp(6)
  updatedAt      DateTime? @default(now()) @db.Timestamp(6)
  Vendor         Vendor    @relation(fields: [vendorId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([programType])
  @@index([vendorId])
}

model vendor_workflow_events {
  id          String    @id @default(dbgenerated("(gen_random_uuid())::text"))
  orgId       String
  eventType   String
  entityType  String
  entityId    String
  claimId     String?
  jobId       String?
  payload     Json?
  processed   Boolean   @default(false)
  processedAt DateTime?
  createdAt   DateTime? @default(now()) @db.Timestamp(6)

  @@index([claimId])
  @@index([entityType, entityId])
  @@index([eventType])
  @@index([orgId])
  @@index([processed])
}

model vendors {
  id            String   @id
  org_id        String?
  name          String
  type          String
  service_types String[]
  region        String?
  website       String?
  contact_email String?
  contact_phone String?
  logo_url      String?
  description   String?
  created_at    DateTime @default(now())
  updated_at    DateTime

  @@index([region])
  @@index([type])
}

model weather_daily_snapshots {
  id           String   @id
  propertyId   String
  snapshotDate DateTime @default(now())
  scoredJson   Json
  dolJson      Json
  createdAt    DateTime @default(now())

  @@index([propertyId, snapshotDate], map: "weather_daily_snapshots_propertyid_snapshotdate_idx")
}

model weather_documents {
  id          String   @id
  propertyId  String
  orgId       String
  kind        String
  pdfUrl      String
  summaryText String?
  aiModelUsed String?
  eventCount  Int      @default(0)
  dolDate     String?
  createdAt   DateTime @default(now())

  @@index([kind])
  @@index([orgId], map: "weather_documents_orgid_idx")
  @@index([propertyId], map: "weather_documents_propertyid_idx")
}

model weather_events {
  id            String   @id
  propertyId    String
  source        String
  type          String
  timeUtc       DateTime
  magnitude     Float?
  distanceMiles Float?
  geometryJson  String
  metadataJson  Json?
  createdAt     DateTime @default(now())

  @@index([propertyId, timeUtc], map: "weather_events_propertyid_timeutc_idx")
  @@index([source, type])
}

model weather_reports {
  id                String    @id
  claimId           String?
  leadId            String?
  createdById       String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  mode              String
  address           String
  lat               Float?
  lng               Float?
  lossType          String?
  dol               DateTime?
  periodFrom        DateTime?
  periodTo          DateTime?
  primaryPeril      String?
  overallAssessment String?
  confidence        Float?
  candidateDates    Json?
  events            Json?
  globalSummary     Json?
  providerRaw       Json?
  reports           reports[]
  claims            claims?   @relation(fields: [claimId], references: [id], onDelete: Cascade)
  users             users     @relation(fields: [createdById], references: [id])
  leads             leads?    @relation(fields: [leadId], references: [id], onDelete: Cascade)

  @@index([claimId])
  @@index([createdById])
  @@index([dol])
  @@index([leadId])
  @@index([mode])
}

model webhook_subscriptions {
  id             String    @id
  org_id         String
  url            String
  events         Json
  secret         String
  enabled        Boolean   @default(true)
  failed_count   Int       @default(0)
  last_failed_at DateTime?
  created_at     DateTime  @default(now())
  updated_at     DateTime

  @@index([org_id, enabled])
}

// ============================================================================
// NEW MODELS â€” Sprint cleanup (auto-generated from TODO audit)
// ============================================================================

/// Notifications for trades professionals (messages, claims, connections)
model TradeNotification {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  recipientId String // Clerk userId or orgId of the recipient
  type        String // e.g. "new_message", "connection_accepted", "claim_update"
  title       String
  message     String?
  actionUrl   String?
  metadata    Json?     @default("{}")
  isRead      Boolean   @default(false)
  readAt      DateTime?
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([recipientId, isRead])
  @@index([recipientId, createdAt(sort: Desc)])
  @@index([type])
}

/// Notifications for client portal users
model ClientNotification {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  clientId  String
  type      String // e.g. "claim_accepted", "new_message", "report_ready"
  title     String
  message   String?
  actionUrl String?
  metadata  Json?     @default("{}")
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now()) @db.Timestamptz(6)

  @@index([clientId, isRead])
  @@index([clientId, createdAt(sort: Desc)])
  @@index([type])
}

/// Links trade partners to claims for assignment & collaboration
model ClaimTradePartner {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  claimId       String
  companyId     String    @db.Uuid
  role          String    @default("subcontractor") // "lead", "subcontractor", "inspector"
  status        String    @default("assigned") // "assigned", "accepted", "declined", "completed"
  assignedBy    String?
  assignedAt    DateTime  @default(now()) @db.Timestamptz(6)
  acceptedAt    DateTime?
  completedAt   DateTime?
  notes         String?
  estimatedCost Int? // cents
  actualCost    Int? // cents
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt     DateTime  @default(now()) @db.Timestamptz(6)

  @@unique([claimId, companyId])
  @@index([claimId])
  @@index([companyId])
  @@index([status])
}

/// Comments on files shared via the client portal
model ClaimFileComment {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  fileId     String // ID of the file_assets record
  claimId    String
  authorId   String // Clerk userId
  authorType String   @default("contractor") // "contractor", "client"
  body       String
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @db.Timestamptz(6)

  @@index([fileId])
  @@index([claimId])
  @@index([authorId])
}

/// Approval workflow for claim decisions
model ClaimApproval {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  claimId     String
  orgId       String
  type        String    @default("supplement") // "supplement", "change_order", "final_payment"
  status      String    @default("pending") // "pending", "approved", "denied"
  requestedBy String
  reviewedBy  String?
  requestedAt DateTime  @default(now()) @db.Timestamptz(6)
  reviewedAt  DateTime?
  amount      Int? // cents
  notes       String?
  metadata    Json?     @default("{}")
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([claimId])
  @@index([orgId, status])
  @@index([status])
}

/// AI-generated artifacts (reports, documents, etc.)
model GeneratedArtifact {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId      String
  claimId    String?
  type       String // "report", "packet", "summary", "letter"
  title      String
  content    String?  @db.Text
  fileUrl    String?
  model      String? // AI model used
  promptHash String?
  tokensUsed Int?
  status     String   @default("completed") // "generating", "completed", "failed"
  metadata   Json?    @default("{}")
  createdAt  DateTime @default(now()) @db.Timestamptz(6)
  updatedAt  DateTime @default(now()) @db.Timestamptz(6)

  @@index([orgId, type])
  @@index([claimId])
  @@index([createdAt(sort: Desc)])
}

/// Batch job processing (proposals, exports, etc.)
model BatchJob {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String
  type        String // "batch_proposal", "batch_export", "batch_email"
  status      String    @default("queued") // "queued", "processing", "completed", "failed"
  totalItems  Int       @default(0)
  processed   Int       @default(0)
  failed      Int       @default(0)
  inputData   Json?
  outputData  Json?
  error       String?
  startedAt   DateTime?
  completedAt DateTime?
  createdBy   String
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([orgId, status])
  @@index([type])
  @@index([createdAt(sort: Desc)])
}

/// Email delivery tracking logs
model EmailLog {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orgId       String?
  toEmail     String
  fromEmail   String?
  subject     String
  templateId  String? // Which email template was used
  status      String    @default("sent") // "queued", "sent", "delivered", "bounced", "failed"
  resendId    String? // Resend message ID for tracking
  claimId     String?
  reportId    String?
  metadata    Json?     @default("{}")
  error       String?
  sentAt      DateTime  @default(now()) @db.Timestamptz(6)
  deliveredAt DateTime?
  openedAt    DateTime?
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([orgId, createdAt(sort: Desc)])
  @@index([toEmail])
  @@index([status])
  @@index([claimId])
}

/// Email send queue for retry logic
model EmailQueue {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  toEmail      String
  subject      String
  htmlBody     String?   @db.Text
  template     String?
  templateData Json?     @default("{}")
  status       String    @default("pending") // "pending", "processing", "sent", "failed"
  attempts     Int       @default(0)
  maxAttempts  Int       @default(3)
  lastError    String?
  scheduledAt  DateTime  @default(now()) @db.Timestamptz(6)
  processedAt  DateTime?
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)

  @@index([status, scheduledAt])
  @@index([createdAt(sort: Desc)])
}

/// Onboarding invite tokens for new companies
model TradesOnboardingInvite {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  token       String    @unique
  email       String
  companyName String?
  invitedBy   String? // userId of person who created the invite
  status      String    @default("pending") // "pending", "accepted", "expired"
  acceptedAt  DateTime?
  expiresAt   DateTime?
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)

  @@index([email])
  @@index([status])
}

enum AgentActionType {
  OCR_DOCUMENT
  EXTRACT_SCOPE
  BUILD_PACKET
  REQUEST_APPROVAL
  SEND_EMAIL
  FILE_DEPRECIATION
  SUBMIT_SUPPLEMENT
  UPLOAD_TO_PORTAL
  PARSE_CARRIER_RESPONSE
  AUTO_FOLLOWUP
  ESCALATE
  RECONCILE_PAYMENT
  DETECT_MISSING_DOCS
}

enum AgentTaskStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
  AWAITING_APPROVAL
  SKIPPED
}

enum AppealStatus {
  DRAFT
  SUBMITTED
  PENDING_RESPONSE
  APPROVED
  DENIED
  ESCALATED
}

enum CarrierInboxStatus {
  UNREAD
  PROCESSED
  IGNORED
  ACTION_REQUIRED
}

enum ClaimActivityType {
  STATUS_CHANGE
  NOTE
  FILE_UPLOAD
  MESSAGE
  PAYMENT
  SUPPLEMENT
}

enum ClaimLifecycleStage {
  FILED
  ADJUSTER_REVIEW
  APPROVED
  DENIED
  APPEAL
  BUILD
  COMPLETED
  DEPRECIATION
}

enum DocumentType {
  PHOTO
  PDF
  REPORT
  AGREEMENT
  INVOICE
  WEATHER_VERIFICATION
  OTHER
}

enum EmailFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  DIGEST_ONLY
}

enum EmailSubscriptionStatus {
  PENDING
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
}

enum EstimateStatus {
  DRAFT
  SENT
  ACCEPTED
  REJECTED
  EXPIRED
}

enum MissionStatus {
  QUEUED
  RUNNING
  SUCCESS
  FAILED
  AWAITING_APPROVAL
  CANCELLED
}

enum PaymentType {
  ACV
  RCV
  SUPPLEMENT
}

enum PipelineStage {
  LEAD
  QUALIFIED
  INSPECTION_SCHEDULED
  INSPECTED
  ESTIMATE_SENT
  INSURANCE_CLAIM
  APPROVED
  PRODUCTION
  FINAL_QA
  INVOICED
  PAID
  WARRANTY
  ARCHIVED
}

enum ReviewStatus {
  PENDING
  PUBLISHED
  FLAGGED
}

enum Role {
  ADMIN
  MANAGER
  PM
  INSPECTOR
  BILLING
  VENDOR
  USER
}

enum SupplementStatus {
  REQUESTED
  APPROVED
  DENIED
  DISPUTED
  DRAFT
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
  CANCELLED
}

enum UserRole {
  ADMIN
  CONTRACTOR
  ADJUSTER
  LENDER
  INSURED
  AGENT
  AUDITOR
}

enum VideoReportType {
  CLAIM
  RETAIL
}

// â”€â”€â”€ SMS Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model sms_messages {
  id         String   @id
  orgId      String
  contactId  String?
  direction  String // "inbound" | "outbound"
  from       String
  to         String
  body       String
  externalId String? // Twilio MessageSid
  status     String   @default("sent") // sent | received | failed | mock
  sentBy     String? // userId who sent (for outbound)
  createdAt  DateTime @default(now())
  updatedAt  DateTime

  contacts contacts? @relation(fields: [contactId], references: [id])
  Org      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, contactId])
  @@index([orgId, createdAt])
  @@index([contactId, createdAt])
}

// â”€â”€â”€ Customer Payments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model customer_payments {
  id              String    @id
  orgId           String
  jobId           String
  invoiceId       String?
  amountCents     Int
  description     String
  customerEmail   String?
  customerName    String?
  status          String    @default("pending") // pending | paid | failed | refunded
  provider        String    @default("stripe") // stripe | manual
  stripeSessionId String?
  stripePaymentId String?
  paymentUrl      String?
  paidAt          DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime

  crm_jobs crm_jobs @relation(fields: [jobId], references: [id], onDelete: Cascade)
  Org      Org      @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, status])
  @@index([jobId])
  @@index([stripeSessionId])
}

// â”€â”€â”€ Permits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model permits {
  id              String    @id
  orgId           String
  jobId           String?
  claimId         String?
  propertyId      String?
  permitNumber    String
  permitType      String // building | roofing | electrical | plumbing | mechanical | demolition | other
  jurisdiction    String? // city/county issuing the permit
  status          String    @default("applied") // applied | approved | issued | inspection_scheduled | passed | failed | expired
  appliedAt       DateTime  @default(now())
  approvedAt      DateTime?
  issuedAt        DateTime?
  expiresAt       DateTime?
  inspectionDate  DateTime?
  inspectionNotes String?
  fee             Decimal?  @db.Decimal(10, 2)
  notes           String?
  documentUrl     String?
  createdBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime

  crm_jobs crm_jobs? @relation(fields: [jobId], references: [id])
  claims   claims?   @relation(fields: [claimId], references: [id])
  Org      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, status])
  @@index([jobId])
  @@index([claimId])
  @@index([permitNumber])
}

// â”€â”€â”€ Mortgage Check Tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
model mortgage_checks {
  id            String    @id
  orgId         String
  claimId       String
  jobId         String?
  checkNumber   String?
  amount        Decimal   @db.Decimal(10, 2)
  lender        String // mortgage company name
  status        String    @default("pending") // pending | received | endorsed | deposited | cleared | returned
  expectedDate  DateTime?
  receivedDate  DateTime?
  endorsedDate  DateTime?
  depositedDate DateTime?
  clearedDate   DateTime?
  notes         String?
  createdBy     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime

  claims   claims    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  crm_jobs crm_jobs? @relation(fields: [jobId], references: [id])
  Org      Org       @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId, status])
  @@index([claimId])
  @@index([jobId])
}

// ============================================================================
// Enterprise Commission Engine
// ============================================================================

model commission_plans {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  org_id      String
  name        String
  description String?
  is_active   Boolean  @default(true)
  is_default  Boolean  @default(false)
  rule_type   String   @default("percentage_revenue")
  structure   Json     @default("{}")
  applies_to  String   @default("all")
  user_ids    String[] @default([])
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  Org                Org                  @relation(fields: [org_id], references: [id], onDelete: Cascade)
  commission_records commission_records[]

  @@index([org_id])
  @@index([org_id, is_active])
}

model job_financials {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  org_id             String
  job_id             String    @unique
  contract_amount    Decimal   @default(0) @db.Decimal(12, 2)
  supplement_amount  Decimal   @default(0) @db.Decimal(12, 2)
  total_revenue      Decimal?  @db.Decimal(12, 2)
  material_cost      Decimal   @default(0) @db.Decimal(12, 2)
  labor_cost         Decimal   @default(0) @db.Decimal(12, 2)
  overhead_cost      Decimal   @default(0) @db.Decimal(12, 2)
  other_cost         Decimal   @default(0) @db.Decimal(12, 2)
  total_cost         Decimal?  @db.Decimal(12, 2)
  gross_profit       Decimal?  @db.Decimal(12, 2)
  amount_invoiced    Decimal   @default(0) @db.Decimal(12, 2)
  amount_collected   Decimal   @default(0) @db.Decimal(12, 2)
  amount_outstanding Decimal?  @db.Decimal(12, 2)
  financial_status   String    @default("open")
  qb_invoice_id      String?
  qb_synced_at       DateTime?
  notes              String?
  created_at         DateTime  @default(now())
  updated_at         DateTime  @updatedAt

  Org      Org      @relation(fields: [org_id], references: [id], onDelete: Cascade)
  crm_jobs crm_jobs @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@index([org_id])
  @@index([org_id, financial_status])
}

model commission_records {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  org_id            String
  user_id           String
  job_id            String
  plan_id           String?   @db.Uuid
  rule_type         String
  base_amount       Decimal   @default(0) @db.Decimal(12, 2)
  commission_amount Decimal   @default(0) @db.Decimal(12, 2)
  calculation       Json      @default("{}")
  status            String    @default("pending")
  approved_by       String?
  approved_at       DateTime?
  paid_at           DateTime?
  payment_ref       String?
  notes             String?
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  Org              Org               @relation(fields: [org_id], references: [id], onDelete: Cascade)
  crm_jobs         crm_jobs          @relation(fields: [job_id], references: [id], onDelete: Cascade)
  commission_plans commission_plans? @relation(fields: [plan_id], references: [id], onDelete: SetNull)

  @@index([org_id])
  @@index([org_id, user_id])
  @@index([job_id])
  @@index([org_id, status])
}

model quickbooks_connections {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  org_id        String    @unique
  realm_id      String
  access_token  String
  refresh_token String
  token_expires DateTime
  company_name  String?
  is_active     Boolean   @default(true)
  last_sync_at  DateTime?
  sync_errors   Json?     @default("[]")
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  Org Org @relation(fields: [org_id], references: [id], onDelete: Cascade)
}

/// Measurement orders placed through GAF QuickMeasure, EagleView, or manual upload
model measurement_orders {
  id               String  @id @default(uuid())
  org_id           String
  claim_id         String?
  job_id           String?
  property_address String
  city             String?
  state            String?
  zip              String?

  /// Provider: gaf | eagleview | manual
  provider   String @default("gaf")
  /// Order type: roof | siding | gutters | full
  order_type String @default("roof")
  /// Status: pending | processing | completed | failed | cancelled
  status     String @default("pending")

  /// URL to the completed measurement report PDF
  report_url   String?
  /// Structured measurement data returned by the provider
  measurements Json?   @default("{}")
  /// Provider-specific order reference ID
  external_id  String?

  ordered_by     String
  ordered_at     DateTime  @default(now())
  completed_at   DateTime?
  failed_at      DateTime?
  failure_reason String?

  /// Arbitrary metadata (provider response, webhook payloads, etc.)
  metadata   Json?    @default("{}")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  Org Org @relation(fields: [org_id], references: [id], onDelete: Cascade)

  @@index([org_id])
  @@index([claim_id])
  @@index([job_id])
  @@index([status])
  @@index([provider])
}

// ---------------------------------------------------------------------------
// CRM Migration Tracking
// ---------------------------------------------------------------------------

/// Tracks a full CRM migration run (AccuLynx, JobNimbus, CSV, etc.)
model migration_jobs {
  id              String    @id @default(dbgenerated("gen_random_uuid()::text"))
  orgId           String
  userId          String
  source          String // "acculynx" | "jobnimbus" | "csv"
  status          String    @default("pending") // pending | running | completed | failed | rolled_back
  totalRecords    Int       @default(0)
  importedRecords Int       @default(0)
  skippedRecords  Int       @default(0)
  errorRecords    Int       @default(0)
  stats           Json?     @default("{}")
  errors          Json?     @default("[]")
  config          Json? // encrypted api key, filters, options
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  Org   Org               @relation(fields: [orgId], references: [id], onDelete: Cascade)
  items migration_items[]

  @@index([orgId, source])
  @@index([status])
}

/// Tracks each individual record within a migration run
model migration_items {
  id           String   @id @default(dbgenerated("gen_random_uuid()::text"))
  migrationId  String
  entityType   String // "contact" | "property" | "lead" | "job" | "claim" | "document"
  externalId   String
  internalId   String? // SkaiScraper record ID after import
  status       String   @default("pending") // pending | imported | skipped | error | rolled_back
  errorMessage String?
  rawData      Json? // Original source record for debugging
  createdAt    DateTime @default(now())

  migration migration_jobs @relation(fields: [migrationId], references: [id], onDelete: Cascade)

  @@unique([migrationId, entityType, externalId])
  @@index([migrationId, entityType])
  @@index([externalId])
}
