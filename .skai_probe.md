# SkaiScraper Structure Probe

_Generated: Thu Nov 6 13:42:07 PST 2025_

- ripgrep (rg): no
- fd: no

## Next.js Routes (App Router)

### Page routes

```
/(app)/[...slug]
/(app)/account/billing
/(app)/admin/referrals
/(app)/ai
/(app)/ai-insights
/(app)/ai-suite
/(app)/ai/damage-builder
/(app)/ai/dol
/(app)/ai/exports
/(app)/ai/mockup
/(app)/ai/mockup/history
/(app)/ai/weather
/(app)/billing
/(app)/carrier/export
/(app)/contracts
/(app)/crm
/(app)/crm/pipelines
/(app)/dashboard
/(app)/dashboard/proposals/new
/(app)/debug
/(app)/directory/vendors
/(app)/directory/vendors/[vendorId]
/(app)/evidence
/(app)/governance
/(app)/governance/rules
/(app)/jobs
/(app)/jobs/[id]
/(app)/leads
/(app)/leads/[id]
/(app)/leads/new
/(app)/leads/pipeline
/(app)/map
/(app)/network/contractors
/(app)/network/contractors/[contractorId]
/(app)/report-workbench
/(app)/reports
/(app)/reports/builder
/(app)/reports/new
/(app)/settings
/(app)/settings/branding
/(app)/settings/referrals
/(app)/settings/team
/(app)/teams
/(app)/tools/ai-suite
/(app)/trial/ended
/(auth)/after-sign-in
/(marketing)
/(marketing)/contact
/(marketing)/features
/(marketing)/feedback
/(marketing)/legal/privacy
/(marketing)/legal/terms
/(marketing)/pricing
/(marketing)/pricing/topup
/_archived-routes/auth-test
/_archived-routes/billing-old
/_archived-routes/clerk-check
/_archived-routes/clerk-debug
/_archived-routes/contacts
/_archived-routes/env-check
/_archived-routes/pipeline
/_archived-routes/tasks
/_archived-routes/test-clerk
/_archived-routes/test-retail-packet
/about
/admin
/admin/logs
/admin/metrics
/admin/tokens
/admin/vendor-connect
/annotation
/branding
/case-study
/claims/generate
/claims/reports
/claims/wizard
/code-dol
/demo
/dev/email-preview
/network/inbox
/network/opportunities
/network/opportunity/new
/network/thread/[id]
/proposal/print
/r/[code]
/report-builder-demo
/reports/[id]
/reports/quick-pdf
/retail/generate
/retail/projects
/showcase
/sign-in/[[...sign-in]]
/sign-up/[[...sign-up]]
/success
/templates/designer
/trades
/trades-network
/vendors
/vendors/[slug]
```

### API routes

```
/api/admin/force-open
/api/admin/launch-status
/api/admin/metrics
/api/admin/tokens
/api/admin/tokens/refill
/api/admin/tokens/reset
/api/admin/tokens/simulate-reset
/api/admin/wallet
/api/ai/chat
/api/ai/damage
/api/ai/damage-builder
/api/ai/inspect
/api/billing/auto-refill
/api/billing/checkout
/api/billing/full-access/checkout
/api/billing/full-access/status
/api/billing/info
/api/billing/portal
/api/billing/stripe/webhook
/api/billing/token-pack/checkout
/api/billing/tokens/checkout
/api/branding
/api/branding/save
/api/branding/setup
/api/branding/status
/api/branding/upload
/api/branding/upsert
/api/checkout
/api/checkout/token-pack
/api/claims/generate-packet
/api/claims/list
/api/claims/resume
/api/claims/save
/api/claims/start
/api/config
/api/crm/claims
/api/crm/leads
/api/cron/email-retry
/api/cron/stripe-reconcile
/api/cron/trials/sweep
/api/dev/send-email
/api/dev/throw
/api/dol-check
/api/dol-pull
/api/export/pdf
/api/feedback
/api/files
/api/files/[id]/readUrl
/api/files/[id]/url
/api/generate-mockup
/api/generate-pdf
/api/generate-test-docx
/api/health
/api/health/env
/api/health/live
/api/health/ready
/api/health/storage
/api/health/summary
/api/leads
/api/me/init
/api/notifications
/api/org/plan
/api/org/tokens
/api/pipeline
/api/pipelines/summary
/api/preview/pdf
/api/project/materials/add
/api/projects
/api/projects/[id]
/api/proposals/[id]
/api/proposals/[id]/publish
/api/proposals/build
/api/proposals/health
/api/proposals/render
/api/public/reports/[id]/accept
/api/public/reports/[id]/decline
/api/quota/status
/api/referral/invite
/api/referral/link
/api/reports
/api/reports/[id]
/api/reports/[id]/regenerate-links
/api/reports/[id]/resend
/api/reports/[id]/save
/api/reports/[id]/send
/api/reports/email
/api/reports/generate
/api/reports/list
/api/reports/quick
/api/retail/list
/api/retail/resume
/api/retail/save
/api/retail/start
/api/status
/api/stripe/checkout
/api/stripe/checkout/topup
/api/stripe/ensure-customer
/api/stripe/webhook
/api/tasks
/api/team/posts
/api/telemetry/wizard-complete
/api/test-email
/api/test-rate-limit
/api/tokens
/api/tokens/balance
/api/tokens/buy
/api/tokens/consume
/api/tokens/purchase
/api/tokens/status
/api/trades/apply
/api/trades/cancel-subscription
/api/trades/inbox
/api/trades/membership
/api/trades/opportunities
/api/trades/send-message
/api/trades/subscribe
/api/trades/thread/[id]
/api/trial/status
/api/uploads
/api/verify-session
/api/wallet/balance
/api/wallet/check
/api/wallet/reset-monthly
/api/wallet/spend
/api/wallet/topup
/api/weather/cron-daily
/api/weather/quick-dol
/api/weather/verify
/api/webhooks/clerk
/api/webhooks/stripe
/api/wizard/save
```

## Critical Paths (existence)

✗ src/app/reports/new/page.tsx
✗ src/app/ai/mockup/page.tsx
✗ src/app/carrier/export/page.tsx
✗ src/app/reports/\_components/card-registry.tsx
✗ src/app/reports/\_components/layout.config.ts
✗ src/app/reports/\_components/cards/ClaimDetailsCard.tsx
✗ src/app/api/reports/[id]/claim-details/route.ts
✗ src/app/(app)/reports/[id]/page.tsx
✓ middleware.ts

_⚠ Missing (create or adjust paths):_
src/app/reports/new/page.tsx
src/app/ai/mockup/page.tsx
src/app/carrier/export/page.tsx
src/app/reports/\_components/card-registry.tsx
src/app/reports/\_components/layout.config.ts
src/app/reports/\_components/cards/ClaimDetailsCard.tsx
src/app/api/reports/[id]/claim-details/route.ts
src/app/(app)/reports/[id]/page.tsx

## Dashboard Buttons (href targets)

```
No matches found
```

## Auth Middleware Snapshot

```ts
import { clerkMiddleware, createRouteMatcher } from "@clerk/nextjs/server";
import { NextResponse } from "next/server";
import type { NextRequest } from "next/server";
import { checkTrialAccess } from "./lib/billing/trials";
import { auth } from "@clerk/nextjs/server";

// Safe rate limiting (never throws)
const rateLimiters = new Map<string, { count: number; resetAt: number }>();

async function safeRateLimit(
  identifier: string,
  limit: number,
  windowMs: number
): Promise<boolean> {
  try {
    // Try Upstash Redis if configured
    if (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN) {
      const url = process.env.UPSTASH_REDIS_REST_URL;
      const token = process.env.UPSTASH_REDIS_REST_TOKEN;
      const key = `ratelimit:${identifier}`;

      const response = await fetch(`${url}/incr/${key}`, {
        headers: { Authorization: `Bearer ${token}` },
      });

      if (response.ok) {
        const data = await response.json();
        const count = data.result;

        if (count === 1) {
          await fetch(`${url}/pexpire/${key}/${windowMs}`, {
            headers: { Authorization: `Bearer ${token}` },
          });
        }

        return count <= limit;
      }
    }
  } catch (error) {
    console.error("Rate limit error (non-blocking):", error);
  }

  // In-memory fallback
  const now = Date.now();
  const entry = rateLimiters.get(identifier);

  if (!entry || now > entry.resetAt) {
    rateLimiters.set(identifier, { count: 1, resetAt: now + windowMs });
    return true;
  }

  if (entry.count < limit) {
    entry.count++;
    return true;
  }

  return false;
}

// Public routes (no auth required)
const isPublicRoute = createRouteMatcher([
  "/",
  "/features",
  "/pricing",
  "/pricing/topup",
  "/about",
  "/contact",
  "/demo",
  "/showcase",
  "/ai-suite",
  "/trades",
  "/trades-network",
  "/case-study",
  "/sign-in(.*)",
  "/sign-up(.*)",
  "/after-sign-in",
  "/clerk-check(.*)",
  "/env-check(.*)",
  "/api/health(.*)",
  "/api/webhooks(.*)",
  "/api/cron(.*)",
  "/api/config",
  "/robots.txt",
  "/sitemap(.*)",
  "/legal(.*)",
  "/feedback",
]);

// Routes that should bypass trial lock (allow access even if trial ended)
const bypassTrialLock = createRouteMatcher([
  "/trial/ended",
  "/pricing(.*)",
  "/account/billing(.*)",
  "/legal(.*)",
  "/feedback",
  "/api/billing(.*)",
  "/api/stripe(.*)",
  "/sign-out(.*)",
]);

export default clerkMiddleware(async (auth, req) => {
  try {
    const pathname = req.nextUrl.pathname;

    // Skip middleware for static files and health checks (fast path)
    if (
      pathname.startsWith("/_next") ||
      pathname.startsWith("/api/health") ||
      pathname.match(/\.(ico|png|jpg|jpeg|svg|css|js|woff|woff2)$/)
    ) {
      return NextResponse.next();
    }

    // Rate limiting for expensive API routes
    if (pathname.startsWith("/api/generate-pdf") || pathname.startsWith("/api/ai/")) {
      const { userId } = auth();
      const identifier = userId || req.ip || req.headers.get("x-forwarded-for") || "anonymous";

      const allowed = await safeRateLimit(identifier, 10, 60000);
      if (!allowed) {
        return NextResponse.json(
          { error: "Too many requests. Please try again later." },
          {
            status: 429,
            headers: {
              "X-RateLimit-Limit": "10",
              "X-RateLimit-Window": "60s",
              "Retry-After": "60",
            },
          }
        );
      }
    }

    const res = NextResponse.next();

    // Security headers
    res.headers.set("Strict-Transport-Security", "max-age=63072000; includeSubDomains; preload");
    res.headers.set("X-Content-Type-Options", "nosniff");
    res.headers.set("X-Frame-Options", "DENY");
    res.headers.set("X-XSS-Protection", "1; mode=block");
    res.headers.set("Referrer-Policy", "strict-origin-when-cross-origin");
    res.headers.set("Permissions-Policy", "geolocation=(), microphone=(), camera=()");

    // CSP with safe fallback
    try {
      const nonce = Buffer.from(crypto.randomUUID()).toString("base64");
      const cspHeader = [
        "default-src 'self'",
        `script-src 'self' 'nonce-${nonce}' 'unsafe-inline' 'unsafe-eval' https://challenges.cloudflare.com https://*.clerk.accounts.dev`,
        "style-src 'self' 'unsafe-inline'",
        "img-src 'self' blob: data: https:",
        "font-src 'self' data:",
        "connect-src 'self' https:",
        "frame-src 'self' https://*.clerk.accounts.dev https://challenges.cloudflare.com",
        "frame-ancestors 'self'",
        "base-uri 'self'",
        "form-action 'self'",
        "object-src 'none'",
        "worker-src 'self' blob:",
      ].join("; ");

      res.headers.set("Content-Security-Policy", cspHeader);
      res.headers.set("X-Nonce", nonce);
    } catch (cspError) {
      console.error("CSP error (non-blocking):", cspError);
    }

    // Secure cookies
    const setCookieHeader = res.headers.get("set-cookie");
    if (setCookieHeader) {
      const secureCookie = setCookieHeader
        .split(", ")
        .map((cookie) => {
          if (!cookie.includes("Secure")) cookie += "; Secure";
          if (!cookie.includes("HttpOnly")) cookie += "; HttpOnly";
          if (!cookie.includes("SameSite")) cookie += "; SameSite=Lax";
          return cookie;
        })
        .join(", ");
      res.headers.set("set-cookie", secureCookie);
    }

    // Legacy redirects
    if (pathname === "/billing-new") {
      return NextResponse.redirect(new URL("/billing", req.url));
    }

    // Auth protection for non-public routes
    if (!isPublicRoute(req)) {
      const { userId, orgId, sessionClaims } = auth();
      if (!userId) {
        const signInUrl = new URL("/sign-in", req.url);
        signInUrl.searchParams.set("redirect_url", pathname);
        return NextResponse.redirect(signInUrl);
      }

      // Admin-only route protection
      if (pathname.startsWith("/admin")) {
        const isAdmin = (sessionClaims?.publicMetadata as any)?.role === "admin";
```

## Report Builder Grid Renderer (first 250 lines)

```

```

## Card Registry & Layout Config

_File not found: src/app/reports/\_components/card-registry.tsx_

_File not found: src/app/reports/\_components/layout.config.ts_

## Export Panel Component (search hits)

```
No matches
```

## Claims Wizard & Quick PDF

### Claims Wizard hits

```
No matches
```

### Quick PDF hits

```
No matches
```

## Database: reports columns & type distribution

_DATABASE_URL not set in this shell. Open your Vercel env or .env.local to run the psql snippet above._

## Local Route Smoke Commands

```bash
curl -I http://localhost:3000/reports/new
curl -I http://localhost:3000/ai/mockup
curl -I http://localhost:3000/carrier/export
```
