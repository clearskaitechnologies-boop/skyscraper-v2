# ğŸ—ï¸ Phase 2: Report Builder â€” CompanyCam-Inspired Project Management

## ğŸ“‹ Overview

**Status:** Scaffolding Complete âœ… | Implementation In Progress â³

Phase 2 transforms SkaiScraper from a simple form-based claims generator into a full-featured project management system inspired by CompanyCam's workflow efficiency, but with AI-powered intelligence and zero third-party dependencies.

## ğŸ¯ Goals

### What We're Building

- **CompanyCam-style UI**: Left sidebar navigation, photo organization, drag-and-drop reports
- **AI-Powered Intelligence**: Auto-caption photos, detect damage types, generate full reports
- **Dual-Template System**: Insurance claims + Retail proposals in one unified system
- **Xactimate Integration**: Export scopes directly to Xactimate XML format
- **Weather Intelligence**: Auto-pull NWS bulletins, hail size, wind speed by DOL
- **Code Compliance**: Auto-apply IBC/IRC/ARMA/NRCA references based on roof type + damage

### What We're NOT Building

- âŒ Third-party integrations (CompanyCam, Hover, EagleView)
- âŒ Manual photo captioning (AI-only)
- âŒ Static reports (everything is dynamic + editable)

## ğŸ—‚ï¸ Project Structure

```
src/features/report-builder/
â”œâ”€â”€ types.ts                    âœ… Complete
â”œâ”€â”€ ai-actions.ts               âœ… Stubs created
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SidebarNav.tsx          âœ… Complete
â”‚   â”œâ”€â”€ AIActionsBar.tsx        âœ… Complete
â”‚   â”œâ”€â”€ SectionList.tsx         âœ… Complete
â”‚   â”œâ”€â”€ SectionEditor.tsx       â³ TODO
â”‚   â”œâ”€â”€ PhotoTray.tsx           â³ TODO
â”‚   â””â”€â”€ ReportExporter.tsx      â³ TODO
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useProject.ts           â³ TODO
â”‚   â”œâ”€â”€ usePhotos.ts            â³ TODO
â”‚   â””â”€â”€ useReports.ts           â³ TODO
â””â”€â”€ api/
    â”œâ”€â”€ projects.ts             â³ TODO
    â”œâ”€â”€ photos.ts               â³ TODO
    â””â”€â”€ reports.ts              â³ TODO

db/migrations/
â””â”€â”€ 20251104_report_builder_schema.sql  âœ… Complete

src/app/
â”œâ”€â”€ projects/[id]/
â”‚   â”œâ”€â”€ overview/page.tsx       â³ TODO
â”‚   â”œâ”€â”€ photos/page.tsx         â³ TODO
â”‚   â”œâ”€â”€ reports/page.tsx        â³ TODO
â”‚   â”œâ”€â”€ estimates/page.tsx      â³ TODO
â”‚   â”œâ”€â”€ docs/page.tsx           â³ TODO
â”‚   â”œâ”€â”€ contacts/page.tsx       â³ TODO
â”‚   â””â”€â”€ settings/page.tsx       â³ TODO
â””â”€â”€ report-builder-demo/page.tsx  âœ… Complete (scaffolding demo)
```

## ğŸ“Š Database Schema

### Tables (10 total)

1. **projects** - Project metadata, property info, stats
2. **photos** - Photo storage, AI metadata, manual captions
3. **reports** - Report versions, JSONB data storage
4. **report_sections** - Draggable/reorderable sections
5. **estimates** - Xactimate-compatible scopes
6. **estimate_line_items** - Itemized line items
7. **documents** - Contracts, permits, invoices
8. **contacts** - Homeowners, adjusters, contractors
9. **ai_actions** - Audit log for AI operations
10. **Triggers** - Auto-update project stats (photo_count, report_count, etc.)

**Migration:** `db/migrations/20251104_report_builder_schema.sql`

## ğŸ§¬ Type System

### Core Types

```typescript
interface Project {
  id: string;
  organizationId: string;
  propertyAddress: string;
  insuredName: string;
  status: "active" | "archived" | "completed";
  labels: string[]; // ["hail", "commercial", "urgent"]
  photoCount: number;
  reportCount: number;
  estimateCount: number;
}

interface Photo {
  id: string;
  url: string;
  aiCaption?: string; // Auto-generated
  aiDamageType?: string[]; // ["hail", "wind", "soft-metal-dents"]
  aiLabels?: string[];
  caption?: string; // Manual override
  tags: string[];
  roofArea?: "front" | "back" | "left" | "right" | "skylight" | "vent";
  sortOrder: number;
}

interface Report {
  id: string;
  type: "insurance-claim" | "retail-proposal" | "inspection" | "supplement";
  version: "insurance" | "retail";
  data: Record<string, any>; // ClaimPacketData as JSON
  sections: ReportSection[];
  status: "draft" | "final" | "sent";
}

interface ReportSection {
  type:
    | "cover-page"
    | "weather"
    | "damage-summary"
    | "photos"
    | "scope"
    | "code-references"
    | "contractor-letter"
    | "supplement"
    | "timeline"
    | "material-options"
    | "warranty"
    | "signature";
  title: string;
  content: string; // Markdown or JSON
  isVisible: boolean;
  sortOrder: number; // Drag-and-drop reordering
  isAutoGenerated: boolean;
}
```

## ğŸ¤– AI Actions

### Implemented (Stubs)

All functions throw `"not yet implemented"` errors but have full type signatures and console logging:

1. **autoCaptionPhotos(projectId)** â†’ `Photo[]`
   - Uses OpenAI Vision API to generate captions
   - Updates `photo.aiCaption` and `photo.aiLabels`

2. **detectDamageTypes(projectId)** â†’ `Photo[]`
   - Analyzes photos for hail, wind, soft metal dents
   - Updates `photo.aiDamageType` array

3. **generateFullReport(projectId, version)** â†’ `Report`
   - Creates complete report with all sections auto-filled
   - Pulls from project data, photos, weather, codes

4. **buildScopeFromPhotos(projectId)** â†’ `Estimate`
   - Generates Xactimate-compatible scope
   - Maps to Xactimate codes (tear-off, install, flashing, etc.)

5. **fetchWeatherData(lat, lon, dateOfLoss)** â†’ `WeatherData`
   - Calls NWS API for storm reports
   - Returns hail size, wind speed, storm direction

6. **extractCodeReferences(roofType, damageType)** â†’ `string[]`
   - Auto-applies IBC/IRC/ARMA/NRCA codes
   - Returns array of code citations

## ğŸ¨ UI Components

### SidebarNav

**Status:** âœ… Complete  
**Location:** `src/features/report-builder/components/SidebarNav.tsx`

Left sidebar with 7 navigation items:

- ğŸ“‚ Project Overview
- ğŸ–¼ï¸ Photos
- ğŸ“„ Reports
- ğŸ“ Estimates & Scopes
- ğŸ“ Documents
- ğŸ‘¤ Contacts
- âš™ï¸ Project Settings

### AIActionsBar

**Status:** âœ… Complete  
**Location:** `src/features/report-builder/components/AIActionsBar.tsx`

Vertical action panel with 4 AI buttons:

- ğŸ“„ Generate Full Report
- ğŸ“· Auto-Caption Photos
- ğŸ”¨ Build Scope from Photos
- â˜ï¸ Fetch Weather Data

### SectionList

**Status:** âœ… Complete  
**Location:** `src/features/report-builder/components/SectionList.tsx`

Drag-and-drop section manager:

- Reorder sections (updates `sortOrder`)
- Toggle visibility (shows/hides in export)
- Delete sections
- Visual indicators for auto-generated sections

### SectionEditor â³

**Status:** TODO  
**Description:** Inline markdown/rich-text editor for section content

### PhotoTray â³

**Status:** TODO  
**Description:** Photo upload, grid view, AI captioning, tagging

### ReportExporter â³

**Status:** TODO  
**Description:** Export to PDF/DOCX with existing generator.ts logic

## ğŸ“ Routes

### Demo Page (Scaffolding)

**URL:** `/report-builder-demo`  
**Status:** âœ… Complete  
**Description:** Interactive demo of SidebarNav, AIActionsBar, SectionList components with mock data

### Project Routes â³

All routes are TODO:

- `/projects/[id]/overview` - Project summary, stats, quick actions
- `/projects/[id]/photos` - Photo upload, AI captioning, grid view
- `/projects/[id]/reports` - Report list, create/edit, export
- `/projects/[id]/estimates` - Scope builder, Xactimate export
- `/projects/[id]/docs` - Document upload, categorization
- `/projects/[id]/contacts` - Contact management
- `/projects/[id]/settings` - Project settings, labels, archive

## ğŸš€ Next Steps (Phase 2.1)

### Immediate Tasks

1. **Photo Upload System**
   - Integrate with existing Firebase/Supabase storage
   - Implement PhotoTray component
   - Wire up AI captioning

2. **Report Persistence**
   - Create API routes for projects, reports, sections
   - Implement useProject, useReports hooks
   - Wire up SectionEditor for inline editing

3. **AI Implementation**
   - Replace stubs with real OpenAI Vision calls
   - Implement NWS weather parser
   - Connect code references DB

4. **Export Integration**
   - Wire up existing generator.ts to new Report data structure
   - Add PDF/DOCX export buttons
   - Implement Xactimate XML export

### Follow-Up PRs

1. **Photo Management** (1 week)
   - Upload, tag, caption, delete
   - AI damage detection
   - Grid view with filters

2. **Report Builder** (1 week)
   - Full CRUD for reports + sections
   - Inline editing
   - Export to PDF/DOCX

3. **AI Intelligence** (1 week)
   - OpenAI Vision integration
   - NWS weather parser
   - Auto-scope generation

4. **Xactimate Integration** (1 week)
   - XML export format
   - Line item mapping
   - Pricing integration

5. **Polish & Testing** (3 days)
   - Drag-and-drop refinement
   - Mobile responsive
   - E2E tests

## ğŸ§ª Testing

### Demo Page

Visit `/report-builder-demo` to see:

- Left sidebar navigation
- AI actions panel
- Draggable section list
- Mock data interactions

### Console Logging

All AI stubs log to console:

```
[DEMO] Generate Full Report clicked (stub)
[AI] Generating full insurance report for project demo-project-123...
```

### Database Migration

Run migration (once DB setup is complete):

```bash
psql "$DATABASE_URL" -f db/migrations/20251104_report_builder_schema.sql
```

## ğŸ“¦ Dependencies

**No new dependencies required!**

All scaffolding uses existing:

- shadcn/ui components (Card, Button, Checkbox)
- lucide-react icons
- Next.js 14 App Router
- Existing auth (Clerk)

## ğŸ¯ Definition of Done (Phase 2 MVP)

User can:

1. âœ… Navigate between project tabs (Overview, Photos, Reports, etc.)
2. â³ Upload photos and have them auto-captioned by AI
3. â³ Click "Generate Full Report" and get a complete packet
4. â³ Drag sections to reorder, toggle visibility
5. â³ Edit section content inline
6. â³ Export to PDF/DOCX using existing generator
7. â³ Build Xactimate scope from photos

## ğŸ“ Notes

- **PostgreSQL Schema:** Migration file uses PostgreSQL syntax (not MSSQL)
- **JSONB Storage:** Report data stored as flexible JSON for easy iteration
- **Triggers:** Auto-update project stats on photo/report/estimate changes
- **AI Stubs:** All AI functions are documented but not implemented yet
- **No Breaking Changes:** Phase 1 claims generator still works independently

## ğŸ”— Related Files

- Phase 1: `src/lib/claims/generator.ts`, `src/components/claims/ClaimPacketGenerator.tsx`
- Types: `src/features/report-builder/types.ts`
- Database: `db/migrations/20251104_report_builder_schema.sql`
- Demo: `src/app/report-builder-demo/page.tsx`

---

**Last Updated:** November 4, 2025  
**Branch:** `feat/report-builder-v1`  
**Status:** Scaffolding Complete âœ… | Implementation In Progress â³
