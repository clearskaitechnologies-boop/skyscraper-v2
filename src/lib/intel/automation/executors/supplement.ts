// lib/intel/automation/executors/supplement.ts
/**
 * ðŸ”¥ SUPPLEMENT PACKET EXECUTOR
 * Auto-identifies missing items and builds supplement justification
 */

import { randomUUID } from "node:crypto";
import { logger } from "@/lib/logger";

import { buildMasterReportPayload } from "@/lib/intel/master/buildMasterPayload";
import prisma from "@/lib/prisma";

export async function executeSupplementPacket(claimId: string, orgId: string) {
  logger.debug(`[DOMINUS] Executing Supplement Packet for ${claimId}`);

  // Build master payload
  const payload = await buildMasterReportPayload({ claimId, orgId });
  const { claim, supplements, damageAssessments } = payload;

  // Collect missing items
  const missingItems: any[] = [];
  if (damageAssessments[0]?.metadata) {
    const metadata = damageAssessments[0].metadata as any;
    missingItems.push(...(metadata.missingItems || []));
  }

  // Build supplement summary
  const supplementValue = supplements.reduce((sum, s) => sum + s.total, 0);

  const supplementPacket = {
    claimNumber: claim.claimNumber,
    totalValue: supplementValue,
    itemCount: supplements.length,
    missingItems,
    supplements: supplements.map((s) => ({
      id: s.id,
      description: s.description || "Supplement item",
      total: s.total,
      justification: "Required by code/damage findings",
    })),
    generatedAt: new Date().toISOString(),
  };

  // Save to database
  const report = await prisma.ai_reports.create({
    data: {
      id: randomUUID(),
      orgId,
      claimId,
      type: "supplement_packet",
      title: `Supplement Packet - ${claim.claimNumber}`,
      prompt: "Auto-generated by Dominus",
      content: JSON.stringify(supplementPacket),
      model: "gpt-4o",
      userId: "dominus",
      userName: "Dominus AI",
      status: "generated",
      tokensUsed: 0,
      updatedAt: new Date(),
    },
  });

  logger.debug(`[DOMINUS] Supplement Packet Generated - Total: $${supplementValue}`);

  return {
    reportId: report.id,
    totalValue: supplementValue,
    itemCount: supplements.length,
  };
}
