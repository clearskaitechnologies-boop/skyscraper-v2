<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 800" font-family="Arial, Helvetica, sans-serif">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#7c3aed"/>
    </marker>
    <filter id="shadow" x="-3%" y="-3%" width="106%" height="106%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.1"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1200" height="800" fill="#faf5ff" rx="8"/>

  <!-- Title -->
  <rect x="0" y="0" width="1200" height="55" fill="#4c1d95" rx="0"/>
  <text x="600" y="35" text-anchor="middle" fill="white" font-size="20" font-weight="bold">Fig. 2 — AI Vision Damage Detection Pipeline (Patent Reference)</text>
  <text x="1180" y="35" text-anchor="end" fill="#c4b5fd" font-size="10">ClearSkai Technologies LLC © 2026</text>

  <!-- Step 1: Photo Upload -->
  <rect x="40" y="80" width="200" height="100" rx="8" fill="white" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
  <text x="140" y="105" text-anchor="middle" fill="#3b82f6" font-size="13" font-weight="bold">1. Photo Upload</text>
  <text x="140" y="125" text-anchor="middle" fill="#1e40af" font-size="10">User uploads images</text>
  <text x="140" y="140" text-anchor="middle" fill="#1e40af" font-size="10">via React Dropzone</text>
  <text x="140" y="155" text-anchor="middle" fill="#1e40af" font-size="10">EXIF metadata extracted</text>
  <text x="140" y="168" text-anchor="middle" fill="#64748b" font-size="9">(GPS, timestamp, camera)</text>

  <!-- Arrow -->
  <line x1="240" y1="130" x2="280" y2="130" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 2: Storage -->
  <rect x="280" y="80" width="200" height="100" rx="8" fill="white" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
  <text x="380" y="105" text-anchor="middle" fill="#059669" font-size="13" font-weight="bold">2. Artifact Storage</text>
  <text x="380" y="125" text-anchor="middle" fill="#065f46" font-size="10">Store in R2/Supabase</text>
  <text x="380" y="140" text-anchor="middle" fill="#065f46" font-size="10">Create FileAsset record</text>
  <text x="380" y="155" text-anchor="middle" fill="#065f46" font-size="10">Compute checksum/hash</text>
  <text x="380" y="168" text-anchor="middle" fill="#64748b" font-size="9">(orgId-scoped path)</text>

  <!-- Arrow -->
  <line x1="480" y1="130" x2="520" y2="130" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 3: Signed URL -->
  <rect x="520" y="80" width="200" height="100" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="620" y="105" text-anchor="middle" fill="#dc2626" font-size="13" font-weight="bold">3. Signed URL Gen</text>
  <text x="620" y="125" text-anchor="middle" fill="#991b1b" font-size="10">HMAC-signed URL</text>
  <text x="620" y="140" text-anchor="middle" fill="#991b1b" font-size="10">Time-limited (15 min)</text>
  <text x="620" y="155" text-anchor="middle" fill="#991b1b" font-size="10">Read-only access</text>
  <text x="620" y="168" text-anchor="middle" fill="#64748b" font-size="9">(Privacy-preserving)</text>

  <!-- Arrow -->
  <line x1="720" y1="130" x2="760" y2="130" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 4: Vision AI -->
  <rect x="760" y="80" width="200" height="100" rx="8" fill="white" stroke="#7c3aed" stroke-width="2" filter="url(#shadow)"/>
  <text x="860" y="105" text-anchor="middle" fill="#7c3aed" font-size="13" font-weight="bold">4. GPT-4o Vision</text>
  <text x="860" y="125" text-anchor="middle" fill="#5b21b6" font-size="10">identifyDamage(url)</text>
  <text x="860" y="140" text-anchor="middle" fill="#5b21b6" font-size="10">Zod schema validation</text>
  <text x="860" y="155" text-anchor="middle" fill="#5b21b6" font-size="10">3 retries w/ validation</text>
  <text x="860" y="168" text-anchor="middle" fill="#64748b" font-size="9">(Structured JSON output)</text>

  <!-- Arrow -->
  <line x1="960" y1="130" x2="1000" y2="130" stroke="#64748b" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Step 5: Results -->
  <rect x="1000" y="80" width="170" height="100" rx="8" fill="white" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="1085" y="105" text-anchor="middle" fill="#d97706" font-size="13" font-weight="bold">5. Persist Results</text>
  <text x="1085" y="125" text-anchor="middle" fill="#92400e" font-size="10">photo_findings table</text>
  <text x="1085" y="140" text-anchor="middle" fill="#92400e" font-size="10">ai_reports table</text>
  <text x="1085" y="155" text-anchor="middle" fill="#92400e" font-size="10">ai_performance_logs</text>
  <text x="1085" y="168" text-anchor="middle" fill="#64748b" font-size="9">(30-day cache)</text>

  <!-- DamageReport Schema Box -->
  <rect x="40" y="210" width="1130" height="120" rx="8" fill="white" stroke="#7c3aed" stroke-width="2" filter="url(#shadow)"/>
  <text x="60" y="240" fill="#7c3aed" font-size="14" font-weight="bold">DamageReport Output Schema (Zod-validated)</text>

  <rect x="60" y="250" width="220" height="65" rx="4" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1"/>
  <text x="70" y="268" fill="#5b21b6" font-size="10" font-weight="bold">Per-Photo Finding:</text>
  <text x="70" y="282" fill="#6b21a8" font-size="9">• location: facet + elevation</text>
  <text x="70" y="294" fill="#6b21a8" font-size="9">• damageType: hail|wind|impact|thermal|age</text>
  <text x="70" y="306" fill="#6b21a8" font-size="9">• material: shingle|metal|tile|wood|etc</text>

  <rect x="295" y="250" width="220" height="65" rx="4" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1"/>
  <text x="305" y="268" fill="#5b21b6" font-size="10" font-weight="bold">Severity Classification:</text>
  <text x="305" y="282" fill="#6b21a8" font-size="9">• severity: minor|moderate|severe|catastrophic</text>
  <text x="305" y="294" fill="#6b21a8" font-size="9">• confidence: 0.0 – 1.0</text>
  <text x="305" y="306" fill="#6b21a8" font-size="9">• peril_attribution: hail|wind|both</text>

  <rect x="530" y="250" width="220" height="65" rx="4" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1"/>
  <text x="540" y="268" fill="#5b21b6" font-size="10" font-weight="bold">Component Detection:</text>
  <text x="540" y="282" fill="#6b21a8" font-size="9">• 16 types: shingle, flashing, ridge_cap,</text>
  <text x="540" y="294" fill="#6b21a8" font-size="9">  soffit, fascia, gutter, drip_edge, etc.</text>
  <text x="540" y="306" fill="#6b21a8" font-size="9">• bounding_box: {x, y, w, h}</text>

  <rect x="765" y="250" width="230" height="65" rx="4" fill="#f5f3ff" stroke="#a78bfa" stroke-width="1"/>
  <text x="775" y="268" fill="#5b21b6" font-size="10" font-weight="bold">Xactimate Integration:</text>
  <text x="775" y="282" fill="#6b21a8" font-size="9">• suggested_line_items[]: code, qty, unit</text>
  <text x="775" y="294" fill="#6b21a8" font-size="9">• export: ESX XML + Symbility D22 JSON</text>
  <text x="775" y="306" fill="#6b21a8" font-size="9">• regional_pricing: per-market rates</text>

  <!-- Parallel Processing Pipelines -->
  <text x="60" y="365" fill="#1e293b" font-size="16" font-weight="bold">Parallel Vision Pipelines (run concurrently per photo)</text>

  <!-- Pipeline 1 -->
  <rect x="40" y="380" width="350" height="160" rx="8" fill="white" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
  <text x="60" y="405" fill="#3b82f6" font-size="13" font-weight="bold">A. Damage Identification</text>
  <text x="60" y="425" fill="#1e40af" font-size="10">identifyDamage.ts</text>
  <line x1="60" y1="435" x2="370" y2="435" stroke="#dbeafe" stroke-width="1"/>
  <text x="60" y="455" fill="#334155" font-size="10">→ Detect damage type per component</text>
  <text x="60" y="470" fill="#334155" font-size="10">→ Classify severity (minor→catastrophic)</text>
  <text x="60" y="485" fill="#334155" font-size="10">→ Attribute to peril (hail/wind/impact)</text>
  <text x="60" y="500" fill="#334155" font-size="10">→ Generate bounding boxes</text>
  <text x="60" y="515" fill="#334155" font-size="10">→ Suggest Xactimate line items</text>
  <text x="60" y="530" fill="#64748b" font-size="9">Model: GPT-4o with structured JSON schema</text>

  <!-- Pipeline 2 -->
  <rect x="420" y="380" width="350" height="160" rx="8" fill="white" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
  <text x="440" y="405" fill="#059669" font-size="13" font-weight="bold">B. Geometry &amp; Material Analysis</text>
  <text x="440" y="425" fill="#065f46" font-size="10">extractRoofGeometry.ts + classifyMaterials.ts</text>
  <line x1="440" y1="435" x2="750" y2="435" stroke="#d1fae5" stroke-width="1"/>
  <text x="440" y="455" fill="#334155" font-size="10">→ Detect roof pitch and slopes</text>
  <text x="440" y="470" fill="#334155" font-size="10">→ Calculate total roof area</text>
  <text x="440" y="485" fill="#334155" font-size="10">→ Identify material type + age</text>
  <text x="440" y="500" fill="#334155" font-size="10">→ Assess material condition</text>
  <text x="440" y="515" fill="#334155" font-size="10">→ Predict code upgrade needs</text>
  <text x="440" y="530" fill="#64748b" font-size="9">Model: GPT-4o Vision keypoints mode</text>

  <!-- Pipeline 3 -->
  <rect x="800" y="380" width="370" height="160" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="820" y="405" fill="#dc2626" font-size="13" font-weight="bold">C. Before-After Transformation (BATF)</text>
  <text x="820" y="425" fill="#991b1b" font-size="10">batfEngine.ts</text>
  <line x1="820" y1="435" x2="1150" y2="435" stroke="#fee2e2" stroke-width="1"/>
  <text x="820" y="455" fill="#334155" font-size="10">→ GPT-4o damage detection</text>
  <text x="820" y="470" fill="#334155" font-size="10">→ Replicate AI: generate "before" image</text>
  <text x="820" y="485" fill="#334155" font-size="10">→ sharp SVG overlay annotations</text>
  <text x="820" y="500" fill="#334155" font-size="10">→ Severity heatmap generation</text>
  <text x="820" y="515" fill="#334155" font-size="10">→ jsPDF presentation assembly</text>
  <text x="820" y="530" fill="#64748b" font-size="9">Models: GPT-4o + Replicate + sharp</text>

  <!-- Caption System -->
  <rect x="40" y="565" width="540" height="110" rx="8" fill="white" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="60" y="590" fill="#d97706" font-size="13" font-weight="bold">D. Assertive Photo Caption System</text>
  <text x="60" y="610" fill="#92400e" font-size="10">captionRules.ts + photo-caption-generator.ts</text>
  <line x1="60" y1="618" x2="560" y2="618" stroke="#fef3c7" stroke-width="1"/>
  <text x="60" y="638" fill="#334155" font-size="10">RULE: Never use uncertain language ("appears to", "may be", "possibly")</text>
  <text x="60" y="653" fill="#334155" font-size="10">Each caption includes: material type + damage type + functional impact</text>
  <text x="60" y="668" fill="#334155" font-size="10">+ applicable building code reference + date-of-loss weather tie-in</text>

  <!-- Annotation System -->
  <rect x="610" y="565" width="560" height="110" rx="8" fill="white" stroke="#7c3aed" stroke-width="2" filter="url(#shadow)"/>
  <text x="630" y="590" fill="#7c3aed" font-size="13" font-weight="bold">E. Photo Annotation &amp; Measurement</text>
  <text x="630" y="610" fill="#5b21b6" font-size="10">photo-annotator.ts</text>
  <line x1="630" y1="618" x2="1150" y2="618" stroke="#ede9fe" stroke-width="1"/>
  <text x="630" y="638" fill="#334155" font-size="10">→ Bounding box overlay with measurements (diameter, length, area)</text>
  <text x="630" y="653" fill="#334155" font-size="10">→ Location labels (compass direction + roof feature)</text>
  <text x="630" y="668" fill="#334155" font-size="10">→ Urgency classification markers (red/yellow/green)</text>

  <!-- Severity Scoring -->
  <rect x="40" y="695" width="1130" height="80" rx="8" fill="#1e293b" filter="url(#shadow)"/>
  <text x="60" y="720" fill="#67e8f9" font-size="13" font-weight="bold">F. Zone-Based Severity Scoring Algorithm (severity-scoring.ts)</text>
  <text x="60" y="742" fill="#e2e8f0" font-size="11">Score = (Damage Extent × 0.30) + (Material Condition × 0.25) + (Structural Risk × 0.30) + (Urgency × 0.15)</text>
  <text x="60" y="762" fill="#94a3b8" font-size="10">Categories: Minor (1-3) → Moderate (4-5) → Severe (6-8) → Catastrophic (9-10)     |     Per-zone scoring across all roof facets</text>
</svg>
