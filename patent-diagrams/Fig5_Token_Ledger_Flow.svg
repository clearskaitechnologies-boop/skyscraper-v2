<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 780" font-family="Arial, Helvetica, sans-serif">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
    <marker id="greenArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#059669"/>
    </marker>
    <marker id="redArrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#dc2626"/>
    </marker>
    <filter id="shadow" x="-3%" y="-3%" width="106%" height="106%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.1"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1200" height="780" fill="#fdf2f8" rx="8"/>

  <!-- Title -->
  <rect x="0" y="0" width="1200" height="55" fill="#9d174d" rx="0"/>
  <text x="600" y="35" text-anchor="middle" fill="white" font-size="20" font-weight="bold">Fig. 5 ‚Äî Token Economy &amp; Append-Only Ledger System (Patent Reference)</text>
  <text x="1180" y="35" text-anchor="end" fill="#f9a8d4" font-size="10">ClearSkai Technologies LLC ¬© 2026</text>

  <!-- ========== TOP ROW: Purchase Sources ========== -->
  <text x="600" y="82" text-anchor="middle" fill="#9d174d" font-size="14" font-weight="bold">TOKEN ACQUISITION (Credit Side)</text>

  <!-- Stripe Purchase -->
  <rect x="60" y="95" width="220" height="105" rx="8" fill="white" stroke="#6366f1" stroke-width="2" filter="url(#shadow)"/>
  <text x="170" y="118" text-anchor="middle" fill="#6366f1" font-size="13" font-weight="bold">Stripe Purchase</text>
  <line x1="70" y1="126" x2="270" y2="126" stroke="#e0e7ff" stroke-width="1"/>
  <text x="170" y="143" text-anchor="middle" fill="#4338ca" font-size="10">checkout.session.completed</text>
  <text x="170" y="158" text-anchor="middle" fill="#4338ca" font-size="10">‚Üí webhook ‚Üí verifySignature()</text>
  <text x="170" y="173" text-anchor="middle" fill="#4338ca" font-size="10">‚Üí tokenPackQuantity * unitSize</text>
  <text x="170" y="190" text-anchor="middle" fill="#4338ca" font-size="9">ref: "stripe:{session_id}"</text>

  <!-- Subscription Allocation -->
  <rect x="310" y="95" width="220" height="105" rx="8" fill="white" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
  <text x="420" y="118" text-anchor="middle" fill="#059669" font-size="13" font-weight="bold">Subscription Allotment</text>
  <line x1="320" y1="126" x2="520" y2="126" stroke="#d1fae5" stroke-width="1"/>
  <text x="420" y="143" text-anchor="middle" fill="#065f46" font-size="10">Monthly cron ‚Üí resetAllocations</text>
  <text x="420" y="158" text-anchor="middle" fill="#065f46" font-size="10">Tier determines amount:</text>
  <text x="420" y="173" text-anchor="middle" fill="#065f46" font-size="10">Standard=50, Pro=200, Ent=‚àû</text>
  <text x="420" y="190" text-anchor="middle" fill="#065f46" font-size="9">ref: "subscription:{period}"</text>

  <!-- Admin Grant -->
  <rect x="560" y="95" width="220" height="105" rx="8" fill="white" stroke="#d97706" stroke-width="2" filter="url(#shadow)"/>
  <text x="670" y="118" text-anchor="middle" fill="#d97706" font-size="13" font-weight="bold">Admin Grant</text>
  <line x1="570" y1="126" x2="770" y2="126" stroke="#fef3c7" stroke-width="1"/>
  <text x="670" y="143" text-anchor="middle" fill="#92400e" font-size="10">Manual allocation via</text>
  <text x="670" y="158" text-anchor="middle" fill="#92400e" font-size="10">POST /api/tokens/admin/grant</text>
  <text x="670" y="173" text-anchor="middle" fill="#92400e" font-size="10">Reason required (audit trail)</text>
  <text x="670" y="190" text-anchor="middle" fill="#92400e" font-size="9">ref: "admin:{userId}:{reason}"</text>

  <!-- Promo/Referral -->
  <rect x="810" y="95" width="220" height="105" rx="8" fill="white" stroke="#8b5cf6" stroke-width="2" filter="url(#shadow)"/>
  <text x="920" y="118" text-anchor="middle" fill="#8b5cf6" font-size="13" font-weight="bold">Promo / Referral</text>
  <line x1="820" y1="126" x2="1020" y2="126" stroke="#ede9fe" stroke-width="1"/>
  <text x="920" y="143" text-anchor="middle" fill="#5b21b6" font-size="10">Referral code redemption</text>
  <text x="920" y="158" text-anchor="middle" fill="#5b21b6" font-size="10">Trial bonus tokens</text>
  <text x="920" y="173" text-anchor="middle" fill="#5b21b6" font-size="10">Campaign-linked grants</text>
  <text x="920" y="190" text-anchor="middle" fill="#5b21b6" font-size="9">ref: "promo:{code}"</text>

  <!-- Arrows down into Ledger -->
  <line x1="170" y1="200" x2="170" y2="250" stroke="#059669" stroke-width="2" marker-end="url(#greenArrow)"/>
  <line x1="420" y1="200" x2="420" y2="250" stroke="#059669" stroke-width="2" marker-end="url(#greenArrow)"/>
  <line x1="670" y1="200" x2="670" y2="250" stroke="#059669" stroke-width="2" marker-end="url(#greenArrow)"/>
  <line x1="920" y1="200" x2="920" y2="250" stroke="#059669" stroke-width="2" marker-end="url(#greenArrow)"/>

  <text x="150" y="232" fill="#059669" font-size="10" font-weight="bold">+CREDIT</text>
  <text x="400" y="232" fill="#059669" font-size="10" font-weight="bold">+CREDIT</text>
  <text x="650" y="232" fill="#059669" font-size="10" font-weight="bold">+CREDIT</text>
  <text x="900" y="232" fill="#059669" font-size="10" font-weight="bold">+CREDIT</text>

  <!-- ========== CENTRAL: The Ledger ========== -->
  <rect x="60" y="255" width="1080" height="120" rx="12" fill="#1e293b" filter="url(#shadow)"/>
  <text x="600" y="285" text-anchor="middle" fill="#f9a8d4" font-size="18" font-weight="bold">tokens_ledger ‚Äî Append-Only Immutable Ledger</text>

  <!-- Schema row -->
  <rect x="80" y="295" width="1040" height="30" rx="4" fill="#334155"/>
  <text x="100" y="315" fill="#67e8f9" font-size="11" font-weight="bold">id</text>
  <text x="155" y="315" fill="#67e8f9" font-size="11" font-weight="bold">org_id</text>
  <text x="235" y="315" fill="#67e8f9" font-size="11" font-weight="bold">delta</text>
  <text x="310" y="315" fill="#67e8f9" font-size="11" font-weight="bold">type</text>
  <text x="420" y="315" fill="#67e8f9" font-size="11" font-weight="bold">ref</text>
  <text x="620" y="315" fill="#67e8f9" font-size="11" font-weight="bold">balance_after</text>
  <text x="760" y="315" fill="#67e8f9" font-size="11" font-weight="bold">created_at</text>
  <text x="900" y="315" fill="#67e8f9" font-size="11" font-weight="bold">description</text>

  <!-- Example rows -->
  <rect x="80" y="327" width="1040" height="20" rx="2" fill="#475569"/>
  <text x="100" y="341" fill="#e2e8f0" font-size="9">uuid-1</text>
  <text x="155" y="341" fill="#e2e8f0" font-size="9">org_abc</text>
  <text x="235" y="341" fill="#4ade80" font-size="9">+200</text>
  <text x="310" y="341" fill="#e2e8f0" font-size="9">PURCHASE</text>
  <text x="420" y="341" fill="#e2e8f0" font-size="9">stripe:cs_live_abc123</text>
  <text x="620" y="341" fill="#e2e8f0" font-size="9">200</text>
  <text x="760" y="341" fill="#e2e8f0" font-size="9">2026-01-15T10:30:00Z</text>
  <text x="900" y="341" fill="#e2e8f0" font-size="9">Token pack purchase</text>

  <rect x="80" y="349" width="1040" height="20" rx="2" fill="#334155"/>
  <text x="100" y="363" fill="#e2e8f0" font-size="9">uuid-2</text>
  <text x="155" y="363" fill="#e2e8f0" font-size="9">org_abc</text>
  <text x="235" y="363" fill="#fb7185" font-size="9">-1</text>
  <text x="310" y="363" fill="#e2e8f0" font-size="9">CONSUME</text>
  <text x="420" y="363" fill="#e2e8f0" font-size="9">report:rpt_xyz789</text>
  <text x="620" y="363" fill="#e2e8f0" font-size="9">199</text>
  <text x="760" y="363" fill="#e2e8f0" font-size="9">2026-01-15T10:45:00Z</text>
  <text x="900" y="363" fill="#e2e8f0" font-size="9">Weather report generation</text>

  <!-- Balance Trigger -->
  <rect x="1060" y="260" width="100" height="50" rx="6" fill="#fb923c" stroke="#ea580c" stroke-width="1"/>
  <text x="1110" y="280" text-anchor="middle" fill="white" font-size="9" font-weight="bold">DB TRIGGER</text>
  <text x="1110" y="295" text-anchor="middle" fill="white" font-size="8">balance_after</text>
  <text x="1110" y="305" text-anchor="middle" fill="white" font-size="8">= auto-calc</text>

  <!-- Arrows from ledger to consumers -->
  <line x1="170" y1="375" x2="170" y2="420" stroke="#dc2626" stroke-width="2" marker-end="url(#redArrow)"/>
  <line x1="400" y1="375" x2="400" y2="420" stroke="#dc2626" stroke-width="2" marker-end="url(#redArrow)"/>
  <line x1="630" y1="375" x2="630" y2="420" stroke="#dc2626" stroke-width="2" marker-end="url(#redArrow)"/>
  <line x1="860" y1="375" x2="860" y2="420" stroke="#dc2626" stroke-width="2" marker-end="url(#redArrow)"/>

  <text x="150" y="405" fill="#dc2626" font-size="10" font-weight="bold">-DEBIT</text>
  <text x="380" y="405" fill="#dc2626" font-size="10" font-weight="bold">-DEBIT</text>
  <text x="610" y="405" fill="#dc2626" font-size="10" font-weight="bold">-DEBIT</text>
  <text x="840" y="405" fill="#dc2626" font-size="10" font-weight="bold">-DEBIT</text>

  <!-- ========== BOTTOM ROW: Consumer Operations ========== -->
  <text x="600" y="435" text-anchor="middle" fill="#9d174d" font-size="14" font-weight="bold">TOKEN CONSUMPTION (Debit Side)</text>

  <!-- Consumer 1: Reports -->
  <rect x="60" y="445" width="220" height="100" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="170" y="468" text-anchor="middle" fill="#dc2626" font-size="13" font-weight="bold">Report Generation</text>
  <line x1="70" y1="476" x2="270" y2="476" stroke="#fecaca" stroke-width="1"/>
  <text x="170" y="492" text-anchor="middle" fill="#991b1b" font-size="10">Weather reports: -1 token</text>
  <text x="170" y="507" text-anchor="middle" fill="#991b1b" font-size="10">Full damage report: -3 tokens</text>
  <text x="170" y="522" text-anchor="middle" fill="#991b1b" font-size="10">PDF generation: -2 tokens</text>
  <text x="170" y="537" text-anchor="middle" fill="#991b1b" font-size="9">ref: "report:{reportId}"</text>

  <!-- Consumer 2: AI Analysis -->
  <rect x="310" y="445" width="220" height="100" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="420" y="468" text-anchor="middle" fill="#dc2626" font-size="13" font-weight="bold">AI Analysis</text>
  <line x1="320" y1="476" x2="520" y2="476" stroke="#fecaca" stroke-width="1"/>
  <text x="420" y="492" text-anchor="middle" fill="#991b1b" font-size="10">Vision analysis: -1 token</text>
  <text x="420" y="507" text-anchor="middle" fill="#991b1b" font-size="10">Rebuttal letter: -2 tokens</text>
  <text x="420" y="522" text-anchor="middle" fill="#991b1b" font-size="10">Claims analysis: -1 token</text>
  <text x="420" y="537" text-anchor="middle" fill="#991b1b" font-size="9">ref: "ai:{analysisType}:{id}"</text>

  <!-- Consumer 3: Batch Operations -->
  <rect x="560" y="445" width="220" height="100" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="670" y="468" text-anchor="middle" fill="#dc2626" font-size="13" font-weight="bold">Batch Proposals</text>
  <line x1="570" y1="476" x2="770" y2="476" stroke="#fecaca" stroke-width="1"/>
  <text x="670" y="492" text-anchor="middle" fill="#991b1b" font-size="10">Batch of N claims: -N tokens</text>
  <text x="670" y="507" text-anchor="middle" fill="#991b1b" font-size="10">Storm batch: per-claim rate</text>
  <text x="670" y="522" text-anchor="middle" fill="#991b1b" font-size="10">Pre-flight balance check</text>
  <text x="670" y="537" text-anchor="middle" fill="#991b1b" font-size="9">ref: "batch:{batchId}"</text>

  <!-- Consumer 4: Agent Operations -->
  <rect x="810" y="445" width="220" height="100" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="920" y="468" text-anchor="middle" fill="#dc2626" font-size="13" font-weight="bold">Agent Missions</text>
  <line x1="820" y1="476" x2="1020" y2="476" stroke="#fecaca" stroke-width="1"/>
  <text x="920" y="492" text-anchor="middle" fill="#991b1b" font-size="10">Per-task token cost</text>
  <text x="920" y="507" text-anchor="middle" fill="#991b1b" font-size="10">Aggregated per-mission</text>
  <text x="920" y="522" text-anchor="middle" fill="#991b1b" font-size="10">Org-scoped enforcement</text>
  <text x="920" y="537" text-anchor="middle" fill="#991b1b" font-size="9">ref: "agent:{missionId}"</text>

  <!-- ========== GUARD RAIL: Pre-flight check ========== -->
  <rect x="60" y="565" width="1080" height="70" rx="8" fill="#fef2f2" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="85" y="590" fill="#dc2626" font-size="13" font-weight="bold">üõ°Ô∏è Pre-Flight Guard Rail (every consume operation)</text>
  <text x="85" y="610" fill="#991b1b" font-size="11">1. checkBalance(orgId) ‚Üí SELECT balance_after FROM tokens_ledger WHERE org_id = $1 ORDER BY created_at DESC LIMIT 1</text>
  <text x="85" y="626" fill="#991b1b" font-size="11">2. IF balance &lt; requiredTokens ‚Üí REJECT (402 Payment Required) ‚Üí UI shows "Purchase More Tokens" CTA</text>

  <!-- ========== AUDIT PROPERTIES ========== -->
  <rect x="60" y="650" width="530" height="115" rx="8" fill="white" stroke="#1e293b" stroke-width="2" filter="url(#shadow)"/>
  <text x="85" y="675" fill="#1e293b" font-size="13" font-weight="bold">Immutability Properties</text>
  <text x="85" y="696" fill="#475569" font-size="11">‚úì No UPDATE or DELETE operations ‚Äî append-only writes</text>
  <text x="85" y="712" fill="#475569" font-size="11">‚úì balance_after computed by PostgreSQL trigger (tamper-proof)</text>
  <text x="85" y="728" fill="#475569" font-size="11">‚úì Every entry has ref (external correlation ID)</text>
  <text x="85" y="744" fill="#475569" font-size="11">‚úì Org-scoped isolation ‚Äî multi-tenant safety</text>
  <text x="85" y="760" fill="#475569" font-size="11">‚úì created_at is server-generated ‚Äî no client manipulation</text>

  <!-- Wallet Cache -->
  <rect x="620" y="650" width="520" height="115" rx="8" fill="white" stroke="#8b5cf6" stroke-width="2" filter="url(#shadow)"/>
  <text x="645" y="675" fill="#8b5cf6" font-size="13" font-weight="bold">organization_wallets (Materialized View)</text>
  <text x="645" y="696" fill="#5b21b6" font-size="11">‚Ä¢ Cached balance for fast reads (O(1) lookup)</text>
  <text x="645" y="712" fill="#5b21b6" font-size="11">‚Ä¢ Auto-synced via trigger on tokens_ledger INSERT</text>
  <text x="645" y="728" fill="#5b21b6" font-size="11">‚Ä¢ Upsert pattern: INSERT ON CONFLICT UPDATE</text>
  <text x="645" y="744" fill="#5b21b6" font-size="11">‚Ä¢ Source of truth remains tokens_ledger</text>
  <text x="645" y="760" fill="#5b21b6" font-size="11">‚Ä¢ Used by UI balance display + pre-flight checks</text>

  <text x="600" y="778" text-anchor="middle" fill="#475569" font-size="10">SkaiScraper ‚Äî ClearSkai Technologies LLC ‚Äî Provisional Patent Reference ‚Äî February 2026</text>
</svg>
