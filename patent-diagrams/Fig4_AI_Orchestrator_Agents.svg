<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 850" font-family="Arial, Helvetica, sans-serif">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
    <filter id="shadow" x="-3%" y="-3%" width="106%" height="106%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.1"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1200" height="850" fill="#fefce8" rx="8"/>

  <!-- Title -->
  <rect x="0" y="0" width="1200" height="55" fill="#78350f" rx="0"/>
  <text x="600" y="35" text-anchor="middle" fill="white" font-size="20" font-weight="bold">Fig. 4 — AI Orchestrator "The Brain" &amp; Agent Mission Flow (Patent Reference)</text>
  <text x="1180" y="35" text-anchor="end" fill="#fbbf24" font-size="10">ClearSkai Technologies LLC © 2026</text>

  <!-- Central Orchestrator -->
  <rect x="350" y="75" width="500" height="60" rx="30" fill="#7c3aed" filter="url(#shadow)"/>
  <text x="600" y="110" text-anchor="middle" fill="white" font-size="18" font-weight="bold">orchestrateClaim(claimId, orgId)</text>

  <!-- Six arrows fanning out -->
  <line x1="430" y1="135" x2="130" y2="180" stroke="#7c3aed" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="500" y1="135" x2="340" y2="180" stroke="#7c3aed" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="570" y1="135" x2="550" y2="180" stroke="#7c3aed" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="640" y1="135" x2="760" y2="180" stroke="#7c3aed" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="710" y1="135" x2="970" y2="180" stroke="#7c3aed" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Engine 1: Rules -->
  <rect x="40" y="180" width="180" height="100" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="130" y="205" text-anchor="middle" fill="#dc2626" font-size="12" font-weight="bold">Rules Engine</text>
  <text x="130" y="222" text-anchor="middle" fill="#991b1b" font-size="9">Custom DSL conditions</text>
  <text x="130" y="236" text-anchor="middle" fill="#991b1b" font-size="9">AND/OR grouping</text>
  <text x="130" y="250" text-anchor="middle" fill="#991b1b" font-size="9">Dot-path evaluation</text>
  <text x="130" y="264" text-anchor="middle" fill="#64748b" font-size="8">ruleEngine.ts</text>

  <!-- Engine 2: State Machine -->
  <rect x="250" y="180" width="180" height="100" rx="8" fill="white" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
  <text x="340" y="205" text-anchor="middle" fill="#3b82f6" font-size="12" font-weight="bold">State Machine</text>
  <text x="340" y="222" text-anchor="middle" fill="#1e40af" font-size="9">9-state lifecycle</text>
  <text x="340" y="236" text-anchor="middle" fill="#1e40af" font-size="9">INTAKE → ... → PAID</text>
  <text x="340" y="250" text-anchor="middle" fill="#1e40af" font-size="9">Transition history</text>
  <text x="340" y="264" text-anchor="middle" fill="#64748b" font-size="8">stateMachine.ts</text>

  <!-- Engine 3: Similarity -->
  <rect x="460" y="180" width="180" height="100" rx="8" fill="white" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
  <text x="550" y="205" text-anchor="middle" fill="#059669" font-size="12" font-weight="bold">Similarity Engine</text>
  <text x="550" y="222" text-anchor="middle" fill="#065f46" font-size="9">3072-dim embeddings</text>
  <text x="550" y="236" text-anchor="middle" fill="#065f46" font-size="9">Cosine similarity</text>
  <text x="550" y="250" text-anchor="middle" fill="#065f46" font-size="9">Outcome prediction</text>
  <text x="550" y="264" text-anchor="middle" fill="#64748b" font-size="8">querySimilarClaims.ts</text>

  <!-- Engine 4: Strategy -->
  <rect x="670" y="180" width="180" height="100" rx="8" fill="white" stroke="#f59e0b" stroke-width="2" filter="url(#shadow)"/>
  <text x="760" y="205" text-anchor="middle" fill="#d97706" font-size="12" font-weight="bold">Strategy Engine</text>
  <text x="760" y="222" text-anchor="middle" fill="#92400e" font-size="9">Carrier-specific tactics</text>
  <text x="760" y="236" text-anchor="middle" fill="#92400e" font-size="9">Negotiation patterns</text>
  <text x="760" y="250" text-anchor="middle" fill="#92400e" font-size="9">8+ strategies</text>
  <text x="760" y="264" text-anchor="middle" fill="#64748b" font-size="8">strategyEngine.ts</text>

  <!-- Engine 5: Planner + Feedback -->
  <rect x="880" y="180" width="280" height="100" rx="8" fill="white" stroke="#8b5cf6" stroke-width="2" filter="url(#shadow)"/>
  <text x="1020" y="205" text-anchor="middle" fill="#7c3aed" font-size="12" font-weight="bold">Planner + Feedback Loop</text>
  <text x="1020" y="222" text-anchor="middle" fill="#5b21b6" font-size="9">Next-action suggestions (priority-sorted)</text>
  <text x="1020" y="236" text-anchor="middle" fill="#5b21b6" font-size="9">Action→Outcome tracking</text>
  <text x="1020" y="250" text-anchor="middle" fill="#5b21b6" font-size="9">Continuous AI improvement</text>
  <text x="1020" y="264" text-anchor="middle" fill="#64748b" font-size="8">claimPlanner.ts + logAction.ts + logOutcome.ts</text>

  <!-- Output convergence -->
  <line x1="130" y1="280" x2="430" y2="320" stroke="#7c3aed" stroke-width="1.5"/>
  <line x1="340" y1="280" x2="500" y2="320" stroke="#7c3aed" stroke-width="1.5"/>
  <line x1="550" y1="280" x2="600" y2="320" stroke="#7c3aed" stroke-width="1.5"/>
  <line x1="760" y1="280" x2="700" y2="320" stroke="#7c3aed" stroke-width="1.5"/>
  <line x1="1020" y1="280" x2="770" y2="320" stroke="#7c3aed" stroke-width="1.5"/>

  <!-- ClaimIntelligence Output -->
  <rect x="350" y="315" width="500" height="65" rx="8" fill="#7c3aed" filter="url(#shadow)"/>
  <text x="600" y="338" text-anchor="middle" fill="white" font-size="13" font-weight="bold">ClaimIntelligence Output</text>
  <text x="600" y="356" text-anchor="middle" fill="#e2e8f0" font-size="10">{ approvalLikelihood, supplementSuccessProbability, riskScore,</text>
  <text x="600" y="370" text-anchor="middle" fill="#e2e8f0" font-size="10">recommendedStrategy, nextActions[], explanation }</text>

  <!-- Divider -->
  <line x1="40" y1="400" x2="1160" y2="400" stroke="#d97706" stroke-width="2" stroke-dasharray="8,4"/>
  <text x="600" y="418" text-anchor="middle" fill="#d97706" font-size="12" font-weight="bold">AUTONOMOUS AGENT FRAMEWORK</text>

  <!-- Agent Registry -->
  <rect x="40" y="430" width="1120" height="180" rx="8" fill="white" stroke="#1e293b" stroke-width="2" filter="url(#shadow)"/>
  <text x="60" y="455" fill="#1e293b" font-size="14" font-weight="bold">6 Autonomous Agents (BaseAgent → Zod Validation → Sentry → agent_runs persistence)</text>

  <!-- Agent 1 -->
  <rect x="60" y="468" width="170" height="130" rx="6" fill="#fef2f2" stroke="#dc2626" stroke-width="1.5"/>
  <text x="145" y="490" text-anchor="middle" fill="#dc2626" font-size="11" font-weight="bold">Bad Faith</text>
  <text x="145" y="505" text-anchor="middle" fill="#dc2626" font-size="11" font-weight="bold">Detection</text>
  <line x1="70" y1="512" x2="220" y2="512" stroke="#fecaca" stroke-width="1"/>
  <text x="145" y="528" text-anchor="middle" fill="#991b1b" font-size="9">Delay cycle analysis</text>
  <text x="145" y="541" text-anchor="middle" fill="#991b1b" font-size="9">Contradiction detection</text>
  <text x="145" y="554" text-anchor="middle" fill="#991b1b" font-size="9">Evidence suppression</text>
  <text x="145" y="567" text-anchor="middle" fill="#991b1b" font-size="9">Undervaluation flags</text>
  <text x="145" y="582" text-anchor="middle" fill="#dc2626" font-size="9" font-weight="bold">→ Risk Score 0-100</text>
  <text x="145" y="593" text-anchor="middle" fill="#dc2626" font-size="8">→ Attorney Referral Flag</text>

  <!-- Agent 2 -->
  <rect x="245" y="468" width="170" height="130" rx="6" fill="#eff6ff" stroke="#3b82f6" stroke-width="1.5"/>
  <text x="330" y="490" text-anchor="middle" fill="#3b82f6" font-size="11" font-weight="bold">Claims</text>
  <text x="330" y="505" text-anchor="middle" fill="#3b82f6" font-size="11" font-weight="bold">Analysis</text>
  <line x1="255" y1="512" x2="405" y2="512" stroke="#bfdbfe" stroke-width="1"/>
  <text x="330" y="528" text-anchor="middle" fill="#1e40af" font-size="9">Multi-mode analysis</text>
  <text x="330" y="541" text-anchor="middle" fill="#1e40af" font-size="9">damage|coverage|risk</text>
  <text x="330" y="554" text-anchor="middle" fill="#1e40af" font-size="9">Weighted composite:</text>
  <text x="330" y="567" text-anchor="middle" fill="#1e40af" font-size="9">Damage 50% + Coverage</text>
  <text x="330" y="580" text-anchor="middle" fill="#1e40af" font-size="9">30% + Litigation 20%</text>
  <text x="330" y="593" text-anchor="middle" fill="#3b82f6" font-size="8" font-weight="bold">→ Photo Analysis Integration</text>

  <!-- Agent 3 -->
  <rect x="430" y="468" width="170" height="130" rx="6" fill="#f5f3ff" stroke="#7c3aed" stroke-width="1.5"/>
  <text x="515" y="490" text-anchor="middle" fill="#7c3aed" font-size="11" font-weight="bold">Rebuttal</text>
  <text x="515" y="505" text-anchor="middle" fill="#7c3aed" font-size="11" font-weight="bold">Builder</text>
  <line x1="440" y1="512" x2="590" y2="512" stroke="#ddd6fe" stroke-width="1"/>
  <text x="515" y="528" text-anchor="middle" fill="#5b21b6" font-size="9">GPT-4o letter generation</text>
  <text x="515" y="541" text-anchor="middle" fill="#5b21b6" font-size="9">Carrier-aware tone</text>
  <text x="515" y="554" text-anchor="middle" fill="#5b21b6" font-size="9">9 required sections</text>
  <text x="515" y="567" text-anchor="middle" fill="#5b21b6" font-size="9">Code citations enforced</text>
  <text x="515" y="580" text-anchor="middle" fill="#5b21b6" font-size="9">Weather fact citation</text>
  <text x="515" y="593" text-anchor="middle" fill="#7c3aed" font-size="8" font-weight="bold">→ Token Ledger Integration</text>

  <!-- Agent 4 -->
  <rect x="615" y="468" width="170" height="130" rx="6" fill="#f0fdf4" stroke="#059669" stroke-width="1.5"/>
  <text x="700" y="490" text-anchor="middle" fill="#059669" font-size="11" font-weight="bold">Report</text>
  <text x="700" y="505" text-anchor="middle" fill="#059669" font-size="11" font-weight="bold">Assembly</text>
  <line x1="625" y1="512" x2="775" y2="512" stroke="#bbf7d0" stroke-width="1"/>
  <text x="700" y="528" text-anchor="middle" fill="#065f46" font-size="9">10-section compilation</text>
  <text x="700" y="541" text-anchor="middle" fill="#065f46" font-size="9">Cross-section aggregation</text>
  <text x="700" y="554" text-anchor="middle" fill="#065f46" font-size="9">PDF/HTML output</text>
  <text x="700" y="567" text-anchor="middle" fill="#065f46" font-size="9">Branded templates</text>
  <text x="700" y="580" text-anchor="middle" fill="#065f46" font-size="9">Version tracking</text>
  <text x="700" y="593" text-anchor="middle" fill="#059669" font-size="8" font-weight="bold">→ FileAsset Storage</text>

  <!-- Agent 5 -->
  <rect x="800" y="468" width="170" height="130" rx="6" fill="#fefce8" stroke="#d97706" stroke-width="1.5"/>
  <text x="885" y="490" text-anchor="middle" fill="#d97706" font-size="11" font-weight="bold">Security</text>
  <text x="885" y="505" text-anchor="middle" fill="#d97706" font-size="11" font-weight="bold">Audit</text>
  <line x1="810" y1="512" x2="960" y2="512" stroke="#fef08a" stroke-width="1"/>
  <text x="885" y="528" text-anchor="middle" fill="#92400e" font-size="9">Activity log analysis</text>
  <text x="885" y="541" text-anchor="middle" fill="#92400e" font-size="9">Anomaly detection</text>
  <text x="885" y="554" text-anchor="middle" fill="#92400e" font-size="9">Failed login tracking</text>
  <text x="885" y="567" text-anchor="middle" fill="#92400e" font-size="9">API token abuse</text>
  <text x="885" y="580" text-anchor="middle" fill="#92400e" font-size="9">High-velocity detection</text>
  <text x="885" y="593" text-anchor="middle" fill="#d97706" font-size="8" font-weight="bold">→ Scoring Heuristic</text>

  <!-- Agent 6 -->
  <rect x="985" y="468" width="160" height="130" rx="6" fill="#fdf2f8" stroke="#db2777" stroke-width="1.5"/>
  <text x="1065" y="490" text-anchor="middle" fill="#db2777" font-size="11" font-weight="bold">Token</text>
  <text x="1065" y="505" text-anchor="middle" fill="#db2777" font-size="11" font-weight="bold">Ledger</text>
  <line x1="995" y1="512" x2="1135" y2="512" stroke="#fbcfe8" stroke-width="1"/>
  <text x="1065" y="528" text-anchor="middle" fill="#9d174d" font-size="9">Wallet management</text>
  <text x="1065" y="541" text-anchor="middle" fill="#9d174d" font-size="9">Ledger entry creation</text>
  <text x="1065" y="554" text-anchor="middle" fill="#9d174d" font-size="9">Usage aggregation</text>
  <text x="1065" y="567" text-anchor="middle" fill="#9d174d" font-size="9">Balance reconciliation</text>
  <text x="1065" y="580" text-anchor="middle" fill="#9d174d" font-size="9">Upsert operations</text>
  <text x="1065" y="593" text-anchor="middle" fill="#db2777" font-size="8" font-weight="bold">→ Append-Only Ledger</text>

  <!-- Mission Flow -->
  <rect x="40" y="625" width="1120" height="60" rx="8" fill="#1e293b" filter="url(#shadow)"/>
  <text x="60" y="650" fill="#67e8f9" font-size="13" font-weight="bold">Agent Mission Execution Flow:</text>
  <text x="60" y="672" fill="#e2e8f0" font-size="11">Trigger → agent_mission (PENDING) → agent_tasks[] → Execute with Retry/Backoff → Approval Gate (if required) → COMPLETE → Notifications</text>

  <!-- Learning Loop -->
  <rect x="40" y="700" width="1120" height="130" rx="8" fill="white" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
  <text x="60" y="728" fill="#059669" font-size="14" font-weight="bold">Continuous Learning Loop (6-Step Closed Cycle)</text>

  <rect x="60" y="740" width="150" height="35" rx="4" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
  <text x="135" y="762" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">1. Log Action</text>

  <line x1="210" y1="757" x2="240" y2="757" stroke="#059669" stroke-width="1.5" marker-end="url(#arrow)"/>

  <rect x="240" y="740" width="150" height="35" rx="4" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
  <text x="315" y="762" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">2. Wait for Result</text>

  <line x1="390" y1="757" x2="420" y2="757" stroke="#059669" stroke-width="1.5" marker-end="url(#arrow)"/>

  <rect x="420" y="740" width="150" height="35" rx="4" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
  <text x="495" y="762" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">3. Log Outcome</text>

  <line x1="570" y1="757" x2="600" y2="757" stroke="#059669" stroke-width="1.5" marker-end="url(#arrow)"/>

  <rect x="600" y="740" width="160" height="35" rx="4" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
  <text x="680" y="762" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">4. Analyze Pattern</text>

  <line x1="760" y1="757" x2="790" y2="757" stroke="#059669" stroke-width="1.5" marker-end="url(#arrow)"/>

  <rect x="790" y="740" width="160" height="35" rx="4" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
  <text x="870" y="762" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">5. Improve Agents</text>

  <line x1="950" y1="757" x2="980" y2="757" stroke="#059669" stroke-width="1.5" marker-end="url(#arrow)"/>

  <rect x="980" y="740" width="150" height="35" rx="4" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
  <text x="1055" y="762" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">6. Repeat ↻</text>

  <!-- Cycle arrow back -->
  <path d="M 1055 775 L 1055 800 L 135 800 L 135 775" fill="none" stroke="#059669" stroke-width="1.5" marker-end="url(#arrow)" stroke-dasharray="6,3"/>

  <text x="600" y="823" text-anchor="middle" fill="#64748b" font-size="10">Human edits tracked via learnPreferences.ts → Carrier-specific patterns → Fine-tuning data generation</text>

  <text x="600" y="843" text-anchor="middle" fill="#475569" font-size="10">SkaiScraper — ClearSkai Technologies LLC — Provisional Patent Reference — February 2026</text>
</svg>
