<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 820" font-family="Arial, Helvetica, sans-serif">
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#64748b"/>
    </marker>
    <filter id="shadow" x="-3%" y="-3%" width="106%" height="106%">
      <feDropShadow dx="1" dy="1" stdDeviation="2" flood-opacity="0.1"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="1200" height="820" fill="#f0fdf4" rx="8"/>

  <!-- Title -->
  <rect x="0" y="0" width="1200" height="55" fill="#065f46" rx="0"/>
  <text x="600" y="35" text-anchor="middle" fill="white" font-size="20" font-weight="bold">Fig. 6 — Report Generation &amp; PDF Export Pipeline (Patent Reference)</text>
  <text x="1180" y="35" text-anchor="end" fill="#6ee7b7" font-size="10">ClearSkai Technologies LLC © 2026</text>

  <!-- ======== Stage 1: Data Collection ======== -->
  <text x="60" y="82" fill="#065f46" font-size="14" font-weight="bold">STAGE 1 — Data Collection &amp; Aggregation</text>

  <rect x="60" y="92" width="160" height="90" rx="8" fill="white" stroke="#3b82f6" stroke-width="2" filter="url(#shadow)"/>
  <text x="140" y="115" text-anchor="middle" fill="#3b82f6" font-size="11" font-weight="bold">Claim Data</text>
  <text x="140" y="133" text-anchor="middle" fill="#1e40af" font-size="9">Property details</text>
  <text x="140" y="147" text-anchor="middle" fill="#1e40af" font-size="9">Policy info</text>
  <text x="140" y="161" text-anchor="middle" fill="#1e40af" font-size="9">Carrier info</text>
  <text x="140" y="175" text-anchor="middle" fill="#64748b" font-size="8">Prisma: Claim model</text>

  <rect x="240" y="92" width="160" height="90" rx="8" fill="white" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
  <text x="320" y="115" text-anchor="middle" fill="#059669" font-size="11" font-weight="bold">Weather Data</text>
  <text x="320" y="133" text-anchor="middle" fill="#065f46" font-size="9">5-provider cascade</text>
  <text x="320" y="147" text-anchor="middle" fill="#065f46" font-size="9">Hail/wind/precip</text>
  <text x="320" y="161" text-anchor="middle" fill="#065f46" font-size="9">Severity scores</text>
  <text x="320" y="175" text-anchor="middle" fill="#64748b" font-size="8">WeatherVerification</text>

  <rect x="420" y="92" width="160" height="90" rx="8" fill="white" stroke="#d97706" stroke-width="2" filter="url(#shadow)"/>
  <text x="500" y="115" text-anchor="middle" fill="#d97706" font-size="11" font-weight="bold">Vision Analysis</text>
  <text x="500" y="133" text-anchor="middle" fill="#92400e" font-size="9">GPT-4o damage detect</text>
  <text x="500" y="147" text-anchor="middle" fill="#92400e" font-size="9">Damage reports[]</text>
  <text x="500" y="161" text-anchor="middle" fill="#92400e" font-size="9">Severity + captions</text>
  <text x="500" y="175" text-anchor="middle" fill="#64748b" font-size="8">analyzeUpload()</text>

  <rect x="600" y="92" width="160" height="90" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="680" y="115" text-anchor="middle" fill="#dc2626" font-size="11" font-weight="bold">Bad Faith Score</text>
  <text x="680" y="133" text-anchor="middle" fill="#991b1b" font-size="9">BadFaith agent result</text>
  <text x="680" y="147" text-anchor="middle" fill="#991b1b" font-size="9">Risk 0-100</text>
  <text x="680" y="161" text-anchor="middle" fill="#991b1b" font-size="9">Indicators list</text>
  <text x="680" y="175" text-anchor="middle" fill="#64748b" font-size="8">bad_faith_analysis</text>

  <rect x="780" y="92" width="160" height="90" rx="8" fill="white" stroke="#8b5cf6" stroke-width="2" filter="url(#shadow)"/>
  <text x="860" y="115" text-anchor="middle" fill="#8b5cf6" font-size="11" font-weight="bold">Similar Claims</text>
  <text x="860" y="133" text-anchor="middle" fill="#5b21b6" font-size="9">Vector similarity</text>
  <text x="860" y="147" text-anchor="middle" fill="#5b21b6" font-size="9">Historical outcomes</text>
  <text x="860" y="161" text-anchor="middle" fill="#5b21b6" font-size="9">Win rate stats</text>
  <text x="860" y="175" text-anchor="middle" fill="#64748b" font-size="8">querySimilarClaims()</text>

  <rect x="960" y="92" width="180" height="90" rx="8" fill="white" stroke="#db2777" stroke-width="2" filter="url(#shadow)"/>
  <text x="1050" y="115" text-anchor="middle" fill="#db2777" font-size="11" font-weight="bold">Carrier Compliance</text>
  <text x="1050" y="133" text-anchor="middle" fill="#9d174d" font-size="9">Carrier-specific rules</text>
  <text x="1050" y="147" text-anchor="middle" fill="#9d174d" font-size="9">Compliance checklist</text>
  <text x="1050" y="161" text-anchor="middle" fill="#9d174d" font-size="9">Required documents</text>
  <text x="1050" y="175" text-anchor="middle" fill="#64748b" font-size="8">carrierLookup()</text>

  <!-- Arrows down -->
  <line x1="140" y1="182" x2="140" y2="205" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="320" y1="182" x2="320" y2="205" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="500" y1="182" x2="500" y2="205" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="680" y1="182" x2="680" y2="205" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="860" y1="182" x2="860" y2="205" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="1050" y1="182" x2="1050" y2="205" stroke="#64748b" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- ======== Stage 2: Report Orchestrator ======== -->
  <rect x="60" y="210" width="1080" height="75" rx="8" fill="#065f46" filter="url(#shadow)"/>
  <text x="600" y="236" text-anchor="middle" fill="white" font-size="16" font-weight="bold">Report Assembly Agent — Orchestrator</text>
  <text x="600" y="256" text-anchor="middle" fill="#a7f3d0" font-size="11">assembleReport(claimId) → Collects all 6 data sources → Merges into unified ReportPayload → Applies 10-section template</text>
  <text x="600" y="272" text-anchor="middle" fill="#6ee7b7" font-size="10">Token Ledger debit (-2 to -5 tokens depending on report complexity) + Org branding injection</text>

  <line x1="600" y1="285" x2="600" y2="310" stroke="#065f46" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ======== Stage 3: Section Rendering ======== -->
  <text x="60" y="325" fill="#065f46" font-size="14" font-weight="bold">STAGE 2 — 10-Section Template Rendering</text>

  <rect x="60" y="335" width="1080" height="100" rx="8" fill="white" stroke="#1e293b" stroke-width="2" filter="url(#shadow)"/>

  <!-- Row 1: sections 1-5 -->
  <rect x="80" y="345" width="192" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
  <text x="176" y="367" text-anchor="middle" fill="#1e40af" font-size="10" font-weight="bold">1. Executive Summary</text>

  <rect x="284" y="345" width="192" height="35" rx="4" fill="#dbeafe" stroke="#3b82f6" stroke-width="1"/>
  <text x="380" y="367" text-anchor="middle" fill="#1e40af" font-size="10" font-weight="bold">2. Property Details</text>

  <rect x="488" y="345" width="192" height="35" rx="4" fill="#d1fae5" stroke="#059669" stroke-width="1"/>
  <text x="584" y="367" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">3. Weather Analysis</text>

  <rect x="692" y="345" width="192" height="35" rx="4" fill="#fef3c7" stroke="#d97706" stroke-width="1"/>
  <text x="788" y="367" text-anchor="middle" fill="#92400e" font-size="10" font-weight="bold">4. Damage Assessment</text>

  <rect x="896" y="345" width="222" height="35" rx="4" fill="#fef2f2" stroke="#dc2626" stroke-width="1"/>
  <text x="1007" y="367" text-anchor="middle" fill="#991b1b" font-size="10" font-weight="bold">5. Photo Evidence + Captions</text>

  <!-- Row 2: sections 6-10 -->
  <rect x="80" y="390" width="192" height="35" rx="4" fill="#fdf2f8" stroke="#db2777" stroke-width="1"/>
  <text x="176" y="412" text-anchor="middle" fill="#9d174d" font-size="10" font-weight="bold">6. Bad Faith Indicators</text>

  <rect x="284" y="390" width="192" height="35" rx="4" fill="#f5f3ff" stroke="#8b5cf6" stroke-width="1"/>
  <text x="380" y="412" text-anchor="middle" fill="#5b21b6" font-size="10" font-weight="bold">7. Similar Claims</text>

  <rect x="488" y="390" width="192" height="35" rx="4" fill="#ecfdf5" stroke="#059669" stroke-width="1"/>
  <text x="584" y="412" text-anchor="middle" fill="#065f46" font-size="10" font-weight="bold">8. Carrier Compliance</text>

  <rect x="692" y="390" width="192" height="35" rx="4" fill="#fff7ed" stroke="#ea580c" stroke-width="1"/>
  <text x="788" y="412" text-anchor="middle" fill="#9a3412" font-size="10" font-weight="bold">9. Cost Estimation</text>

  <rect x="896" y="390" width="222" height="35" rx="4" fill="#f0f9ff" stroke="#0ea5e9" stroke-width="1"/>
  <text x="1007" y="412" text-anchor="middle" fill="#0369a1" font-size="10" font-weight="bold">10. Recommendations</text>

  <line x1="600" y1="435" x2="600" y2="458" stroke="#065f46" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- ======== Stage 4: Dual Output ======== -->
  <text x="60" y="472" fill="#065f46" font-size="14" font-weight="bold">STAGE 3 — Dual Output Generation</text>

  <!-- HTML Path -->
  <rect x="60" y="482" width="520" height="120" rx="8" fill="white" stroke="#0ea5e9" stroke-width="2" filter="url(#shadow)"/>
  <text x="320" y="505" text-anchor="middle" fill="#0ea5e9" font-size="14" font-weight="bold">HTML Report (Interactive)</text>
  <line x1="70" y1="512" x2="570" y2="512" stroke="#e0f2fe" stroke-width="1"/>
  <text x="320" y="530" text-anchor="middle" fill="#0369a1" font-size="10">React server component rendering</text>
  <text x="320" y="546" text-anchor="middle" fill="#0369a1" font-size="10">Org branding: logo, colors, header/footer from organization_branding</text>
  <text x="320" y="562" text-anchor="middle" fill="#0369a1" font-size="10">Interactive photo gallery with annotations</text>
  <text x="320" y="578" text-anchor="middle" fill="#0369a1" font-size="10">Expandable sections, severity charts, recommendation actions</text>
  <text x="320" y="594" text-anchor="middle" fill="#0369a1" font-size="9">Viewable at: /claims/{id}/report (role-gated access)</text>

  <!-- PDF Path -->
  <rect x="620" y="482" width="520" height="120" rx="8" fill="white" stroke="#dc2626" stroke-width="2" filter="url(#shadow)"/>
  <text x="880" y="505" text-anchor="middle" fill="#dc2626" font-size="14" font-weight="bold">PDF Export (Downloadable)</text>
  <line x1="630" y1="512" x2="1130" y2="512" stroke="#fecaca" stroke-width="1"/>
  <text x="880" y="530" text-anchor="middle" fill="#991b1b" font-size="10">@react-pdf/renderer → Server-side PDF generation</text>
  <text x="880" y="546" text-anchor="middle" fill="#991b1b" font-size="10">Custom PdfDocument component with styled sections</text>
  <text x="880" y="562" text-anchor="middle" fill="#991b1b" font-size="10">Inline photo thumbnails with damage annotations</text>
  <text x="880" y="578" text-anchor="middle" fill="#991b1b" font-size="10">Auto-generated Table of Contents + page numbering</text>
  <text x="880" y="594" text-anchor="middle" fill="#991b1b" font-size="9">API: POST /api/reports/{id}/pdf → streams application/pdf</text>

  <!-- Arrows to storage -->
  <line x1="320" y1="602" x2="320" y2="640" stroke="#0ea5e9" stroke-width="1.5" marker-end="url(#arrow)"/>
  <line x1="880" y1="602" x2="880" y2="640" stroke="#dc2626" stroke-width="1.5" marker-end="url(#arrow)"/>

  <!-- ======== Stage 5: Storage & Distribution ======== -->
  <text x="60" y="655" fill="#065f46" font-size="14" font-weight="bold">STAGE 4 — Storage &amp; Versioned Distribution</text>

  <!-- FileAsset -->
  <rect x="60" y="665" width="350" height="105" rx="8" fill="white" stroke="#1e293b" stroke-width="2" filter="url(#shadow)"/>
  <text x="235" y="688" text-anchor="middle" fill="#1e293b" font-size="13" font-weight="bold">FileAsset (Prisma Model)</text>
  <line x1="70" y1="695" x2="400" y2="695" stroke="#e2e8f0" stroke-width="1"/>
  <text x="235" y="712" text-anchor="middle" fill="#475569" font-size="10">id, claimId, type=REPORT_PDF, version</text>
  <text x="235" y="728" text-anchor="middle" fill="#475569" font-size="10">storageKey → Cloudflare R2 object path</text>
  <text x="235" y="744" text-anchor="middle" fill="#475569" font-size="10">mimeType, sizeBytes, uploadedBy, createdAt</text>
  <text x="235" y="760" text-anchor="middle" fill="#059669" font-size="10" font-weight="bold">Versioned: v1, v2, v3… per claim</text>

  <!-- Signed URL Privacy -->
  <rect x="440" y="665" width="330" height="105" rx="8" fill="white" stroke="#7c3aed" stroke-width="2" filter="url(#shadow)"/>
  <text x="605" y="688" text-anchor="middle" fill="#7c3aed" font-size="13" font-weight="bold">Signed URL Privacy Pattern</text>
  <line x1="450" y1="695" x2="760" y2="695" stroke="#ede9fe" stroke-width="1"/>
  <text x="605" y="712" text-anchor="middle" fill="#5b21b6" font-size="10">R2 bucket: PRIVATE (no public access)</text>
  <text x="605" y="728" text-anchor="middle" fill="#5b21b6" font-size="10">getSignedUrl(storageKey, 15min TTL)</text>
  <text x="605" y="744" text-anchor="middle" fill="#5b21b6" font-size="10">URL contains HMAC signature → expires</text>
  <text x="605" y="760" text-anchor="middle" fill="#5b21b6" font-size="10">Every download = new signed URL generated</text>

  <!-- Report History -->
  <rect x="800" y="665" width="340" height="105" rx="8" fill="white" stroke="#059669" stroke-width="2" filter="url(#shadow)"/>
  <text x="970" y="688" text-anchor="middle" fill="#059669" font-size="13" font-weight="bold">Report Version History</text>
  <line x1="810" y1="695" x2="1130" y2="695" stroke="#d1fae5" stroke-width="1"/>
  <text x="970" y="712" text-anchor="middle" fill="#065f46" font-size="10">report_history table: claimId + version</text>
  <text x="970" y="728" text-anchor="middle" fill="#065f46" font-size="10">Diff tracking: what changed between versions</text>
  <text x="970" y="744" text-anchor="middle" fill="#065f46" font-size="10">Generated by userId at timestamp</text>
  <text x="970" y="760" text-anchor="middle" fill="#065f46" font-size="10">Client portal: access latest version only</text>

  <!-- Distribution -->
  <rect x="60" y="780" width="1080" height="30" rx="6" fill="#065f46"/>
  <text x="600" y="800" text-anchor="middle" fill="white" font-size="11" font-weight="bold">Distribution: In-App Viewer (React) | Direct Download (signed PDF URL) | Email Attachment (SendGrid) | Client Portal (latest version, read-only)</text>

  <text x="600" y="818" text-anchor="middle" fill="#475569" font-size="10">SkaiScraper — ClearSkai Technologies LLC — Provisional Patent Reference — February 2026</text>
</svg>
