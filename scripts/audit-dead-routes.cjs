#!/usr/bin/env node
// Dead API route audit script â€” verify routes have zero references
const { execSync } = require("child_process");
const fs = require("fs");
const path = require("path");

const routes = [
  "activity",
  "activity/list",
  "ai/annotations",
  "ai/code-compliance",
  "ai/inspect",
  "ai/product-context",
  "ai/router",
  "ai/run",
  "ai/skills",
  "ai/status",
  "ai/usage",
  "ai/vision/selftest",
  "auth/fix-identity",
  "auth/identity",
  "auth/sync-identity",
  "auth/whoami",
  "retail/items",
  "retail/save",
  "retail/start",
  "connections/connect",
  "connections/my",
  "connections/revoke",
  "connections/search",
  "connections/thread",
  "chat/conversations",
  "chat/messages",
  "chat/read",
  "ask-dominus",
  "bootstrap",
  "build-verify",
  "bulk-actions",
  "deploy-info",
  "dol-check",
  "dol-pull",
  "generate-mockup",
  "generate-test-docx",
  "import-export",
  "mortgage-checks",
  "queue/echo",
  "realtime",
  "routes-manifest",
  "storm-center",
  "subscribe",
  "uploadthing",
  "workspace/init",
  "admin/force-open",
  "admin/launch-status",
  "admin/purge-cache",
  "admin/report-metrics",
  "admin/revalidate",
  "admin/seed-mandatory-template",
  "branding/setup",
  "branding/status",
  "branding/upsert",
  "flags/export",
  "flags/import",
  "flags/list",
  "flags/metrics",
  "search/clients",
  "search/global",
  "search/pros",
  "storage/quota",
  "storage/signed-read",
  "storage/signed-upload",
  "vendors/pricing",
  "vendors/products",
  "vendors/search",
  "reports/actions",
  "reports/compose",
  "reports/export",
  "onboarding/complete",
  "onboarding/init",
  "onboarding/status",
  "network/feed",
  "network/groups",
  "network/integrate",
  "network/trending-pros",
  "notifications/email",
  "notifications/push",
  "notifications/sms",
  "portal/design-board",
  "portal/join",
  "portal/resolve-token",
  "analytics/claims-status",
  "analytics/claims-timeline",
  "analytics/lead-sources",
  "billing/full-access/checkout",
  "billing/full-access/status",
  "billing/invoices",
  "billing/status",
  "billing/subscription",
  "templates/duplicate",
  "templates/verify-all",
  "trades/actions",
  "trades/company/actions",
  "trades/connections/actions",
  "trades/profile/actions",
  "claims/client-access",
  "claims/materials",
  "claims/resume",
  "claims/state",
  "claims/weather/auto",
  "approvals/request",
  "approvals/respond",
  "calendar/events",
  "carrier/export/zip",
  "carriers/presets",
  "claim-approvals",
  "client/auth/request",
  "client-messages/send",
  "client-messages/thread",
  "client-notifications/create",
  "client-profile",
  "community/map",
  "community-reports/purchase",
  "contractor-packet",
  "crews",
  "dashboard/metrics",
  "diag/identity",
  "diagnostics/routes",
  "email/subscribe",
  "enterprise/metrics",
  "exports/queue",
  "files",
  "follow/company",
  "follow/trade",
  "generate-pdf",
  "geocode",
  "intel/super-packet",
  "intelligence/generate",
  "jobs/status",
  "jobs/stream",
  "leads/map-snapshot",
  "materials/orders",
  "me/init",
  "me/notifications",
  "measurements/order",
  "messages/conversations",
  "messages/post-update",
  "migrations/jobnimbus",
  "notify/send",
  "ocr/image",
  "ocr/pdf",
  "org/active",
  "org/repair",
  "payments/create-link",
  "pilot/feedback",
  "presence/heartbeat",
  "profile/me",
  "project/materials/add",
  "proposals/run",
  "qr/generate",
  "quota/status",
  "rate-limit/usage",
  "rbac/me",
  "referral/invite",
  "referral/link",
  "referrals/create",
  "routes/optimize",
  "security/isolation-proof",
  "signatures/respond",
  "status",
  "system/truth",
  "team/roles",
  "teams/elevate-manager",
  "telemetry/mockup-complete",
  "telemetry/wizard-complete",
  "upload/headshot",
  "user/notifications",
  "verify/damage",
  "vin/events",
  "vin/programs",
  "weather/analyze",
  "weather/get",
  "wizard/save",
  "workflow/trigger",
  "workflows",
  "ai/assistant",
  "ai/chat",
  "ai/damage/upload",
  "ai/depreciation/export-pdf",
  "ai/proposals/run",
  "ai/recommendations/refresh",
  "ai/supplement/analyze",
  "ai/video/stream",
  "portal/invitations/actions",
  "portal/job-requests/responses",
  "portal/messages/actions",
  "portal/posts/like",
  "public/bootstrap",
  "public/check-claim",
  "public/cleanup",
  "claims-folder/homeowner-statement",
  "batch/generate-per-address-pdfs",
  "audit/log",
  "integrations/quickbooks/receipts",
  "integrations/quickbooks/status",
  "integrations/quickbooks/sync",
  "flags/config",
  "flags/invalidate",
];

const dead = [];
const alive = [];
const skip = [];

for (const r of routes) {
  const filePath = path.join("src/app/api", r, "route.ts");
  if (!fs.existsSync(filePath)) {
    skip.push(r);
    continue;
  }

  try {
    const out = execSync(
      `grep -rn "/api/${r}" src/ lib/ config/ scripts/ --include="*.ts" --include="*.tsx" --include="*.js" 2>/dev/null || true`,
      { encoding: "utf8", maxBuffer: 10 * 1024 * 1024 }
    );
    const lines = out.split("\n").filter((l) => l && !l.includes(`src/app/api/${r}/route.ts`));
    if (lines.length === 0) {
      dead.push(r);
    } else {
      alive.push([r, lines.length]);
    }
  } catch (e) {
    dead.push(r);
  }
}

console.log(`DEAD: ${dead.length} | ALIVE: ${alive.length} | SKIP: ${skip.length}`);
console.log("\n=== CONFIRMED DEAD ===");
dead.forEach((r) => console.log(`  /api/${r}`));
console.log("\n=== STILL ALIVE (has refs) ===");
alive.forEach(([r, c]) => console.log(`  /api/${r} (${c} refs)`));
console.log("\n=== SKIPPED (no file) ===");
skip.forEach((r) => console.log(`  /api/${r}`));

// Write dead routes to file for archive script
fs.writeFileSync("/tmp/dead-routes.json", JSON.stringify(dead, null, 2));
console.log(`\nWrote ${dead.length} dead routes to /tmp/dead-routes.json`);
