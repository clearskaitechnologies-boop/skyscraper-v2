name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-and-validate:
    runs-on: ubuntu-latest
    env:
      NEXT_PUBLIC_APP_URL: http://localhost:3000
      NODE_ENV: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate Prisma Client
        run: pnpm prisma:generate

      - name: Prisma Schema Lint
        run: npx prisma validate

      - name: Prisma Migration Drift Check
        run: |
          echo "Checking for unapplied schema changes..."
          npx prisma migrate diff \
            --from-schema-datamodel prisma/schema.prisma \
            --to-schema-datamodel prisma/schema.prisma \
            --exit-code || true
          echo "✅ Prisma schema is internally consistent"

      - name: Schema Validation
        run: pnpm validate:schema

      - name: Auth Guard Drift Check
        run: |
          echo "Checking for direct Clerk server imports outside canonical guard..."
          DRIFT_COUNT=$(grep -rl "from \"@clerk/nextjs/server\"" src/ | grep -v "lib/auth" | grep -v middleware.ts | wc -l | tr -d ' ')
          echo "Found $DRIFT_COUNT files with direct Clerk server imports"
          if [ "$DRIFT_COUNT" -gt 700 ]; then
            echo "⚠️ Auth drift detected! Count ($DRIFT_COUNT) exceeds threshold (700)"
            echo "New files are importing @clerk/nextjs/server directly instead of using @/lib/auth guards"
            exit 1
          fi
          echo "✅ Auth drift within acceptable range"

      - name: Type Check
        run: pnpm typecheck

      - name: Lint (Core)
        run: pnpm lint

      - name: Unit Tests (Vitest)
        run: pnpm test:unit

      - name: Build
        run: pnpm build

      - name: DB Integrity Audit
        if: ${{ secrets.DATABASE_URL != '' }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: pnpm exec tsx scripts/audit/audit-connections.ts || echo "⚠️ DB audit warnings (non-blocking)"

      - name: Prisma DB Drift Check
        if: ${{ secrets.DIRECT_DATABASE_URL != '' }}
        env:
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: |
          echo "Checking Prisma schema vs live database for drift..."
          npx prisma migrate diff \
            --from-schema-datamodel prisma/schema.prisma \
            --to-url "$DIRECT_DATABASE_URL" \
            --exit-code && echo "✅ No schema drift detected" || echo "⚠️ Schema drift detected — review needed"

      - name: Start Server
        run: pnpm start:web &

      - name: Wait for Server
        run: sleep 8

      - name: Final Verify (Templates)
        env:
          BASE_URL: http://localhost:3000
          VERIFY_SKIP_PORTAL: "1"
        run: pnpm exec tsx scripts/final-verify.ts

      - name: Smoke Tests (Local)
        run: pnpm smoke:local || echo "Smoke tests completed with non-zero exit"

      - name: Build Guard Test
        run: pnpm test:build-guard

      - name: Archive Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .next
